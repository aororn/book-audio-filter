# Отчёт по экспериментам с фильтрами

**Дата:** 2026-01-30
**Версия проекта:** 12.0.0
**Текущий порог ML:** 90%

---

## Эксперимент 1: Снижение порога ML-классификатора

### Методика
Тестировали пороги: 85%, 80%, 75%, 70%
Проверяли: сколько дополнительных FP отфильтруется и не затронет ли это golden.

### Предварительные результаты (симуляция)

| Порог | Доп. FP | Golden затронуто | Статус |
|-------|---------|------------------|--------|
| 90% (текущий) | — | 0 | Базовый |
| 85% | +104 | 0 | ✓ Казалось безопасно |
| 80% | +192 | 0 | ✓ Казалось безопасно |
| 75% | +258 | 0 | ✓ Казалось безопасно |
| 70% | +306 | 0 | ✓ Казалось безопасно |

### Реальный тест с порогом 85%

**РЕЗУЛЬТАТ: ПРОВАЛ**

При применении порога 85% и запуске полного пайплайна (`--clean`):
- Golden тест: **30/31** в главе 1 (потеряна 1 ошибка)
- Отфильтрованная ошибка: `услышав → услышал` (55:25)
- Уверенность ML: **86.1%** (между 85% и 90%)

```
услышав → услышал: is_fp=True, confidence=86.1%
⚠ GOLDEN ОШИБКА ОТФИЛЬТРОВАНА!
```

**Причина ложного срабатывания:** ML классификатор считает, что деепричастие/глагол — это одна и та же форма слова. Но это РЕАЛЬНАЯ ошибка чтеца (сказал "услышал" вместо "услышав").

### Вывод
**РЕКОМЕНДАЦИЯ: ОСТАВИТЬ ПОРОГ 90%**

- Симуляция на файлах сравнения не показала проблему
- Реальный тест на полном пайплайне выявил потерю golden
- Порог 90% — консервативный и безопасный

---

## Эксперимент 2: Порядок фильтров (ML vs morpho)

### Гипотеза
Если запустить ML раньше morpho_rules, увеличится ли фильтрация?

### Результаты

| Категория | Количество |
|-----------|------------|
| Только morpho | 61 |
| Только ML (85%) | 326 |
| Перекрытие (оба) | 68 |
| Ни один | 296 |

### Анализ

```
ML фильтрует 326 ошибок, которые morpho пропускает
Перекрытие: 68 ошибок — порядок не важен

Текущий порядок:
1. morpho → отфильтрует 61 + 68 = 129
2. ML → отфильтрует ещё 326

Альтернативный порядок (ML первым):
1. ML → отфильтрует 326 + 68 = 394
2. morpho → отфильтрует ещё 61
```

### Вывод
**Изменение порядка НЕ НУЖНО**

- Общий результат одинаков: 129 + 326 = 455
- ML уже работает на ошибках, которые morpho пропускает
- Текущий порядок логичен: сначала быстрые правила, потом тяжёлый ML

---

## Итоговые результаты

### 1. Порог ML: оставить 90% ✅

Эксперимент со снижением до 85% **провалился**:
- Потеряна golden ошибка `услышав → услышал`
- Симуляция не выявила проблему, реальный тест — выявил
- **Урок:** всегда тестировать на полном пайплайне

### 2. Порядок фильтров: оставить как есть ✅

Текущий порядок оптимален:
1. Защитные слои (HARD_NEGATIVES, SemanticManager)
2. Быстрые правила (morpho, phonetic, alignment)
3. ML-классификатор (тяжёлый, но точный)

### 3. SmartFilter: оставить отключённым ✅

Все FP имеют score > 70 (grammar_change), SmartFilter не добавляет ценности.

---

## Финальная проверка

После отката порога ML на 90%:
```bash
python Тесты/run_full_test.py --clean
```

**Результат:**
- Golden: **93/93 (100%)** ✓
- Ошибок на выходе: 266 (было 252 до экспериментов)

---

## Ключевой вывод

**Симуляция ≠ Реальный тест**

Эксперимент с симуляцией показал "0 golden затронуто" для порога 85%, но реальный запуск пайплайна выявил потерю golden ошибки.

Причина: симуляция работала на уже отфильтрованных файлах (`*_compared.json`), а реальный тест генерировал файлы заново с новым порогом.

**Правило:** Всегда проверять изменения через `run_full_test.py --clean`.

---

*Отчёт обновлён после реального тестирования. Версия: v1.1*
