# План итеративного улучшения фильтрации v12

**Цель:** Уменьшить FP с 260 до ≤180 без потери Golden (93/93)
**Принципы:**
- Golden = эталон, не костыли
- Только движение вперёд, без откатов
- Каждая итерация = тест + анализ + решение

---

## Текущее состояние

| Метрика | Значение |
|---------|----------|
| Golden | 93/93 (100%) |
| FP всего | 769 |
| FP отфильтровано | 556 (72.3%) |
| **FP не отфильтровано** | **213 (27.7%)** |

### Распределение нефильтруемых FP (213 шт)

| Категория | Кол-во | Описание |
|-----------|--------|----------|
| substitution | 165 | Замены слов |
| insertion | 29 | Лишние слова |
| deletion | 18 | Пропущенные слова |
| transposition | 1 | Перестановки |

### Детализация substitution (165 шт)

| # | Признаки | Кол-во | Стратегия |
|---|----------|--------|-----------|
| 1 | same_lemma + sem>0.5 | 46 | Фильтр по комбинации морфология+семантика |
| 2 | same_lemma + sem≤0.5 | 28 | Анализ грамматических категорий |
| 3 | diff_lemma + sem>0.5 | 9 | Осторожно — могут быть реальные оговорки |
| 4 | diff_lemma + sem=0 | 35 | Имена/термины → расширение словарей |
| 5 | diff_lemma + 0<sem≤0.5 | 47 | Фонетическое сходство, Левенштейн |

---

## Этап 1: Расширение словарей (ожидаемый эффект: -20 FP)

**Цель:** Покрыть категорию 4 (diff_lemma + sem=0) — имена и термины

### 1.1 Анализ
```bash
python3 -c "..." # Вывести все 35 пар категории 4
```

### 1.2 Действия
- [ ] Добавить в YANDEX_TYPICAL_ERRORS пары типа `контуру/комтуру` (уже через леммы)
- [ ] Добавить в YANDEX_NAME_ERRORS имена: `мурлан/морлан`, `рагидон/рагедон`
- [ ] Проверить CHARACTER_NAMES для новых имён

### 1.3 Проверка
```bash
python3 Тесты/run_full_test.py --clean
```

### 1.4 Критерий успеха
- Golden: 93/93 ✓
- FP: ≤240

---

## Этап 2: Фильтр same_lemma + high_semantic (ожидаемый эффект: -30 FP)

**Цель:** Покрыть категорию 1 (same_lemma + sem>0.5) — падежные формы

### 2.1 Гипотеза
Если слова имеют **одинаковую лемму** И **высокое семантическое сходство (>0.5)** И **одинаковый POS**, то это ложная ошибка Яндекса.

### 2.2 Проверка гипотезы на Golden
```python
# Сколько Golden попадает под этот критерий?
golden_match = [p for p in golden
                if p['same_lemma'] == 1
                and p['semantic_similarity'] > 0.5
                and p['pos1'] == p['pos2']]
```

### 2.3 Реализация (если гипотеза верна)
Добавить в `engine.py` новый уровень фильтрации:
```python
# УРОВЕНЬ X: same_lemma + high_semantic + same_POS
if same_lemma and semantic_similarity > 0.5 and pos1 == pos2:
    return True, 'same_lemma_semantic'
```

### 2.4 Критерий успеха
- Golden: 93/93 ✓
- FP: ≤210

---

## Этап 3: Улучшение safe_ending_transition (ожидаемый эффект: -15 FP)

**Цель:** Расширить паттерны безопасных окончаний на основе данных

### 3.1 Анализ
```python
# Найти все пары окончаний в FP, которых нет в SAFE_ENDING_TRANSITIONS
# Проверить, что ни одна из них не встречается в Golden
```

### 3.2 Действия
- [ ] Добавить новые безопасные переходы окончаний
- [ ] Добавить ограничение: минимальная длина слова = 5

### 3.3 Критерий успеха
- Golden: 93/93 ✓
- FP: ≤195

---

## Этап 4: Фонетический фильтр для diff_lemma (ожидаемый эффект: -20 FP)

**Цель:** Покрыть категорию 5 (diff_lemma + низкая семантика) через фонетику

### 4.1 Гипотеза
Многие FP — это фонетически похожие слова, которые Яндекс путает.
Примеры: `клики/крики`, `лава/глава`, `только/столько`

### 4.2 Реализация
Использовать `sliding_window.py` для фонетического сравнения:
```python
from filters.sliding_window import phonetic_similarity

if phonetic_similarity(wrong, correct) > 0.85:
    # Проверить что нет в Golden
    return True, 'phonetic_match'
```

### 4.3 Критерий успеха
- Golden: 93/93 ✓
- FP: ≤180

---

## Этап 5: Калибровка SmartScorer (ожидаемый эффект: -10 FP)

**Цель:** Оптимизировать веса на основе данных БД

### 5.1 Анализ распределения score
```python
# Построить гистограмму smart_score для Golden vs FP
# Найти оптимальный порог
```

### 5.2 Калибровка весов
- [ ] Увеличить вес `same_form` если подтверждается семантикой
- [ ] Уменьшить штраф `grammar_change` для высокочастотных слов

### 5.3 Критерий успеха
- Golden: 93/93 ✓
- FP: ≤170

---

## Этап 6: Insertion/Deletion фильтры (ожидаемый эффект: -15 FP)

**Цель:** Покрыть 29 insertion + 18 deletion

### 6.1 Анализ insertion
```python
# Какие слова чаще всего являются ложными вставками?
# Проверить пересечение с ALIGNMENT_ARTIFACTS
```

### 6.2 Анализ deletion
```python
# Какие слова чаще всего являются ложными пропусками?
# Связь с выравниванием сегментов
```

### 6.3 Критерий успеха
- Golden: 93/93 ✓
- FP: ≤160

---

## Порядок выполнения

```
Этап 1 (словари)     → Тест → Коммит
     ↓
Этап 2 (same_lemma)  → Тест → Коммит
     ↓
Этап 3 (окончания)   → Тест → Коммит
     ↓
Этап 4 (фонетика)    → Тест → Коммит
     ↓
Этап 5 (SmartScorer) → Тест → Коммит
     ↓
Этап 6 (ins/del)     → Тест → Коммит
```

---

## Правила итераций

1. **Перед каждым изменением:**
   - Проверить гипотезу на данных БД
   - Убедиться что Golden не пострадает

2. **После каждого изменения:**
   - `python3 Тесты/run_full_test.py --clean`
   - Если Golden < 93 → откатить изменение
   - Если Golden = 93 → коммит + обновить БД

3. **Документирование:**
   - Обновить CHANGELOG.md
   - Обновить PROJECT.md (показатели)
   - Записать результат в golden_test_history.json

---

## ОТЛОЖЕНО: Короткие слова (а, и, я, о, у)

**Статус:** Не трогать на текущих этапах

**Причина:** Короткие слова типа `а`, `и`, `я`, `о`, `у` требуют отдельного контекстного фильтра-слоя, который будет разработан позже.

**Что игнорируем:**
- substitution: `а↔и`, `и↔я`, `а↔о` и т.п.
- insertion: лишние `а`, `и`, `я`
- deletion: пропущенные `а`, `и`, `я`

**Будущий фильтр-слой:**
- Анализ контекста (начало предложения, после запятой, между словами)
- Проверка грамматической связности
- Учёт частоты встречи в тексте

**При подсчёте FP:** Эти ошибки пока считаются как нефильтруемые, но не являются целью текущих этапов

---

## Метрики успеха

| Этап | Golden | FP цель | FP факт | Статус |
|------|--------|---------|---------|--------|
| Начало | 93/93 | - | 260 | ✓ |
| Этап 1 | 93/93 | ≤240 | ? | |
| Этап 2 | 93/93 | ≤210 | ? | |
| Этап 3 | 93/93 | ≤195 | ? | |
| Этап 4 | 93/93 | ≤180 | ? | |
| Этап 5 | 93/93 | ≤170 | ? | |
| Этап 6 | 93/93 | ≤160 | ? | |

**Финальная цель:** FP ≤ 160 при Golden = 93/93

---

*Версия плана: 1.0*
*Дата: 2026-01-30*
