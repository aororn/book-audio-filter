# Roadmap — Яндекс Спич

**Версия:** 12.5.0 | **Дата:** 2026-01-30

> Полная история: `Документация/Архив/ROADMAP_FULL.md`

## Текущий статус

| Метрика | Значение |
|---------|----------|
| Golden | **127/127 (100%)** |
| Всего ошибок | **490** (5 глав) |
| ML отфильтровал | **26** |
| SemanticManager защитил | **77** |
| Костылей | **0** |
| Python файлов | **61** |

### Модули v12.5.0

| Модуль | Версия | Статус |
|--------|--------|--------|
| version.py | v1.0 | ACTIVE |
| filters/__init__.py | v8.2 | ACTIVE |
| filters/rules/ | v1.0 | ACTIVE |
| deprecated_filters.py | v1.0 | ARCHIVE |
| smart_compare.py | v10.6 | ACTIVE |
| **engine.py** | **v9.3.2** | **ACTIVE — костыль убран** |
| comparison.py | v6.2 | ACTIVE |
| **ml_classifier.py** | **v1.1** | **ACTIVE — 26 FP отфильтровано** |
| **SemanticManager** | **v2.0** | **ACTIVE — 77 ошибок защищено** |
| SmartScorer | v3.0 | ANALYTICS |
| FrequencyManager | v1.0 | ANALYTICS |
| MorphoRules | v1.2 | ACTIVE |
| false_positives.db | — | **SYNCED — 127 golden** |

---

## Последние изменения

### v12.5.0 (2026-01-30) ✅ — Текущая

**Рефакторинг костыля + аудит фильтров**

- ✅ **Костыль "как то ... там" убран** — обобщён для всех prefix-ов
- ✅ Аудит всех фильтров на наличие хардкодов
- ✅ HARD_NEGATIVES очищен (только имена персонажей)
- ✅ Golden: **127/127 (100%)**

**Результаты:**
- engine.py v9.3.2 (рефакторинг костыля)
- Костылей: **0** (было 1)

### v12.4.0 (2026-01-30) ✅

**Golden тест: 127/127 (100%) — все главы пройдены!**

- ✅ `smart_compare.py` v10.6 — `smart_replace_match()`
- ✅ `engine.py` v9.2.3 — защита ML от грамматических вариаций
- ✅ Golden Гл.5: 34/34

### v12.1.0 (2026-01-30) ✅

**Глубокий аудит фильтров + эксперименты + анализ и/а/я**

- ✅ Создан `filter_analysis.py` — фреймворк тестирования
- ✅ Эксперимент ML 85%: **ПРОВАЛ** — потеряна golden
- ✅ Критичных костылей: **1** (`как то ... там`) — **ИСПРАВЛЕНО в v12.5**
- ✅ Акустический аудит: **НЕ подтвердилась**

### v12.0.0 (2026-01-30) ✅

**ML-классификатор включен + синхронизация БД**

**Фаза 1: Синхронизация данных**
- ✅ Исправлено: `эли→или`, `еще→ещё` в БД
- ✅ Добавлена запись: `и→я` (Гл.3, 29:00)
- ✅ БД синхронизирована: 93 golden = 88 уникальных пар

**Фаза 2: ML-классификатор**
- ✅ Переобучен на исправленных данных
- ✅ CV accuracy: 90.07%
- ✅ Включен в engine.py с порогом 90%
- ✅ Отфильтровал 26 FP без потери golden

**Фаза 3: Верификация**
- ✅ Golden: 93/93 (100%)
- ✅ Критичные пары: `или→и` = REAL (59%), `и→я` = REAL (82%)
- ✅ SemanticManager защитил 77 ошибок от ложной фильтрации

### v11.8.0 (2026-01-30) ✅

**Глубокий аудит и оптимизация архитектуры**

**Фаза 1: Унификация**
- ✅ `levenshtein_distance` унифицирован (populate_db.py, ml_classifier.py)
- ✅ `phonetic_normalize` fallback исправлен в ml_classifier.py
- ✅ filters/__init__.py v8.2 — обновлена документация

**Фаза 2: Архитектурная чистка**
- ✅ deprecated_filters.py v1.0 — архив отключённых фильтров
- ✅ SKIP_SPLIT_FRAGMENT перемещён в constants.py
- ✅ Smart модули документированы (аналитика, не фильтрация)
- ✅ Кэширование морфологии — проверено (morphology.py единый источник)

**Фаза 3: Анализ и тестирование**
- ✅ Анализ 145 FP — выявлены grammar_ending паттерны
- ⚠️ Фильтры grammar_ending отложены (перекрытие с golden)
- ✅ ml_classifier.py — опциональный инструмент
- ✅ Unit-тесты для rules/ — 21 тест, все проходят

### v11.7.2 (2026-01-30) ✅
- **smart_rules.py УДАЛЁН** — 36KB deprecated кода
- Удалены импорты из `smart_compare.py`
- Удалены экспорты из `filters/__init__.py` (v8.1)
- Строк кода: ~28,250 | Python файлов: 59

### v11.7.1 (2026-01-30) ✅
- **Миграция завершена** — inline-код engine.py → rules/ модули
- engine.py v9.1: 5 блоков кода вынесены в rules/

### v11.7.0 (2026-01-30) ✅
- **Модульная архитектура** — создан пакет `filters/rules/`
- **Консолидация** — `phonetic_normalize` в единой точке (comparison.py)
- **Версии** — новый `version.py` как единый источник версий
- Golden: 93/93 ✓ | FP: 154

---

## Планы

### Выполнено ✅
- [x] Удалить неиспользуемый код (learned_rules.py, smart_rules.py)
- [x] Консолидировать phonetic_normalize
- [x] Создать version.py — единый источник версий
- [x] Создать filters/rules/ — модульные правила
- [x] Добавить __all__ в filters/__init__.py
- [x] Миграция inline-кода engine.py → rules/ (v9.1)
- [x] Unit-тесты для rules/ (v11.8.0) — 21 тест
- [x] Глубокий аудит архитектуры (v11.8.0)
- [x] deprecated_filters.py — архив отключённых фильтров
- [x] **Синхронизация БД с Golden файлами** (v12.0.0)
- [x] **ML-классификатор включен** (v12.0.0) — 26 FP отфильтровано
- [x] **SemanticManager активен** (v12.0.0) — 77 ошибок защищено
- [x] **Глубокий аудит фильтров** (v12.1.0) — filter_analysis.py
- [x] **Эксперименты ML/порядок** (v12.1.0) — порог остался 90%
- [x] **Анализ и/а/я ошибок** (v12.1.0) — акустический аудит отклонён
- [x] **Глава 5 добавлена** (v12.2.0) — 34 golden ошибки
- [x] **Golden 127/127** (v12.4.0) — smart_replace_match()
- [x] **Рефакторинг костыля** (v12.5.0) — `как то ... там` обобщён

### Ближайшие
- [ ] FP < 135 (текущий ~180) — требует осторожного подхода
- [ ] Автоматизация синхронизации БД для новых глав

### Будущее
- [ ] Главы 6+
- [ ] CI/CD
- [ ] Интеграция SmartFilter (после анализа эффекта)

---

## Анализ FP (v12.5.0)

**~180 FP из 490 ошибок (5 глав):**
- ML-классификатор отфильтровал 26 FP
- SemanticManager защитил 77 ошибок (оговорки чтеца)
- Оставшиеся FP: grammar_ending, короткие insertion/deletion

**ВАЖНО:** 19+ golden ошибок имеют одинаковую лемму+POS!
Агрессивная фильтрация grammar_ending приведёт к регрессии.

---

*Обновлено: 2026-01-30 (v12.5.0)*
