# Roadmap проекта Яндекс Спич v5.0.0

## Текущий статус: ВЕРСИЯ 5.0 — МОДУЛЬНАЯ АРХИТЕКТУРА

**Результат:** golden_filter разделён на пакет filters/, добавлены ABC-абстракции транскрибации, RateLimiter, requirements.txt/pyproject.toml, 341 unit-тест, все модули v5.0.0.

---

## Выполнено (v5.0.0)

### Модульная архитектура (v5.0.0)
- [x] **Пакет filters/** — golden_filter.py разделён на 4 модуля:
  - `constants.py` — словари омофонов, окончаний, имён, интеръекций
  - `comparison.py` — normalize_word, levenshtein_distance, морфология
  - `detectors.py` — специализированные детекторы ошибок
  - `engine.py` — should_filter_error, filter_errors, filter_report
- [x] **golden_filter.py** — тонкая обёртка-реэкспорт для обратной совместимости
- [x] **TranscriptionProvider (ABC)** — абстрактный интерфейс провайдера транскрибации
- [x] **RateLimiter** — token bucket алгоритм в transcribe.py
- [x] **requirements.txt / pyproject.toml** — управление зависимостями
- [x] **filter_errors.py** — удалён (deprecated с v4.4)
- [x] **341 unit-тест** — 3 новых тестовых файла (pytest)
- [x] **Все модули** — VERSION = '5.0.0', VERSION_DATE = '2026-01-25'

### Проверка главы 2 (v4.6.0)
- [x] Прогнан пайплайн для главы 2 (16 ошибок)
- [x] Создан голден тест для главы 2
- [x] Улучшена фильтрация на ложных ошибках главы 2
- [x] Исправлен web_viewer v3.2:
  - Автоопределение транскрипции (chapter_id "Глава2" → "02")
  - Обогащение контекстов через переводы строк и диалоговые тире
  - Пересчёт marker_pos после обогащения
  - Исправлен битый симлинк аудио
  - Клик на плашку времени

### Система логирования (v3.16.0)
- [x] **LogConfig** — конфигурация логирования в config.py
- [x] **setup_logging()** — настройка с двойным выводом (файл + консоль)
- [x] **get_logger()** — получение логгера по имени модуля
- [x] **cleanup_old_logs()** — ротация старых логов (хранит 10 последних)
- [x] **log_exception()** — логирование исключений с traceback
- [x] **LOGS_DIR** — папка `Темп/logs/` для лог-файлов
- [x] **CLI флаги** — `--verbose`, `--quiet`, `--version` в pipeline.py

### Интеграция с config.py (v3.15.0)
- [x] **Централизованная конфигурация** — все пути и настройки в config.py
- [x] **FileNaming** — унифицированная конвенция именования файлов
- [x] **HAS_CONFIG паттерн** — graceful degradation при отсутствии config.py
- [x] **TEMP_DIR** — единый путь для временных файлов
- [x] **Версионирование** — VERSION/VERSION_DATE во всех модулях
- [x] **CLI флаги** — --force, --version во всех модулях
- [x] **DEPRECATED модули** — text_processor.py, check_transcription.py

### Обновлённые модули
| Модуль | Версия | Статус |
|--------|--------|--------|
| config.py | 5.0.0 | Ядро конфигурации + логирование + пути FileNaming |
| pipeline.py | 5.0.0 | Главный пайплайн + логирование |
| batch_pipeline.py | 5.0.0 | Пакетная обработка |
| transcribe.py | 5.0.0 | Яндекс SpeechKit + RateLimiter |
| transcription_provider.py | 5.0.0 | ABC-интерфейс провайдера транскрибации |
| audio_converter.py | 5.0.0 | Конвертация аудио |
| text_normalizer.py | 5.0.0 | Нормализация текста |
| smart_compare.py | 5.0.0 | Умное сравнение |
| filters/ | 5.0.0 | Модульный пакет фильтрации (4 модуля) |
| golden_filter.py | 5.0.0 | Обёртка-реэкспорт → filters/ |
| web_viewer.py | 5.0.0 | Веб-интерфейс |
| morphology.py | 5.0.0 | Морфологический модуль |
| cache_manager.py | 5.0.0 | Менеджер кэша |
| proper_names_extractor.py | 5.0.0 | Извлечение имён |
| filter_errors.py | — | УДАЛЁН (v5.0.0) |
| text_processor.py | — | УДАЛЁН (v4.7.0) |
| check_transcription.py | — | УДАЛЁН (v4.7.0) |

### Ядро системы
- [x] Базовая транскрибация через Яндекс SpeechKit (transcribe.py)
- [x] Retry-логика с exponential backoff (3 попытки, 1-10 сек)
- [x] Валидация JSON транскрипции (структура, chunks, words)
- [x] Нормализация текста (числа, сокращения, дефисы)

### Умное сравнение v3.0 (smart_compare.py)
- [x] **SequenceMatcher** — оптимальное выравнивание через difflib
- [x] Пропуск метаданных (--phantom) для заставок
- [x] Все substitution — ошибки чтеца
- [x] Схожесть текстов: 94.5%

### Фильтр отсева v3.5 (golden_filter.py)
- [x] Многоуровневая фильтрация:
  - Омофоны (его/ево, что/што, я/и)
  - Грамматические окончания
  - Лемматизация через pymorphy2
  - Типичные ошибки Яндекса (сто/то)
  - Имена и искажённые слова
  - Междометия и артефакты
- [x] Настраиваемые пороги через GoldenFilterConfig
- [x] Автозагрузка словарей из config.py

### Морфологический анализ v2.0 (morphology.py)
- [x] Единый модуль для pymorphy2
- [x] Двухуровневое кэширование:
  - lru_cache в памяти (50,000 слов)
  - SQLite на диске (TEMP_DIR/cache)
- [x] Функции: get_lemma, get_pos, get_number, get_case

### Интерфейсы
- [x] Веб-интерфейс с аудиоплеером (web_viewer.py v3.0)
- [x] HTML-шаблон вынесен в templates/viewer.html
- [x] Кнопки toggle: "Ложная" и "Чтецу"
- [x] Генерация DOCX для чтеца с форматированием
- [x] CLI пайплайн (pipeline.py v2.0)
- [x] Прогресс-бар через tqdm
- [x] Ротация логов (cleanup_old_logs)

### Пакетная обработка v2.0
- [x] batch_pipeline.py — обработка нескольких глав
- [x] Автоматическое сопоставление аудио + текст по имени
- [x] Общий отчёт batch_report.json
- [x] Интеграция с FileNaming

### Тестирование (341 тест)
- [x] Золотой стандарт: test_golden_standard.py
- [x] Unit-тесты: test_golden_filter_unit.py (pytest)
- [x] Тесты пакета filters/: test_filters_package.py (91 тест)
- [x] Тесты морфологии: test_morphology.py (30 тестов)
- [x] Тесты конфигурации: test_config.py (50 тестов)

---

## В работе (v5.1.0 — Оптимизация)

- [ ] **Покрытие тестами smart_compare и pipeline**
  - Довести smart_compare с 34% до 70%+
  - Добавить интеграционные тесты (сквозной тест с MockProvider)
  - Добавить тесты для web_viewer, pipeline, batch_pipeline

- [ ] **Параллельная обработка глав в batch_pipeline.py**
  - concurrent.futures для параллельной обработки независимых глав
  - Прогрев кэша морфологии при старте
  - Контроль размера SQLite-кэша

- [ ] **Линтинг, type hints, mypy**
  - Настроить ruff для проверки стиля кода
  - Расширить type hints на все модули
  - Добавить mypy проверку

- [ ] **Разделение web_viewer.py (~2000 строк)**
  - Выделить Flask-роуты в отдельный модуль
  - Выделить генерацию HTML-контекстов
  - Выделить экспорт DOCX

- [ ] **Конфигурация фильтров через Словари/config.json**
  - Перенести GoldenFilterConfig, SmartCompareConfig в JSON
  - Изменение поведения без редактирования кода

- [ ] **Инфраструктурные улучшения**
  - .gitignore (api_keys.json, Темп/, .coverage)
  - Makefile (make test, make check-chapter-1, make lint)
  - Валидация входных данных (DOCX не пуст, MP3 не повреждён)
  - Режим «только новые главы» (пропуск если filtered свежее исходников)
  - Единый DOCX-отчёт по всей книге для чтеца

### Выполнено ранее

- [x] **Модульная архитектура (v5.0.0)**
  - golden_filter.py → пакет filters/ (4 модуля)
  - ABC-абстракция TranscriptionProvider
  - RateLimiter (token bucket) в transcribe.py
  - requirements.txt / pyproject.toml
  - 341 unit-тест, 3 новых тестовых файла

- [x] **Автоизвлечение имён собственных из DOCX**
  - proper_names_extractor.py v2.0
  - Анализ текста на заглавные буквы
  - Автодобавление в защищённые_слова.txt
  - Интеграция с config.py

- [x] **Type hints в основных модулях**
  - golden_filter.py — полная типизация
  - pipeline.py — базовая типизация

- [x] **Унификация всех модулей с config.py**
  - 14 модулей интегрированы
  - Все модули v5.0.0

---

## Планы на будущее

### Расширение на новые главы
- [ ] Проверка глав 3 и далее
- [ ] Создание золотых стандартов для глав 3–5
- [ ] Автоматизация полного конвейера для всех глав книги
- [ ] Добавление новых паттернов фильтрации при необходимости

### Безопасность API-ключей
- [ ] Перенести ключи в переменные окружения или ~/.config/
- [ ] Убрать api_keys.json и api_key.txt из корня проекта

### Улучшение точности
- [ ] ML-модель для классификации ошибок
- [ ] Обучение на накопленных данных (ложные/реальные)
- [ ] Контекстный анализ соседних слов

### Интеграция
- [ ] Прямая загрузка в Яндекс Object Storage
- [ ] Webhook для автозапуска при появлении файлов
- [ ] API для интеграции с другими системами

### UX
- [ ] Electron/Tauri приложение
- [ ] Автоматический бэкап результатов
- [ ] История проверок с поиском

---

## Структура проекта

```
Яндекс Спич/
├── Оригинал/
│   ├── Главы/                  # DOCX файлы с текстом глав
│   └── Аудио/                  # MP3 файлы аудиокниги
├── Транскрибации/
│   ├── Глава1/                 # Транскрипции главы 1 (варианты)
│   └── Глава2/                 # Транскрипция главы 2
├── Инструменты/
│   ├── __init__.py v5.0.0      # Экспорт пакета
│   ├── config.py v5.0.0        # Ядро конфигурации + пути + логирование
│   ├── pipeline.py v5.0.0      # Главный пайплайн
│   ├── batch_pipeline.py v5.0.0 # Пакетная обработка
│   ├── transcribe.py v5.0.0    # Яндекс SpeechKit + RateLimiter
│   ├── transcription_provider.py v5.0.0 # ABC-интерфейс транскрибации
│   ├── smart_compare.py v5.0.0 # Умное сравнение
│   ├── golden_filter.py v5.0.0 # Обёртка → filters/
│   ├── filters/                # Модульный пакет фильтрации
│   │   ├── __init__.py v5.0.0  # Реэкспорт публичного API
│   │   ├── constants.py        # Словари и паттерны
│   │   ├── comparison.py       # Нормализация и сравнение
│   │   ├── detectors.py        # Детекторы ошибок
│   │   └── engine.py           # Движок фильтрации
│   ├── morphology.py v5.0.0    # Морфологический модуль
│   ├── cache_manager.py v5.0.0 # Менеджер кэша
│   ├── text_normalizer.py v5.0.0 # Нормализация текста
│   ├── proper_names_extractor.py v5.0.0 # Извлечение имён
│   ├── audio_converter.py v5.0.0 # Конвертация аудио
│   ├── web_viewer.py v5.0.0    # Веб-интерфейс
│   └── templates/
│       └── viewer.html         # HTML шаблон
├── Словари/
│   ├── Словарь_имён_персонажей.txt  # 549 имён → 9460 форм
│   ├── защищенные_слова.txt
│   └── ошибки_чтеца.json
├── Результаты проверки/        # JSON отчёты по главам
├── Чтецу/                      # DOCX для чтеца
├── Тесты/
│   ├── conftest.py             # Фикстуры pytest
│   ├── run_full_test.py v5.0.0 # Запуск всех тестов
│   ├── test_golden_standard.py # Золотой стандарт
│   ├── test_golden_filter_unit.py # Unit-тесты фильтра
│   ├── test_filters_package.py # Тесты пакета filters/ (91)
│   ├── test_morphology.py      # Тесты морфологии (30)
│   └── test_config.py          # Тесты конфигурации (50)
├── Темп/
│   ├── cache/                  # SQLite кэш морфологии
│   └── logs/                   # Лог-файлы пайплайна
├── api_keys.json               # Ключи Яндекс Cloud
├── requirements.txt            # Зависимости (pip)
├── pyproject.toml              # Метаданные проекта (PEP 621)
├── PROJECT.md
├── ROADMAP.md
└── CHANGELOG.md
```

---

## История версий

| Версия | Дата | Изменения |
|--------|------|-----------|
| v5.0.0 | 2026-01-25 | Модульная архитектура: filters/, ABC транскрибации, RateLimiter, 341 тест |
| v3.16.0 | 2026-01-24 | Добавлена система логирования: config.py, pipeline.py |
| v3.15.0 | 2026-01-24 | Интеграция завершена: унифицированы все модули с config.py |
| v3.14.0 | 2026-01-24 | Аудит golden_filter, filter_errors, smart_compare, batch_pipeline |
| v3.13.0 | 2026-01-24 | Интеграция text_normalizer.py с config.py |
| v3.12.0 | 2026-01-24 | YandexCloudConfig, transcribe.py v3.0 |
| v3.11.0 | 2026-01-24 | web_viewer.py v3.0, ротация логов |
| v3.10.0 | 2026-01-24 | config.py, FileNaming, исправление коротких слов |
| v3.9.0 | 2026-01-24 | Исправление original_text, автоопределение phantom |
| v3.8.0 | 2026-01-24 | Фильтрация имён персонажей, прозвища |
| v3.6.0 | 2026-01-24 | Словарь имён (544→9460 форм), 100% золотой стандарт |
| v3.3.0 | 2026-01-23 | morphology.py, batch_pipeline.py, retry-логика |
| v3.2.0 | 2026-01-23 | Новые омофоны, smart_compare v2.0 |
| v2.0.0 | 2026-01-23 | Восстановление проекта |

---

## Защита от потери данных

- Папка бэкапов: `~/Desktop/БЭКАПЫ_НЕ_УДАЛЯТЬ/`
- Claude Code настроен на использование `trash` вместо `rm`
- Автоматические бэкапы перед крупными изменениями
