# Roadmap проекта Яндекс Спич

## Текущий статус: ВЕРСИЯ 9.3 — ИСПРАВЛЕН БАГ МОНОТОННОСТИ ЯКОРЕЙ

**Результат:** Golden: 93/93 (100%). FP: **328** (было 357).

---

## Выполнено (2026-01-29)

### v9.3 — Исправление бага монотонности якорей ✅
- [x] Диагностика аномалии: Глава 2 показывала 1222 ошибки вместо ~70
- [x] Найдена причина: якорь "стражи" указывал на неправильную позицию (скачок назад на 1300 позиций)
- [x] Решение: добавлен `_filter_monotonic()` в AlignmentManager v1.2
- [x] Результат: Глава 2 — 62 ошибки (было 1222)
- [x] Общий FP: 328 (было 1488)
- [x] Golden 93/93 (100%) ✓

### v9.2 — Полная интеграция модулей ✅
- [x] WindowVerifier интегрирован в smart_compare.py v10.1
- [x] ScoringEngine интегрирован в engine.py v8.1 (уровень -1)
- [x] HARD_NEGATIVES очищены: 100+ пар → 3 пары имён (архитектурно правильно)
- [x] Исправлен баг загрузки имён (комментарии # пропускаются)
- [x] MorphoRules проверены: все golden ошибки защищены
- [x] Все 6 модулей интегрированы и работают
- [x] Golden 93/93 (100%) ✓

### v10.0 — Полное посегментное выравнивание ✅
- [x] `compare_with_anchors()` — посегментное сравнение с включением якорей
- [x] `merge_adjacent_opcodes()` — объединение смежных opcodes
- [x] `refine_large_segments()` — суб-якоря для сегментов >100 слов
- [x] `check_density()` — проверка плотности сегментов
- [x] Полный переход от полнотекстового к макро/микро выравниванию

### v9.1 — Исправление регрессии ComparisonStitcher ✅
- [x] Диагностика: причина потери ошибок — склейка коротких слов
- [x] PROTECTED_SHORT_WORDS — 27 защищённых слов
- [x] Golden 93/93 (100%) восстановлен
- [x] Исправлен золотой стандарт главы 4 (удалена ложная ошибка)

### run_full_test.py v6.0 — Архивирование прогонов ✅
- [x] Папка `Тесты/История/` для отдельных файлов прогонов
- [x] Автоопределение версии фильтров из `engine.py`
- [x] Автоопределение версии `smart_compare.py`
- [x] Поддержка главы 4
- [x] Новые команды: `--versions`, `--archive`
- [x] Формат имени файла: `YYYY-MM-DD_HH-MM_vX.Y_golden.json`

### v9.0 — Эксперимент с якорями (была регрессия, исправлено) ✅
Созданы модули:
- [x] CharacterGuard v1.0 — интегрирован в ScoringEngine
- [x] AlignmentManager v1.1 — полная интеграция в smart_compare
- [x] ScoringEngine v1.2 — интегрирован в smart_compare + engine.py
- [x] WindowVerifier v1.0 — интегрирован в smart_compare
- [x] ComparisonStitcher v1.1 — исправлен и интегрирован

---

## Текущая рабочая версия: v9.3

### Показатели v9.3
| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 | 92 |
| 2 | 21/21 | 62 |
| 3 | 20/20 | 118 |
| 4 | 21/21 | 56 |
| **ИТОГО** | **93/93** | **328** |

### Интегрированные модули v9.3
| Модуль | Версия | Статус |
|--------|--------|--------|
| AlignmentManager | v1.2 | ✅ Интегрирован + фильтр монотонности |
| ComparisonStitcher | v1.1 | ✅ Интегрирован |
| WindowVerifier | v1.0 | ✅ Интегрирован |
| ScoringEngine | v1.2 | ✅ Интегрирован |
| MorphoRules | v1.1 | ✅ Интегрирован |
| CharacterGuard | v1.0 | ✅ Интегрирован |

### Лучший исторический результат: v5.7
| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 | 62 |
| 2 | 21/21 | 42 |
| 3 | 20/20 | 79 |
| **ИТОГО** | **72/72** | **183** |

---

## В работе

### Снижение FP до уровня v5.7
- [ ] Цель: FP ≤ 200 (текущий 328, было 357)
- [ ] Анализ различий между v5.7 (183) и v9.3 (328)
- [ ] Оптимизация фильтров без потери golden

---

## Планы на будущее

### Расширение на новые главы
- [ ] Проверка глав 5 и далее
- [ ] Создание золотых стандартов
- [ ] Автоматизация полного конвейера

### Оптимизация v9.3+
- [x] ~~Интеграция ScoringEngine в фильтрацию~~ ✅ Выполнено в v9.2
- [x] ~~Интеграция WindowVerifier~~ ✅ Выполнено в v9.2
- [ ] Достичь: Golden 93/93, FP < 300

### Инфраструктура
- [ ] Покрытие тестами до 80%+
- [ ] CI/CD для автоматического тестирования
- [ ] Визуализация истории FP по версиям

---

## Архитектура

### Текущая (v9.2)
```
┌─────────────────────────────────────────────────────┐
│                smart_compare.py v10.1               │
├─────────────────────────────────────────────────────┤
│ 1. ComparisonStitcher v1.1│ Склейка слов + защита   │
│ 2. AlignmentManager v1.1  │ МАКРО: Якоря+сегменты   │
│ 3. compare_with_anchors() │ МИКРО: SequenceMatcher  │
│ 4. WindowVerifier v1.0    │ Контекстная верификация │
│ 5. ScoringEngine v1.2     │ Адаптивные штрафы       │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                filters/engine.py v8.1               │
├─────────────────────────────────────────────────────┤
│ УРОВЕНЬ -1: ScoringEngine │ HARD_NEGATIVES (имена)  │
│ УРОВЕНЬ 0:  MorphoRules   │ Морфология              │
│ УРОВНИ 1-20               │ Статические правила     │
└─────────────────────────────────────────────────────┘
```

### Алгоритм выравнивания v10.0
```
Оригинал          Транскрипция
    │                   │
    ▼                   ▼
┌─────────────────────────────┐
│   1. Найти якоря (>6 симв)  │
│      Уникальные слова       │
└─────────────────────────────┘
              │
              ▼
┌─────────────────────────────┐
│   2. Разбить на сегменты    │
│      по якорям              │
└─────────────────────────────┘
              │
              ▼
┌─────────────────────────────┐
│   3. Если сегмент >100 слов │
│      → найти суб-якоря      │
└─────────────────────────────┘
              │
              ▼
┌─────────────────────────────┐
│   4. SequenceMatcher на     │
│      каждый сегмент         │
└─────────────────────────────┘
              │
              ▼
┌─────────────────────────────┐
│   5. Добавить якоря как     │
│      'equal' opcodes        │
└─────────────────────────────┘
              │
              ▼
┌─────────────────────────────┐
│   6. Объединить opcodes     │
│      + корректировка idx    │
└─────────────────────────────┘
```

---

## Структура проекта

```
Яндекс Спич/
├── Инструменты/
│   ├── config.py v5.0.0
│   ├── pipeline.py v5.0.0
│   ├── smart_compare.py v10.1.0      # Посегментное выравнивание + WindowVerifier
│   ├── alignment_manager.py v1.1.0   # refine_large_segments()
│   ├── filters/
│   │   ├── engine.py v8.1            # + ScoringEngine защита
│   │   ├── morpho_rules.py v1.1.0
│   │   ├── character_guard.py
│   │   ├── scoring_engine.py
│   │   └── window_verifier.py        # Интегрирован в smart_compare
├── Тесты/
│   ├── run_full_test.py v6.0.0
│   ├── История/
│   ├── golden_test_history.json
│   └── золотой_стандарт_глава*.json   # 93 ошибки
├── PROJECT.md
├── ROADMAP.md
└── CHANGELOG.md
```

---

## История версий

| Версия | Дата | Golden | FP | Статус |
|--------|------|--------|-----|--------|
| **v9.2.0** | **2026-01-29** | **93/93 ✓** | **357** | **Текущая — все модули интегрированы** |
| v10.0.0 | 2026-01-29 | 93/93 ✓ | 357 | Посегментное выравнивание |
| v9.1.0 | 2026-01-29 | 93/93 ✓ | 357 | Исправлена регрессия |
| v9.0.0 | 2026-01-29 | 91/94 ❌ | 414 | Регрессия (модули не интегрированы) |
| v8.1.1 | 2026-01-29 | 94/94 | 356 | - |
| v8.0.0 | 2026-01-26 | 94/94 | ~350 | - |
| v5.7 | 2026-01-25 | 72/72 | 183 | Лучший FP |
| v5.0.0 | 2026-01-25 | 72/72 | ~265 | - |

**Примечание:** Golden изменился 94→93 из-за исправления ложной ошибки в золотом стандарте главы 4.

---

## Защита от потери данных

- Папка бэкапов: `~/Desktop/БЭКАПЫ_НЕ_УДАЛЯТЬ/`
- Claude Code: `trash` вместо `rm`
- Архив прогонов: `Тесты/История/`

---

*Обновлено: 2026-01-29 (v9.2)*
