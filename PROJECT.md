# Проект: Проверка аудиокниг через Яндекс SpeechKit

**Версия:** 5.7.0
**Дата:** 2026-01-25
**Статус:** Рабочий, модульная архитектура, ABC-абстракции, SQLite база ложных срабатываний, 370 unit-тестов

## Описание
Система для автоматической проверки качества озвучки аудиокниг. Отправляет аудио в Яндекс SpeechKit для транскрибации, сравнивает с оригинальным текстом и находит реальные ошибки чтеца, отфильтровывая ложные срабатывания через многоуровневый фильтр отсева.

## Текущие показатели
- **Золотой стандарт глава 1: 31/31 (100%)** — 62 ошибки всего
- **Золотой стандарт глава 2: 21/21 (100%)** — 42 ошибки всего
- **Золотой стандарт глава 3: 20/20 (100%)** — 79 ошибок всего
- **Общий золотой стандарт: 72/72 (100%)** — 183 ошибки всего
- **Словарь имён: 549 базовых → 9460 форм** (автозагрузка из файла + автогенерация падежей)
- **Кэширование pymorphy: 77-82%** попаданий в кэш
- **Строк кода: ~12 000** (Python, оптимизировано)
- **Unit-тесты: 370** (pytest, 0 failures)
- **Покрытие:** text_normalizer 67%, filters/ 70%+, morphology 60%+, config 50%+, smart_compare 34%

## Архитектура

```
┌─────────────┐     ┌──────────────┐     ┌───────────────┐
│   Аудио     │────▶│  Конвертация │────▶│ Яндекс Speech │
│   (MP3)     │     │  (OggOpus)   │     │    Kit API    │
└─────────────┘     └──────────────┘     └───────┬───────┘
                                                 │
                                          транскрипция
                                                 │
                    ┌──────────────┐             ▼
┌─────────────┐     │ Нормализация │     ┌───────────────┐
│  Оригинал   │────▶│ (числа,      │────▶│    Умное      │
│   (DOCX)    │     │  дефисы)     │     │  сравнение    │
└─────────────┘     └──────────────┘     └───────┬───────┘
                                                 │
                                           ошибки-кандидаты
                                                 │
                                                 ▼
                                         ┌───────────────┐
                                         │    Набор      │
                                         │   фильтров    │
                                         └───────┬───────┘
                                                 │
                                        реальные ошибки
                                                 │
                          ┌──────────────────────┼──────────────────────┐
                          ▼                      ▼                      ▼
                   ┌────────────┐         ┌────────────┐         ┌────────────┐
                   │   JSON     │         │    DOCX    │         │    Веб     │
                   │   отчёт    │         │   чтецу    │         │ интерфейс  │
                   └────────────┘         └────────────┘         └────────────┘
```

## Структура проекта
```
Яндекс Спич/
├── Оригинал/                   # Исходные материалы книги
│   ├── Главы/                  # DOCX файлы с текстом глав
│   │   ├── Глава 1.docx
│   │   └── Глава2.docx
│   └── Аудио/                  # MP3 файлы аудиокниги
│       └── 01.mp3
├── Инструменты/
│   ├── config.py v5.0.0        # Централизованная конфигурация + логирование
│   ├── pipeline.py v5.0.0      # Полный пайплайн с логированием
│   ├── batch_pipeline.py v5.0.0 # Пакетная обработка глав
│   ├── audio_converter.py v2.0 # Конвертация в OggOpus
│   ├── transcribe.py v3.0      # API Яндекс SpeechKit + RateLimiter
│   ├── transcription_provider.py # ABC-абстракция транскрибации
│   ├── text_normalizer.py v2.0 # Нормализация текста
│   ├── smart_compare.py v5.0.0 # Умное сравнение (SequenceMatcher)
│   ├── golden_filter.py v5.0.0 # Обёртка обратной совместимости → filters/
│   ├── filters/                # Модульный пакет фильтрации v5.7.0
│   │   ├── base.py             # ABC-интерфейс FilterRule (v5.7)
│   │   ├── constants.py        # Словари и константы
│   │   ├── comparison.py       # Функции сравнения слов
│   │   ├── detectors.py        # Специализированные детекторы
│   │   └── engine.py           # Движок фильтрации (20 уровней)
│   ├── morphology.py v5.0.0    # Морфологический анализ с кэшем
│   ├── cache_manager.py v5.0.0 # Менеджер кэширования
│   ├── proper_names_extractor.py v5.0.0  # Извлечение имён
│   ├── web_viewer.py v3.2      # Веб-интерфейс
│   ├── analyze_false_positives.py v1.0  # Анализатор ложных срабатываний
│   ├── false_positives_tracker.py v1.0  # Накопительный трекер ложных срабатываний (JSON, legacy)
│   ├── false_positives_db.py v1.0      # SQLite база ложных срабатываний (v5.7)
│   ├── process_new_chapter.py v1.0     # Автоматизация обработки новых глав (v5.7)
│   └── batch_transcribe_from_bucket.py v1.0  # Пакетная транскрибация из бакета
├── Словари/
│   ├── Словарь_имён_персонажей.txt  # Имена персонажей (549 базовых)
│   ├── ошибки_чтеца.json       # Типичные ошибки конкретного чтеца
│   ├── защищенные_слова.txt    # Слова, которые нельзя фильтровать
│   ├── config.json             # Конфигурация фильтров
│   ├── false_positives_tracker.json  # Накопительный трекер (JSON, legacy)
│   └── false_positives.db            # SQLite база ложных срабатываний (v5.7)
├── Транскрибации/              # Сохранённые транскрипции
│   ├── Глава1/                 # Транскрипции главы 1 (A, B, C, 16/32/96 kbps)
│   └── Глава2/                 # Транскрипция главы 2
├── Тесты/
│   ├── conftest.py                    # Общие фикстуры и конфигурация pytest
│   ├── test_golden_filter_unit.py     # Unit-тесты фильтра (72 теста)
│   ├── test_filters_package.py        # Тесты пакета filters/ (91 тест)
│   ├── test_morphology.py             # Тесты морфологии (30 тестов)
│   ├── test_config.py                 # Тесты конфигурации (50 тестов)
│   ├── test_text_normalizer.py        # Unit-тесты нормализации текста (60 тестов)
│   ├── test_smart_compare.py          # Unit-тесты умного сравнения (44 теста)
│   ├── test_golden_standard.py        # Тест золотого стандарта (утилита)
│   ├── run_full_test.py v5.2          # Полный тест системы с историей
│   ├── golden_test_history.json       # История результатов тестов
│   ├── золотой_стандарт_глава1.json   # Эталонные ошибки главы 1 (31)
│   ├── золотой_стандарт_глава2.json   # Эталонные ошибки главы 2 (21)
│   └── золотой_стандарт_глава3.json   # Эталонные ошибки главы 3 (20)
├── Результаты проверки/        # JSON отчёты с ошибками
├── Чтецу/                      # DOCX файлы для чтеца
├── Темп/
│   ├── cache/                  # SQLite кэш морфологии
│   └── logs/                   # Лог-файлы пайплайна
├── api_keys.json               # API ключи Яндекс
├── pytest.ini                  # Конфигурация pytest
├── PROJECT.md                  # Этот файл
├── ROADMAP.md                  # План развития
└── CHANGELOG.md                # История изменений
```

## Использование

### Полный пайплайн (рекомендуется)
```bash
python Инструменты/pipeline.py глава.mp3 оригинал.docx
```

### С подробным логированием
```bash
python Инструменты/pipeline.py глава.mp3 оригинал.docx --verbose
```

### Только ошибки в консоли
```bash
python Инструменты/pipeline.py глава.mp3 оригинал.docx --quiet
```

### С готовой транскрипцией
```bash
python Инструменты/pipeline.py глава.mp3 оригинал.docx --skip-transcribe --transcript-path транскрипт.json
```

### С веб-интерфейсом
```bash
python Инструменты/pipeline.py глава.mp3 оригинал.docx --web
```

### Отдельные этапы

**Конвертация аудио:**
```bash
python Инструменты/audio_converter.py глава.mp3 глава_yandex.ogg
```

**Транскрибация:**
```bash
python Инструменты/transcribe.py глава_yandex.ogg
```

**Проверка:**
```bash
python Инструменты/smart_compare.py транскрипция.json оригинал_norm.txt --audio глава.mp3
```

**Фильтрация:**
```bash
python Инструменты/golden_filter.py отчет_compared.json
```

**Анализ ложных срабатываний:**
```bash
# Анализ первых 20 ошибок главы 1
python Инструменты/analyze_false_positives.py 01 --limit 20

# Только настоящие ложные срабатывания (исключить золотой стандарт)
python Инструменты/analyze_false_positives.py 01 --no-golden

# Сохранить отчёт в файл
python Инструменты/analyze_false_positives.py 02 --output report.md
```

**Трекер ложных срабатываний (накопительный учёт):**
```bash
# Добавить ложные из отчёта в трекер
python Инструменты/false_positives_tracker.py add report.json --source "01_A"

# С автоисключением золотого стандарта
python Инструменты/false_positives_tracker.py add report.json --golden golden.json --source "01_B"

# Статистика трекера
python Инструменты/false_positives_tracker.py stats

# Топ-20 частых ложных (приоритизация работы)
python Инструменты/false_positives_tracker.py top 20

# Пометить паттерн как решённый (после добавления фильтра)
python Инструменты/false_positives_tracker.py resolve "своим→свои"

# Проверить регрессии
python Инструменты/false_positives_tracker.py check-regressions report.json

# Экспорт для внешнего анализа
python Инструменты/false_positives_tracker.py export --format csv -o export.csv
```

**Пакетная транскрибация из бакета:**
```bash
# Список файлов в бакете
python Инструменты/batch_transcribe_from_bucket.py --list

# Транскрибация всех файлов
python Инструменты/batch_transcribe_from_bucket.py

# Только файлы главы 1
python Инструменты/batch_transcribe_from_bucket.py --filter 01
```

## Этапы пайплайна

### 1. Конвертация аудио
- Формат: OggOpus (рекомендуется Яндексом)
- Каналы: моно
- Частота: 48 кГц
- Битрейт: ≤64 кбит/с

### 2. Транскрибация (Яндекс SpeechKit)
- API: asyncRecognize
- Модель: general (стандартная)
- Язык: ru-RU

**Важно: Яндекс SpeechKit не детерминирован!**
Повторная транскрибация одного аудио даёт ~1% различий:
- Грамматические окончания (`меняется` ↔ `меняются`)
- Имена персонажей (`шаугад` ↔ `шоугад`, `арзумы` ↔ `эрзумы`)
- Короткие слова и союзы (появляются/исчезают)
- Разные слова (`свиток` ↔ `цветок`, `утащить` ↔ `учить`)

### 2.1. Пропуск метаданных (phantom)
В начале аудиофайлов есть заставка с метаданными:
> «Михаил Игнатов, Цикл Путь, Книга N, Глава N»

Эти слова отсутствуют в оригинальном тексте и должны быть пропущены при сравнении.

**Параметр `--phantom`** (в секундах):
- По умолчанию: 5 сек (для обычных глав)
- Для тестовых файлов с заставкой: `--phantom 18`

```bash
python Инструменты/smart_compare.py транскрипция.json оригинал.txt --phantom 18
```

### 3. Нормализация текста
- **Числа** → слова с правильными падежами
- **Сокращения** → полные формы (г. → год, т.д. → так далее)
- **Дефисы внутри слов** → унификация (по-своему, кое-что)
- **Тире между словами** → пробелы
- **Диалоговые тире** → удаление
- **Приведение к нижнему регистру**, удаление знаков препинания

### 4. Умное сравнение
- **Якоря** — слова со 100% совпадением (точки синхронизации)
- **Серые зоны** — участки между якорями для детального анализа
- **Классификация** — схожесть ≥70% = ошибка Яндекса, <70% = ошибка чтеца

### 5. Фильтр отсева v5.0 (filters/ пакет, golden_filter.py)

**Производительность:**
- @lru_cache для pymorphy — 77% попаданий в кэш
- Единый parse_word_cached() вместо 3 отдельных вызовов
- Предкомпилированные regex паттерны

**Словарь имён персонажей:**
- Автозагрузка из `Словари/Словарь_имён_персонажей.txt`
- 549 базовых имён → 9460 падежных форм (через pymorphy)
- Функция `load_base_character_names()` для базовых форм
- Функция `load_character_names_dictionary()` для всех форм
- Пополнение через `proper_names_extractor.py --to-names-dict`

**Уровни фильтрации:**

1. **Междометия** (interjection) — п, ф, м, ах, ох, эх
2. **Контекстные артефакты** (context_artifact) — «и...и» в перечислениях
3. **Защищённые слова** (protected_word) — имена, термины
4. **Артефакты выравнивания** (alignment_artifact) — deletions предлогов в, о, у, к, с, но, ни, им, на, до, же, да, х, не, так
5. **Слабые слова** (weak_words_same_lemma) — тот, так, эти, то, несколько, эдак
6. **Омофоны** (homophone) — его/ево, что/што, ну/но, я/и, а/но, то/ты, ах/ох, думая/думаю
7. **Слитные слова** (compound_word) — что→чтото, из→изза
8. **Разбитые дефисные слова** (split_compound) — что-то→«что то», по-хорошему→«по хорошему», из-за→«из за» (v4.4: 27 паттернов для -то/-либо/-нибудь)
9. **Грамматические окончания глаголов** (grammar_ending_verb_number) — заметят↔заметит, придут↔придёт (Яндекс путает число)
10. **Грамматические окончания** (grammar_ending) — -ый/-ое, -ит/-ят
11. **Падежные формы** (case_form) — печати↔печатей, свитка↔свитки (расширено -ей↔-и)
12. **Наречие↔прилагательное** (adverb_adjective) — довольны→довольно
13. **Краткое↔полное** (short_full_adjective) — уверены→уверенный
14. **Глагол↔деепричастие** (verb_gerund_safe) — стараюсь→стараясь
15. **Лемматизация** (same_lemma) — pymorphy2 с проверкой POS и числа
16. **Левенштейн** (levenshtein_similar_lemma) — расстояние ≤2 + одна лемма (защита местоимений нас↔вас)
17. **Типичные ошибки Яндекса** (yandex_typical) — 70+ паттернов (v4.4: из→изза, сходу→ходу, слух→вслух)
18. **Ошибки в именах** (yandex_name_error) — использует загруженный словарь (549 имён)
19. **Варианты с приставками** (prefix_variant) — недостаёт↔достаёт, выпускать↔упускать
20. **Разбитые слова** (split_word_insertion) — мыслеречи→мысли речи

**Важно для insertions/deletions:**
- Пропуск или вставка слова — ВСЕГДА реальная ошибка
- Короткие слова ("я", "а", "то") НЕ фильтруются, если это реальная ошибка чтеца
- Союзы и местоимения проверяются строго
- v4.4: Фильтр частиц -то/-либо/-нибудь проверяет слитную форму в оригинале

### 6. Генерация отчётов
- **JSON** — машиночитаемый формат
- **DOCX** — для чтеца с форматированием
- **Веб** — интерактивный просмотр с аудио

### 7. Веб-интерфейс (web_viewer.py)

**Запуск:**
```bash
python Инструменты/web_viewer.py ошибки.json --audio аудио.ogg --original оригинал.docx --transcript транскрипция.json
```

**Функции:**
- Интерактивный аудиоплеер с навигацией по таймкодам
- Фильтрация ошибок по типу (замены, перестановки, лишние слова, пропуски)
- Контексты из оригинального DOCX (с пунктуацией)
- Маркеры ошибок в контексте:
  - **Замена**: `●слово` — маркер перед правильным словом
  - **Перестановка**: `⇄слова` — маркер перед переставленными словами
  - **Лишнее слово**: `▲[СЛОВО]` — маркер между соседними словами в оригинале
  - **Пропуск**: `▼слово` — маркер перед пропущенным словом из оригинала
- Экспорт в TXT/DOCX для чтеца
- Отметка ложных срабатываний

## Типы ошибок
- **substitution** — замена слова (ЖИВЁМ → живы)
- **transposition** — перестановка слов (ТЫ ЧТО ⇄ что ты)
- **insertion** — лишнее слово
- **deletion** — пропуск слова

## Формат для чтеца
- **КАПС КУРСИВ** — что услышал Яндекс (ошибка)
- **жирный** — правильное слово из текста
- **(слово)** — пропущенное слово
- **⇄** — маркер перестановки слов

## Тестирование

### Unit-тесты (pytest)

Проект использует pytest с конфигурацией в `pytest.ini` и общими фикстурами в `Тесты/conftest.py`.

```bash
# Запуск всех unit-тестов (341 тест)
pytest -v

# Запуск конкретного модуля
pytest Тесты/test_filters_package.py -v      # 91 тест пакета filters/
pytest Тесты/test_golden_filter_unit.py -v   # 72 теста фильтра (обратная совместимость)
pytest Тесты/test_text_normalizer.py -v      # 60 тестов нормализации
pytest Тесты/test_config.py -v               # 50 тестов конфигурации
pytest Тесты/test_smart_compare.py -v        # 44 теста сравнения
pytest Тесты/test_morphology.py -v           # 30 тестов морфологии

# Запуск по маркерам
pytest -m "not slow" -v          # без медленных тестов
pytest -m "pymorphy" -v          # только тесты с pymorphy

# С покрытием
pytest --cov=Инструменты --cov-report=term-missing
pytest --cov=Инструменты --cov-report=html
```

**Описание тестовых файлов:**

| Файл | Тестов | Покрывает |
|------|--------|-----------|
| `test_filters_package.py` | 91 | Пакет filters/: constants, comparison, detectors, engine, обратная совместимость |
| `test_golden_filter_unit.py` | 72 | 20 уровней фильтрации, морфология, Левенштейн, should_filter_error |
| `test_text_normalizer.py` | 60 | Числа→слова, склонения, сокращения, единицы, дефисы, очистка, междометия |
| `test_config.py` | 50 | Пути, FileNaming, SmartCompareConfig, GoldenFilterConfig, YandexCloudConfig, утилиты, логирование |
| `test_smart_compare.py` | 44 | Фонетика, нормализация, Word/Error, контексты, транспозиции |
| `test_morphology.py` | 30 | Морфоанализ, лемматизация, POS/число/род/падеж, кэширование, MorphCache |

**conftest.py — общие фикстуры:**
- `project_dir`, `tests_dir`, `instruments_dir` — пути
- `substitution_error`, `deletion_error`, `insertion_error` — шаблоны ошибок
- `homophone_error`, `yandex_typical_error`, `real_reader_error` — специфичные кейсы
- `sample_word_pairs` — пары слов для тестирования фильтров
- Маркеры: `slow`, `pymorphy`, `integration`

### Полный тест системы (end-to-end)
```bash
python Тесты/run_full_test.py              # все 3 главы (пайплайн + тест)
python Тесты/run_full_test.py --chapter 1  # только глава 1
python Тесты/run_full_test.py --chapter 3  # только глава 3
python Тесты/run_full_test.py --skip-pipeline  # только золотой тест (без пайплайна)
python Тесты/run_full_test.py --history    # показать историю тестов
python Тесты/run_full_test.py -m "комментарий"  # добавить комментарий к запуску
python Тесты/run_full_test.py --no-log     # без записи в историю
```

**Пример вывода с историей:**
```
  ИТОГИ (с историей последних 4 итераций)

  Глава    Золотые      Сейчас   Пред.    -2       -3       Тренд
  ------------------------------------------------------------
  ✓ Гл.1    31/31        75       75       75       -        =
  ✓ Гл.2    21/21        51       51       51       -        =
  ✓ Гл.3    20/20        139      139      -        -        =
  ------------------------------------------------------------
  ИТОГО    72/72        265      265      126      -        =
```

### Тест золотого стандарта одной главы
```bash
python Тесты/test_golden_standard.py "Результаты проверки/01/01_filtered.json"
python Тесты/test_golden_standard.py "Результаты проверки/02/02_filtered.json" "Тесты/золотой_стандарт_глава2.json"
```

### Текущие результаты
- **Глава 1: 31/31 (100%)** — 75 ошибок всего
- **Глава 2: 21/21 (100%)** — 51 ошибок всего
- **Глава 3: 20/20 (100%)** — 139 ошибок всего
- **Общий: 72/72 (100%)** — 265 ошибок всего

### Золотой стандарт главы 1
Файл: `Тесты/золотой_стандарт_глава1.json` — 31 ошибка

- **25 substitutions** (замены слов):
  - 0:59 ЖИВЕМ→живы, 1:06 ТЕРЯЮ→теряя, 2:23 ВЫХОДА→способа
  - 12:23 СОТНИ→сотня, 12:47 ПРОДОЛЖАЯ→продолжал
  - 14:09 ОЩУЩАЛ→ощутил, 15:37 ты что→что ты (перестановка)
  - 16:51 ДОБАВИЛА→добавив, 19:40 ДОГОВАРИВАЛИСЬ→договорились
  - 22:12 ГРОМКО→громче, 25:36 я→с
  - 27:49 предводителя→предводителей, 30:38 или→и, 31:00 а→и
  - 34:11 вас→нас, 36:09 этими→этим, 36:41 мыслеречью→мыслью
  - 43:13 нибудь→то, 44:44 что→кто, 45:30 вопроса→слова
  - 51:50 правду→прямо, 55:25 услышал→услышав, 56:12 нет→нельзя
  - 59:10 эти→это
- **3 insertions** (лишние слова): СКАЗАТЬ, ТО, ЧТО
- **3 deletions** (пропуски): Я, ним, он, вам

### Золотой стандарт главы 2
Файл: `Тесты/золотой_стандарт_глава2.json` — 21 ошибка

- **17 substitutions**: старейший→старший, мечтательны→мечтатели, возможность→возможности, десятках→десятки, соглядатаи→соглядатаев, настолько→сколько, клинка→меча, неуместно→невместно, собиратели→собиратель, штука→шутка, было→бы (×2), после→возле, выгрызать→выгрызть, снова→вновь, лишились→решилась, справляются→справляется, доказывай→доказывая
- **2 deletions** (пропуски): мне, же
- **1 insertion** (лишнее слово): ты

### Золотой стандарт главы 3
Файл: `Тесты/золотой_стандарт_глава3.json` — 20 ошибок

- **14 substitutions**: верному→верный, императора→империи, получится→получилось, проводит→проходит, давайте→дайте, она→они, и→я, кто→что, закрывающих→закрывают, ключ→ключа, этого→него, какого→когда, древних→древними
- **5 insertions** (лишние слова): и (×4), он, своих
- **1 deletion** (пропуск): той

### Правила создания золотых стандартов

При добавлении новой главы:

1. **Прослушать аудиозапись** и найти все реальные ошибки чтеца
2. **Создать файл** `Тесты/золотой_стандарт_глава{N}.json`
3. **Использовать единый формат** (обязательные поля):
   - `time` (str) — `"M:SS"`
   - `time_seconds` (int) — время в секундах
   - `type` (str) — `substitution`, `insertion` или `deletion`
   - `wrong` (str) — что услышал Яндекс (`""` для deletion)
   - `correct` (str) — что должно быть (`""` для insertion)
   - `context` (str) — фрагмент оригинала
4. **Запустить `run_full_test.py`** для проверки
5. **НЕ использовать** альтернативные поля (`spoken/expected`, `timestamp`, `SUB/INS/DEL`)

### Результаты на транскрибациях v4.4

**48 kbps (стандартный битрейт):**
| Транскрибация | Золотой тест | Всего ошибок | Ложных |
|---------------|--------------|--------------|--------|
| A | 31/31 ✓ | 50 | 19 |
| B | 31/31 ✓ | 59 | 28 |
| C | 31/31 ✓ | 54 | 23 |

**Эксперимент с битрейтами (v4.4):**
| Битрейт | Золотой тест | Всего ошибок | Ложных | vs v4.3 |
|---------|--------------|--------------|--------|---------|
| 16 kbps | 31/31 ✓ | 67 | 36 | -29 |
| 32 kbps | 31/31 ✓ | 62 | 31 | -29 |
| 96 kbps | 31/31 ✓ | 65 | 34 | -30 |

**Выводы эксперимента:**
- Битрейт не влияет на качество распознавания (16-96 kbps дают одинаковое количество ошибок)
- 48 kbps оптимален по соотношению размер/качество
- Разница между сессиями транскрибации важнее битрейта
- v4.4 даёт улучшение ~30 ложных ошибок благодаря фильтру частиц -то/-либо/-нибудь

## Зависимости

### Основные
- requests — HTTP запросы к API
- python-docx — работа с DOCX файлами
- pydub — работа с аудио
- rapidfuzz (или thefuzz) — расстояние Левенштейна
- pymorphy2 — морфологический анализ, лемматизация
- ffmpeg — конвертация аудио (системный)

### Тестирование
- pytest ≥ 6.0 — фреймворк для тестов
- pytest-cov — измерение покрытия кода

### Установка
```bash
pip install -r requirements.txt
brew install ffmpeg  # macOS
```

## API ключи
Хранятся в `api_keys.json`:
```json
{
  "speechkit": {
    "key_id": "...",
    "secret": "..."
  },
  "folder_id": "..."
}
```

## Правила хранения файлов

### Структура папок
| Папка | Содержимое | Пример файла |
|-------|-----------|--------------|
| `Оригинал/Главы/` | DOCX файлы оригинального текста | `Глава 1.docx`, `Глава2.docx` |
| `Оригинал/Аудио/` | MP3 файлы аудиокниги | `01.mp3`, `02.mp3` |
| `Транскрибации/Глава{N}/` | Транскрипции от Яндекса (по главам) | `01_transcript.json` |
| `Результаты проверки/{NN}/` | **Все** результаты проверки главы (единственное место!) | `01_compared.json`, `01_filtered.json`, `01_для_чтеца.docx` |
| `Чтецу/` | Копии DOCX отчётов для чтеца (опционально) | `01_для_чтеца.docx` |
| `Словари/` | Словари и справочники | `Словарь_имён_персонажей.txt` |
| `Темп/` | Временные файлы (кэш, логи) | `cache/morph_cache.db` |
| `Тесты/` | Golden standard, unit-тесты, conftest | `test_*.py`, `золотой_стандарт_глава1.json` |

### Правило хранения транскрипций
Все транскрипции хранятся в `Транскрибации/Глава{N}/`:
- **Основная транскрипция:** `{NN}_transcript.json`
- **Варианты (разный битрейт, повторные прогоны):** `{NN}_transcript_{variant}.json`
- Пример: `Транскрибации/Глава1/01_transcript_48kbps.json`

Методы поиска файлов определены в `config.py → FileNaming`:
- `FileNaming.find_transcription(chapter_id)` — ищет транскрипцию
- `FileNaming.get_original_path(chapter_id)` — ищет оригинал DOCX
- `FileNaming.get_audio_path(chapter_id)` — ищет аудиофайл

### Правила хранения compared и filtered файлов

Файлы промежуточных и финальных результатов проверки хранятся **строго** в `Результаты проверки/{NN}/`:

| Файл | Этап | Описание |
|------|------|----------|
| `{NN}_compared.json` | smart_compare | Все найденные несовпадения (до фильтрации) |
| `{NN}_filtered.json` | golden_filter | **Финальный отчёт** — только реальные ошибки чтеца |
| `{NN}_normalized.txt` | text_normalizer | Нормализованный оригинал |
| `{NN}_для_чтеца.docx` | pipeline | DOCX для чтеца |
| `extracted_names.txt` | pipeline | Извлечённые имена собственные |

**Запрещено:**
- Хранить compared/filtered файлы в `Темп/`, корне проекта или других папках
- Создавать compared/filtered вне структуры `Результаты проверки/{NN}/`
- Дублировать результаты в нескольких местах

**При повторном запуске пайплайна** файлы перезаписываются (с флагом `--force`).

### Конвенция именования файлов
Формат: `{chapter_id}_{stage}.{ext}`

| stage | Описание | Пример |
|-------|----------|--------|
| `transcript` | Транскрипция | `01_transcript.json` |
| `normalized` | Нормализованный текст | `01_normalized.txt` |
| `compared` | После сравнения | `01_compared.json` |
| `filtered` | После фильтрации | `01_filtered.json` |
| `audio` | Конвертированный аудио | `01_yandex.ogg` |
| `docx` | Отчёт для чтеца | `01_для_чтеца.docx` |

### Общие правила
- **Бэкапы** — `~/Desktop/БЭКАПЫ_НЕ_УДАЛЯТЬ/Яндекс спич/`
- **Удаление файлов** — только через `trash`, не `rm`
- **Временные файлы** — в `Темп/`, не в корне проекта

## Workflow улучшения фильтров

### Накопительный учёт ложных срабатываний

Система использует трекер `false_positives_tracker.py` для статистического анализа и приоритизации работы над фильтрами.

**Принцип работы:**
1. После каждой транскрибации → добавляем ложные в трекер (они накапливаются)
2. Анализируем топ частых → видим какие паттерны встречаются чаще всего
3. Добавляем паттерн в фильтр (constants.py, comparison.py и т.д.)
4. Помечаем паттерн как resolved → он больше не учитывается
5. Периодически проверяем регрессии → если resolved-паттерн снова появился

**Файл трекера:** `Словари/false_positives_tracker.json`

**Структура записи:**
```json
{
  "wrong": "своим",
  "correct": "свои",
  "type": "substitution",
  "count": 7,
  "sources": ["01_A", "01_B", "02", "03"],
  "pattern_suggestion": "grammar_ending",
  "first_seen": "2026-01-25T...",
  "last_seen": "2026-01-25T..."
}
```

**Типичный workflow:**
```bash
# 1. Получаем новые транскрипции
python Инструменты/batch_transcribe_from_bucket.py

# 2. Прогоняем через пайплайн
python Инструменты/pipeline.py audio.mp3 original.docx

# 3. Добавляем ложные в трекер
python Инструменты/false_positives_tracker.py add \
    "Результаты проверки/01/01_filtered.json" \
    --golden "Тесты/золотой_стандарт_глава1.json" \
    --source "01_NEW"

# 4. Смотрим топ частых
python Инструменты/false_positives_tracker.py top 20

# 5. Добавляем паттерн в фильтр (редактируем constants.py)

# 6. Помечаем как решённый
python Инструменты/false_positives_tracker.py resolve "своим→свои"

# 7. Проверяем регрессии после изменений
python Инструменты/false_positives_tracker.py check-regressions report.json
```

**Категории паттернов (автоматическая классификация):**
- `grammar_ending` — различия в окончаниях (своим/свои, сотни/сотня)
- `prefix_variant` — приставки (недостаёт/достаёт, выпускать/упускать)
- `phonetic` — фонетическое сходство (его/ево, тся/ться)
- `short_word` — короткие слова (а, и, то, я)
- `alignment_artifact` — артефакты выравнивания
- `unknown` — требует ручной классификации

## История версий
- **v5.2.0** (2026-01-25) — Золотой стандарт главы 3 (20 ошибок), итого 72/72. run_full_test.py v5.2: таблица итогов с историей последних 4 итераций (Сейчас | Пред. | -2 | -3 | Тренд), логирование результатов в golden_test_history.json, флаги --history/--comment/--no-log. Улучшение фильтра и/а/я: 4 новых паттерна (yandex_merge_artifact, yandex_truncate_artifact, yandex_expand_artifact, sentence_start_conjunction), исправлена морфологическая проверка падежей прилагательных и времени глаголов в is_lemma_match(), удалены я/и из HOMOPHONES, очищен WEAK_INSERTIONS, фильтр alignment_chain пропускает короткие слова (≤2 символа). Результат: 265 ошибок всего (75+51+139)
- **v5.1.1** (2026-01-25) — Новый инструмент analyze_false_positives.py для анализа ложных срабатываний: извлечение контекстов из 3 источников (оригинал, нормализованный, транскрипт), классификация паттернов (ОКОНЧАНИЕ, ПРЕФИКС, ФОНЕТИКА, МЕСТОИМЕНИЕ), проверка конфликтов с золотым стандартом, рекомендации по добавлению в HOMOPHONES/YANDEX_TYPICAL_ERRORS, флаг --no-golden для показа только настоящих ложных срабатываний. Добавлены новые паттерны в constants.py: HOMOPHONES (он↔она), YANDEX_TYPICAL_ERRORS (умею↔сумею, оттого↔от)
- **v5.1.0** (2026-01-25) — Расширен золотой стандарт главы 2 (14→21 ошибка), исправлена опечатка в оригинале («одим»→«один»), +29 тестов для smart_compare.py (370 всего), параллельная обработка batch_pipeline.py (--parallel), разделение web_viewer.py → docx_export.py, конфигурация через JSON, валидация входных данных в pipeline.py, .gitignore + Makefile + ruff/mypy
- **v5.0.0** (2026-01-25) — Модульная архитектура: golden_filter.py разделён на пакет filters/ (constants, comparison, detectors, engine), ABC-абстракция TranscriptionProvider + MockProvider, RateLimiter (token bucket) в transcribe.py, requirements.txt + pyproject.toml, удалён deprecated filter_errors.py, 171 новых тестов (test_filters_package, test_morphology, test_config), улучшены fallback-пути в detectors.py, все модули обновлены до версии 5.0.0
- **v4.8.0** (2026-01-25) — Тестовая инфраструктура: 170 unit-тестов (pytest), pytest.ini, conftest.py с общими фикстурами, новые тестовые модули test_text_normalizer.py (60 тестов) и test_smart_compare.py (44 тестов), доработан test_golden_filter_unit.py (72 теста: заполнены стабы, исправлены слабые assert'ы, добавлены edge cases), pytest-cov для покрытия, words_match() в test_golden_standard.py для надёжного сопоставления коротких слов
- **v4.7.0** (2026-01-25) — Ревизия проекта: удалены DEPRECATED модули (check_transcription.py, text_processor.py), исправлен баг fallback пути в cache_manager.py, добавлены методы поиска файлов в FileNaming (find_transcription, get_original_path, get_audio_path), документировано правило хранения транскрипций, filter_errors.py помечен как DEPRECATED, обновлён __init__.py
- **v4.6.0** (2026-01-25) — Проверка главы 2, голден тест главы 2, улучшение web_viewer v3.2 (автоопределение транскрипции, исправление обогащения контекстов через переводы строк, пересчёт marker_pos, исправление битого симлинка аудио)
- **v4.5.0** (2026-01-25) — Реорганизация структуры проекта: папка Оригинал/ с подпапками Главы/ и Аудио/, папка Транскрибации/ для сохранённых транскрипций. Обновлены config.py (ORIGINAL_DIR, AUDIO_DIR, TRANSCRIPTIONS_DIR), web_viewer.py (автоопределение файлов в новой структуре), batch_pipeline.py (fallback пути)
- **v4.4.0** (2026-01-25) — Golden Filter v4.4: эксперимент с битрейтами (16/32/48/96 kbps — качество распознавания не зависит от битрейта), фильтр разбиения дефисных слов (27 паттернов: что-то→«что то», как-то, кто-то, где-то, когда-то, какой-то, по-хорошему, по-разному и др.), новые YANDEX_TYPICAL_ERRORS (из→изза, сходу→ходу, слух→вслух), «так» в alignment_artifacts. Улучшение: -30 ложных ошибок на новых транскрибациях. Результат: 31/31 на 6 транскрибациях
- **v4.3.0** (2026-01-25) — Golden Filter v4.3: автозагрузка словаря имён (549 базовых → 9460 форм), фильтр grammar_ending_verb_number для глаголов 3 лица (заметят↔заметит), расширенный case_form (-ей↔-и), защита местоимений в Левенштейне (нас↔вас), новые паттерны (жетон↔вот, ранга↔недоранга). Тест на 3 транскрибациях: 31/31 на всех. Результат: 423→50-60 ошибок
- **v4.0.0** (2026-01-24) — Golden Filter v4.0: анализ 74 ложных ошибок, новые омофоны (ах↔ох, думая↔думаю), 60+ паттернов YANDEX_TYPICAL_ERRORS, фильтр is_prefix_variant(), улучшенный фильтр коротких слов, защита важных союзов (а↔и). Золотой стандарт расширен до 31 ошибки. Результат: 423→63 ошибок
- **v3.16.0** (2026-01-24) — Добавлена система логирования: LogConfig, setup_logging(), get_logger(), cleanup_old_logs() в config.py; флаги --verbose/--quiet/--version в pipeline.py v2.1
- **v3.15.0** (2026-01-24) — Интеграция с config.py завершена: унифицированы паттерны (HAS_CONFIG, TEMP_DIR, FileNaming, --force, --version), morphology.py v2.0, cache_manager.py v2.0, text_processor.py DEPRECATED
- **v3.14.0** (2026-01-24) — Аудит модулей: golden_filter.py v3.5, filter_errors.py v2.0, smart_compare.py v3.0, batch_pipeline.py v2.0
- **v3.13.0** (2026-01-24) — Интеграция text_normalizer.py v2.0 с config.py
- **v3.12.0** (2026-01-24) — YandexCloudConfig, transcribe.py v3.0, audio_converter.py v2.0
- **v3.11.0** (2026-01-24) — Оптимизация web_viewer.py v3.0, ротация логов, автоопределение файлов
- **v3.10.0** (2026-01-24) — Создан config.py, FileNaming, исправлена потеря коротких слов
- **v3.9.0** (2026-01-24) — Исправлена десинхронизация original_text, автоопределение phantom
- **v3.8.0** (2026-01-24) — Улучшена фильтрация имён персонажей: прозвища, 95 ошибок
- **v3.7.0** (2026-01-24) — Фильтр split_name_insertion, цепочки смещения
- **v3.6.0** (2026-01-24) — Интеграция словаря имён (522→9271 форм), 100% золотой стандарт
- **v3.5.0** (2026-01-23) — Фильтры split_name, compound_prefix, split_compound
- **v3.3.0** (2026-01-23) — morphology.py, batch_pipeline.py, retry-логика
- **v3.2.0** (2026-01-23) — Новые омофоны (я↔и, а↔но, то↔ты): 53→43 ошибок
- **v3.1.0** (2026-01-23) — Оптимизация фильтрации: 99→53 ошибок
- **v2.0.0** (2026-01-23) — Восстановление проекта, умное сравнение
- **v1.0.0** — Исходная версия
