# Проверка аудиокниг через Яндекс SpeechKit

**Версия:** 14.2.0 | **Дата:** 2026-01-31

> Полная документация: `Документация/Архив/PROJECT_FULL.md`

## Текущие показатели

| Метрика | Значение |
|---------|----------|
| **Golden** | 127/127 ✓ |
| **Всего ошибок** | 457 (5 глав) |
| **FP** | 330 |
| **ML v2.0 признаков** | 31 (было 22) |
| **SemanticManager защитил** | 77 |
| **Костылей** | 0 |

### Сравнение версий

```bash
python Инструменты/version_table.py
python Инструменты/version.py  # Версии всех модулей
```

| Версия | Дата | Filter | Гл.1 | Гл.2 | Гл.3 | Гл.4 | Гл.5 | Всего |
|--------|------|--------|------|------|------|------|------|-------|
| v5.7.2 | 25.01 | 5.7.0 | 62 | 46 | 88 | — | — | 196 |
| v12.0.0 | 30.01 | 9.2.0 | 77 | 50 | 74 | 45 | — | 246 |
| v14.1.0 | 31.01 | 9.7.0 | 86 | 78 | 115 | 57 | 121 | 457 |
| **v14.2.0** | 31.01 | **9.8.0** | **86** | **78** | **115** | **57** | **121** | **457** |

### База данных ошибок

Все ошибки хранятся в `Словари/false_positives.db` с метриками:
- Морфология: лемма, POS, same_lemma, same_pos
- Семантика: semantic_similarity (Navec 300d)
- Частотность: frequency (НКРЯ)
- Статус: is_golden, is_filtered, filter_reason

## Архитектура v14.2.0

```
Аудио → Яндекс SpeechKit → Транскрипция
                               ↓
Оригинал → Нормализация → Умное сравнение → Фильтрация → Ошибки
                               ↓                ↓
                        JSON / DOCX / Веб    27+ уровней фильтрации
                                                    ↓
                                             Context Verifier (4 уровня)
```

### Context Verifier v4.0

Модуль контекстной верификации с 4 уровнями проверки:

| Уровень | Метод | Назначение | FP |
|---------|-------|------------|-----|
| 1 | anchor_verification | Якорные слова ±2 позиции | 4 |
| 2 | morpho_coherence | Согласование морфологии | 3 |
| 3 | semantic_coherence | Семантическая связность | 0 |
| 4 | phonetic_morphoform | same_lemma + same_phonetic | 33 |
| **Итого** | | | **40** |

### Ключевые модули

| Модуль | Версия | Назначение |
|--------|--------|------------|
| version.py | v1.0 | Единый источник версий |
| smart_compare.py | v10.6 | Посегментное выравнивание |
| **engine.py** | **v9.8.0** | **Фильтрация (27+ уровней) + модульные правила** |
| **ml_classifier.py** | **v2.0.0** | **ML с контекстными признаками (31 признак)** |
| **context_verifier.py** | **v4.1** | **Контекстная верификация (4 уровня)** |
| comparison.py | v6.2 | Сравнение + phonetic_normalize |
| **filters/rules/** | **v1.1** | **Модульные правила (insertion, deletion, substitution)** |
| **filters/__init__.py** | **v8.3** | **Публичный API + инфраструктура рефакторинга** |
| **config.py** | **v1.0** | **Централизованные пороги (FilterConfig)** |
| **dependencies.py** | **v1.0** | **Менеджер зависимостей** |
| **extractors.py** | **v1.0** | **Экстракторы данных из ошибок** |
| deprecated_filters.py | v1.0 | Архив отключённых фильтров |
| SemanticManager | v2.0 | Семантика (Navec 500K слов) |
| SmartScorer | v3.0 | Накопительный скоринг |
| MorphoRules | v1.2 | Морфологические правила |
| FrequencyManager | v1.0 | Частотный словарь НКРЯ |

### Изменения в v14.x

| Версия | Изменения |
|--------|-----------|
| **v14.2.0** | **Рефакторинг: config.py, dependencies.py, extractors.py, rules/insertion\|deletion\|substitution.py** |
| v14.1.0 | ML-классификатор v2.0 с контекстными признаками (31 вместо 22) |
| v14.0.0 | Глубокий аудит + исправление статистики filter_errors() |
| v13.0.1 | Перефильтрация + унификация форматов (-30 FP) |
| v12.6.0 | Context Verifier v4.0 — 4 уровня контекстной фильтрации |

## Быстрый старт

```bash
# Полный пайплайн
python Инструменты/pipeline.py глава.mp3 оригинал.docx

# С веб-интерфейсом
python Инструменты/pipeline.py глава.mp3 оригинал.docx --web

# Тесты
python Тесты/run_full_test.py           # все главы
python Тесты/run_full_test.py --clean   # чистое тестирование
pytest -v                                # unit-тесты

# Версии
python Инструменты/version.py            # текущие версии
python Инструменты/version_table.py      # история версий
```

## Структура проекта

```
Яндекс Спич/
├── Инструменты/
│   ├── pipeline.py          # Полный пайплайн
│   ├── smart_compare.py     # Умное сравнение v10.6
│   ├── version.py           # Единый источник версий
│   ├── version_table.py     # Таблицы версий
│   ├── filters/
│   │   ├── __init__.py      # Публичный API v8.3
│   │   ├── engine.py        # Движок фильтрации v9.8
│   │   ├── comparison.py    # Сравнение + phonetic_normalize v6.2
│   │   ├── config.py        # Конфигурация и пороги v1.0 (NEW)
│   │   ├── dependencies.py  # Менеджер зависимостей v1.0 (NEW)
│   │   ├── extractors.py    # Экстракторы данных v1.0 (NEW)
│   │   ├── rules/           # Модульные правила v1.1
│   │   │   ├── __init__.py     # Экспорты (41 функция)
│   │   │   ├── protection.py   # HARD_NEGATIVES, semantic_slip
│   │   │   ├── phonetics.py    # Фонетические пары, и↔я
│   │   │   ├── alignment.py    # Артефакты выравнивания
│   │   │   ├── insertion.py    # Insertion правила v1.0 (NEW)
│   │   │   ├── deletion.py     # Deletion правила v1.0 (NEW)
│   │   │   └── substitution.py # Substitution правила v1.0 (NEW)
│   │   ├── morpho_rules.py     # Морфология v1.2
│   │   ├── semantic_manager.py # Navec семантика v2.0
│   │   ├── smart_scorer.py     # Накопительный скоринг v3.0
│   │   ├── frequency_manager.py # Частотный словарь v1.0
│   │   └── scoring_engine.py   # Защита имён v1.2
│   ├── false_positives_db.py
│   └── ...
├── Тесты/
│   ├── run_full_test.py     # Полный тест v6.3
│   ├── versions.json        # Единый источник метрик
│   ├── История/             # Архив прогонов
│   ├── золотой_стандарт_глава*.json
│   └── ...
├── Словари/
│   ├── Словарь_имён_персонажей.txt
│   ├── frequency_dict.json  # Частотный словарь НКРЯ
│   └── false_positives.db
├── Результаты проверки/
├── PROJECT.md
├── ROADMAP.md
└── CHANGELOG.md
```

## Принципы фильтрации

1. **Консервативность** — при сомнении НЕ фильтруем
2. **Golden = 100%** — ни одна реальная ошибка не должна быть отфильтрована
3. **Грамматика = реальная ошибка** — разные леммы/падежи/числа = реальные ошибки чтеца
4. **Без хардкодов** — правила работают на любых данных

### Ключевое правило

**Одинаковая лемма НЕ означает ложную ошибку!**

Если лемма одинаковая, но есть грамматические различия — это РЕАЛЬНАЯ ошибка:
- `сотни → сотня` — разное число
- `теряю → теряя` — VERB → GRND
- `получится → получилось` — разный вид
- `ключ → ключа` — разный падеж

## Типы ошибок

- **substitution** — замена слова (ЖИВЁМ → живы)
- **insertion** — лишнее слово
- **deletion** — пропуск слова
- **transposition** — перестановка (ТЫ ЧТО → что ты)

## Установка

**Рекомендуемый способ (PEP 517):**
```bash
# Создать виртуальное окружение
python3 -m venv venv
source venv/bin/activate

# Установить пакет в режиме разработки
pip install -e .

# Проверить установку
python -c "from Инструменты import filters; print(filters.__version__)"
```

**Альтернатива (ручная установка зависимостей):**
```bash
pip install pymorphy3 thefuzz python-docx num2words navec rapidfuzz boto3 requests pydub
```

**pyproject.toml:**
- version: 14.1.0
- requires-python: >=3.10
- build-backend: setuptools.build_meta

---

*Версия: 14.2.0 (2026-01-31)*
