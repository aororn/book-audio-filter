# Changelog

## [9.3.0] - 2026-01-29

### v9.3 — Исправление бага монотонности якорей

**Цель:** Исправить аномалию в Главе 2 (1222 ошибки вместо ~70).

#### Проблема

При выравнивании Главы 2 обнаружена аномалия:
- Ожидалось: ~70 ошибок
- Фактически: **1222 ошибки** (1318 insertions!)

**Причина:** В `AlignmentManager.find_anchor_points()` отсутствовала проверка монотонности `trans_idx`.

Слово "стражи" встречалось по 1 разу в обоих текстах, но в **разных контекстах**:
- Оригинал: "старейшина **стражи** прошу" (позиция 4655)
- Транскрипция: "наемников **стражи** учеников" (позиция 3313)

Яндекс неправильно распознал "стражей" → "стражи". Это создало якорь с "прыжком назад" на 1300 позиций, что привело к сегменту с 1307 ложными insertions.

#### Решение

Добавлен метод `_filter_monotonic()` в `AlignmentManager v1.2.0`:

```python
def _filter_monotonic(self, anchors: List[AnchorPoint]) -> List[AnchorPoint]:
    """Фильтрует якоря, оставляя только монотонную последовательность."""
    if len(anchors) <= 1:
        return anchors
    result = [anchors[0]]
    for anchor in anchors[1:]:
        if anchor.trans_idx > result[-1].trans_idx:
            result.append(anchor)
    return result
```

#### Результаты

| Глава | Golden | Ошибок (было) | Ошибок (стало) |
|-------|--------|---------------|----------------|
| 1 | 31/31 ✓ | 92 | 92 |
| 2 | 21/21 ✓ | **1222** | **62** |
| 3 | 20/20 ✓ | 118 | 118 |
| 4 | 21/21 ✓ | 56 | 56 |
| **ИТОГО** | **93/93** | **1488** | **328** |

#### Файлы изменены
- `Инструменты/alignment_manager.py` v1.1 → v1.2 (добавлен `_filter_monotonic()`)

---

## [9.2.0] - 2026-01-29

### v9.2 — Полная интеграция всех модулей

**Цель:** Интеграция и настройка всех экспериментальных модулей v9.0 для стабильной работы.

#### Интегрированные модули

| Модуль | Версия | Где интегрирован | Назначение |
|--------|--------|------------------|------------|
| **AlignmentManager** | v1.1 | smart_compare.py | Макро-выравнивание через якоря |
| **ComparisonStitcher** | v1.1 | smart_compare.py | Склейка разбитых слов + PROTECTED_SHORT_WORDS |
| **WindowVerifier** | v1.0 | smart_compare.py | Контекстная верификация ≥95% |
| **ScoringEngine** | v1.2 | smart_compare + engine.py | Адаптивные штрафы, защита имён |
| **MorphoRules** | v1.1 | engine.py | Консервативная морфологическая фильтрация |
| **CharacterGuard** | v1.0 | scoring_engine.py | Защита 9488 форм имён персонажей |

#### Изменения

1. **WindowVerifier интегрирован в smart_compare.py v10.1**
   - Проверяет контекст ±3 слова без пробелов
   - Схожесть ≥95% → TECHNICAL_OK (можно скрыть)
   - Консервативный подход: при сомнениях показывать человеку

2. **ScoringEngine интегрирован в engine.py v8.1**
   - Добавлен УРОВЕНЬ -1: защита HARD_NEGATIVES
   - `is_hard_negative()` проверяется до всех правил фильтрации
   - Имена персонажей НЕ фильтруются

3. **HARD_NEGATIVES очищены (v1.2)**
   - Было: 100+ пар (включая грамматические — костыль!)
   - Стало: 3 пары ТОЛЬКО имён персонажей
   - Архитектура: грамматика → MorphoRules, имена → HARD_NEGATIVES
   - Пары: `джейра→вчера`, `рагедон↔рагидон`

4. **Исправлен баг загрузки имён (detectors.py)**
   - Комментарии (#) теперь пропускаются при парсинге
   - Было: "и" попадало в FULL_CHARACTER_NAMES из комментария
   - Стало: только реальные имена загружаются

5. **MorphoRules проверены**
   - Все golden ошибки корректно НЕ фильтруются
   - Разная лемма/число/падеж/POS/время → защита

#### Результаты

| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 ✓ | 99 |
| 2 | 21/21 ✓ | 73 |
| 3 | 20/20 ✓ | 124 |
| 4 | 21/21 ✓ | 61 |
| **ИТОГО** | **93/93** | **357** |

#### Файлы изменены
- `Инструменты/smart_compare.py` v10.0 → v10.1 (WindowVerifier)
- `Инструменты/filters/engine.py` v8.0 → v8.1 (ScoringEngine)
- `Инструменты/filters/scoring_engine.py` v1.0 → v1.2 (очистка HARD_NEGATIVES)
- `Инструменты/filters/detectors.py` (исправлен парсинг комментариев)

---

## [10.0.0] - 2026-01-29

### v10.0 — Полное посегментное выравнивание

**Цель:** Полный переход от полнотекстового SequenceMatcher к макро/микро выравниванию через якоря.

#### Изменения

1. **compare_with_anchors()** — новая функция посегментного сравнения
   - SequenceMatcher выполняется на каждом сегменте отдельно
   - Индексы opcodes корректируются на глобальные позиции
   - Якоря явно добавляются как 'equal' opcodes (решена проблема пропуска)

2. **merge_adjacent_opcodes()** — объединение смежных opcodes
   - После посегментного сравнения объединяет opcodes с одинаковым тегом
   - Необходимо для корректной обработки границ сегментов

3. **AlignmentManager v1.1** — новые методы
   - `refine_large_segments()` — разбивает сегменты >100 слов суб-якорями
   - `check_density()` — проверяет плотность сегментов (>15% — аномалия)

4. **Интеграция в smart_compare()**
   - Автоматическое использование посегментного режима при наличии якорей
   - Fallback на полнотекстовый режим если якоря не найдены
   - Вывод режима выравнивания в лог

#### Алгоритм
```
1. Найти якоря (уникальные слова >6 символов)
2. Разбить на сегменты по якорям
3. Если сегмент >100 слов → найти суб-якоря
4. SequenceMatcher на каждый сегмент
5. Добавить якоря как 'equal' opcodes
6. Объединить и отсортировать opcodes
```

#### Результаты

| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 ✓ | 99 |
| 2 | 21/21 ✓ | 73 |
| 3 | 20/20 ✓ | 124 |
| 4 | 21/21 ✓ | 61 |
| **ИТОГО** | **93/93** | **357** |

#### Файлы изменены
- `Инструменты/smart_compare.py` v10.0 — посегментное выравнивание
- `Инструменты/alignment_manager.py` v1.1 — refine_large_segments(), check_density()

---

## [9.1.0] - 2026-01-29

### v9.1 — Исправлена регрессия v9.0

**Проблема:** ComparisonStitcher ошибочно склеивал короткие служебные слова (частицы, предлоги, союзы) с соседними словами. Например, "кто" + "то" → "ктото" приводило к потере insertion ошибки "ТО".

#### Изменения

1. **ComparisonStitcher v1.1** (`smart_compare.py`)
   - Добавлен `PROTECTED_SHORT_WORDS` — 27 защищённых слов
   - Защищённые слова: `то, по, на, за, от, до, ни, не, бы, же, ли, и, а, я, у, о, в, к, с, ещё, еще, уже, вот, вон, тут, там`
   - Эти слова НЕ склеиваются с соседними (могут быть insertion ошибками)

2. **Золотой стандарт глава 4**
   - Удалена ложная ошибка "→по" @ 13:42 (слово "по" присутствует и в оригинале, и в транскрипции)
   - total_errors: 22 → 21

#### Результаты

| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 ✓ | 99 |
| 2 | 21/21 ✓ | 73 |
| 3 | 20/20 ✓ | 124 |
| 4 | 21/21 ✓ | 61 |
| **ИТОГО** | **93/93** | **357** |

#### Файлы изменены
- `Инструменты/smart_compare.py` v9.1 — PROTECTED_SHORT_WORDS
- `Тесты/золотой_стандарт_глава4.json` — удалена ложная ошибка

---

## [Тесты v6.0.0] - 2026-01-29

### run_full_test.py v6.0 — Архивирование прогонов

Обновление тестовой инфраструктуры для сохранения истории всех прогонов.

#### Новые возможности
- **Папка `Тесты/История/`** — архив прогонов с отдельными JSON файлами
- **Автоопределение версии фильтров** — читает версию из `engine.py`
- **Автоопределение версии smart_compare** — читает VERSION из файла
- **Поддержка главы 4** — добавлена в список глав
- **Новые команды:**
  - `--versions` — сводка результатов по версиям фильтров
  - `--archive` — список файлов в архиве

#### Формат записей
```json
{
  "timestamp": "2026-01-29T17:46:26",
  "test_version": "6.0.0",
  "filter_version": "8.0",
  "smart_compare_version": "8.0.0",
  "chapters_tested": ["1", "2", "3", "4"],
  "results": {...},
  "summary": {...},
  "comment": "..."
}
```

#### Файлы изменены
- `Тесты/run_full_test.py` — v5.2.0 → v6.0.0
- Новая папка: `Тесты/История/`

---

## [9.0.0] - 2026-01-29 (ЭКСПЕРИМЕНТАЛЬНАЯ)

### v9.0 — Система якорей (РЕГРЕССИЯ)

Экспериментальное обновление системы сравнения. **Выявлена регрессия:**
- Golden: 91/94 (вместо 94/94) — потеряны 3 ошибки
- FP: 414 (вместо 356) — +16% ложных срабатываний

#### Созданные модули (требуют доработки)

1. **CharacterGuard** (`filters/character_guard.py`) v1.0.0
   - Защита 9488 форм имён персонажей
   - Методы: `is_character()`, `is_anchor_candidate()`, `get_penalty()`

2. **ComparisonStitcher** (в `smart_compare.py`)
   - Склейка разбитых слов: "средо" + "точие" → "средоточие"
   - Нормализация дефисов

3. **AlignmentManager** (`alignment_manager.py`) v1.0.0
   - Посегментное выравнивание через якоря
   - Проблема: теряет некоторые ошибки на границах сегментов

4. **ScoringEngine** (`filters/scoring_engine.py`) v1.0.0
   - Адаптивные штрафы

5. **WindowVerifier** (`filters/window_verifier.py`) v1.0.0
   - Верификация сегментов

#### Пропущенные golden ошибки
- Глава 1: "ТО" (insertion @ 9:03), "услышал→услышав" (@ 55:25)
- Глава 4: "→по" (insertion @ 13:42)

#### Статус
**НЕ РЕКОМЕНДУЕТСЯ К ИСПОЛЬЗОВАНИЮ.** Текущая рабочая версия: v8.1.1

---

## [8.1.1] - 2026-01-29

### Исправлен баг с именами собственными

**Проблема:** pymorphy3 ошибочно определял слова типа "когдато" (слитное "когда-то") как имена собственные. Это приводило к фильтрации реальных ошибок правилом `morpho_proper_name`.

**Решение:** В `morpho_rules.py` исправлена функция `_is_proper_name()`:
- Добавлена проверка на составные слова (суффиксы: то, либо, нибудь, таки, ка, де, мол)
- Добавлена проверка score pymorphy (должен быть > 0.5)

**Результат:**
- Golden тесты: **72/72** (100%) ✓
- Исправлена ошибка `какого→когда` (глава 3, 43:16)

### Файлы изменены
- `Инструменты/filters/morpho_rules.py` — v1.0.0 → v1.1.0

---

## [8.1.0] - 2026-01-29

### Переход на pymorphy3

**Проблема:** pymorphy2 не совместим с Python 3.14 (удалён `inspect.getargspec`).

**Решение:**
- Установлен pymorphy3 v2.0.6
- Обновлены импорты в 3 файлах с fallback на pymorphy2

### Файлы изменены
- `Инструменты/morphology.py`
- `Инструменты/filters/comparison.py`
- `Инструменты/proper_names_extractor.py`

---

## [8.0.0] - 2026-01-26

### Консервативная фильтрация — morpho_rules.py

Новый единый модуль `morpho_rules.py` заменяет `smart_rules.py` и `learned_rules.py`.

**Принцип:** Фильтруем ТОЛЬКО если 100% уверены в ложной ошибке. При любом сомнении — НЕ фильтруем.

**Правила:**
1. Разные леммы → НЕ фильтровать (разные слова)
2. Разная часть речи → НЕ фильтровать (VERB↔GRND = реальная ошибка)
3. Разное число → НЕ фильтровать (сотни/сотня = реальная ошибка)
4. Разный падеж → НЕ фильтровать (преграды/преград = реальная ошибка)
5. Разное время → НЕ фильтровать (получится/получилось = реальная ошибка)
6. Приставка по- → НЕ фильтровать (больше/побольше = реальная ошибка)
7. Одинаковая форма → ФИЛЬТРОВАТЬ

---

## [7.0.0] - 2026-01-26

### Learned Rules — обученные правила на данных

Новый модуль `learned_rules.py` содержит правила, **обученные на 614 парах данных**:
- 70 реальных ошибок (golden tests)
- 544 ложных ошибок (отфильтрованных v5.7)

#### Ключевые инсайты из данных

| Признак | % ложных ошибок | Решение |
|---------|-----------------|---------|
| `any_name` | 100% | Фильтровать |
| `same_phonetic + same_pos` | 98% | Фильтровать |
| `same_lemma` | 89% | Фильтровать |
| `verb_grnd` (VERB↔GRND) | 74% | **НЕ фильтровать** — много реальных! |
| `different_num` | 15% | **НЕ фильтровать** — реальная ошибка |

#### Правила в learned_rules.py v1.0.0

**Защита (НЕ фильтровать):**
1. `verb_grnd_protected` — VERB↔GRND (теряю/теряя, делать/делая)
2. `different_num_protected` — разное число при одной лемме

**Фильтрация:**
3. `name` — имена собственные (100% FP)
4. `phonetic` — фонетически идентичные + одинаковый POS (98% FP)
5. `lemma` — одинаковая лемма (89% FP)
6. `similar_lemma` — близкие леммы (Левенштейн ≤ 1)

#### Результаты

| Глава | Golden | v5.7 | v7.0 | Ложные v5.7 | Ложные v7.0 | Δ |
|-------|--------|------|------|-------------|-------------|---|
| 01 | 31 | 65 | 62 | 34 | 31 | -3 |
| 02 | 21 | 48 | 41 | 27 | 20 | -7 |
| 03 | 20 | 84 | 80 | 64 | 60 | -4 |
| 04 | 22 | 32 | 25 | 10 | 3 | -7 |
| **ИТОГО** | **94** | **229** | **208** | **135** | **114** | **-21** |

**Улучшение:** -21 ложная ошибка (-15.5%)
**Golden tests:** 94/94 (100%) — ни одна реальная ошибка не потеряна

#### Learned Rules статистика

| Правило | Срабатываний |
|---------|--------------|
| `learned_lemma` | 363 |
| `learned_name` | 326 |
| `learned_similar_lemma` | 270 |
| `learned_phonetic` | 166 |
| `learned_identical` | 4 |
| **Всего learned_rules** | **1129** |

---

## [6.1.0] - 2026-01-26

### Smart Rules v2.0 — полная замена старых правил

Smart Rules теперь **полностью заменяют** старые статические правила вместо дополнения их.

#### Изменения в smart_rules.py v2.0.0

**Новые правила, заменяющие старые:**
| Новое правило | Заменяет | Описание |
|---------------|----------|----------|
| `smart_lemma` | `same_lemma` | Одинаковая лемма с проверками |
| `smart_homophone` | `homophone` | Фонетическая идентичность |
| `smart_levenshtein` | `levenshtein_similar_lemma`, `levenshtein_same_lemma` | Близкие леммы по Левенштейну |
| `smart_grammar` | `grammar_ending` | Грамматические окончания |

**Защита от ложной фильтрации:**
- Разное число (сотни/сотня) — реальная ошибка
- Разный падеж (преграды/преград) — реальная ошибка
- Разное время глаголов (получилось/получится) — реальная ошибка
- Приставка "по-" (больше/побольше) — реальная ошибка
- VERB↔GRND (делая/делать) — реальная ошибка

#### Изменения в engine.py v6.1.0

**Отключены старые правила:**
- `homophone` → заменено на `smart_homophone`
- `same_lemma` → заменено на `smart_lemma`
- `grammar_ending` → заменено на `smart_grammar`
- `levenshtein_same_lemma` → заменено на `smart_levenshtein`
- `levenshtein_similar_lemma` → заменено на `smart_levenshtein`
- `prefix_variant` → заменено на `smart_prefix`

**Smart Rules теперь на УРОВНЕ 0** — применяются первыми для substitution.

#### Результаты golden тестов

| Глава | v6.0.1 | v6.1.0 |
|-------|--------|--------|
| 1 | 31/31 | **31/31** ✓ |
| 2 | 21/21 | **21/21** ✓ |
| 3 | 20/20 | **20/20** ✓ |
| 4 | — | **22/22** ✓ |
| **Итого** | 72/72 | **94/94 (100%)** ✓ |

#### Smart Rules статистика

| Правило | Срабатываний | % |
|---------|--------------|---|
| `smart_levenshtein` | 300 | 9.6% |
| `smart_lemma` | 217 | 6.9% |
| `smart_homophone` | 166 | 5.3% |
| `smart_prefix` | 22 | 0.7% |
| `smart_participle` | 17 | 0.5% |
| `smart_aspect_pair` | 11 | 0.4% |
| **Всего smart_rules** | **743** | **23.6%** |

**Улучшение:** с 3.4% до 23.6% — в 7 раз больше!

---

## [6.0.1] - 2026-01-26

### Исправления smart_rules после тестирования

После прогона на golden стандартах выявлены и исправлены проблемы:

#### smart_rules.py v1.1.0

**Исправления:**
1. **Фонетический порог повышен с 85% до 95%** — предотвращает ложную фильтрацию похожих, но разных слов
2. **Проверка леммы в phonetic** — если леммы разные, фонетическое сходство не учитывается
3. **Проверка падежа и числа** — если одна лемма, но разный падеж/число, это реальная ошибка
4. **Убрана фильтрация "супплетивных видовых пар"** — только пары с одной основой (делать/сделать)

**Удалены из YANDEX_TYPICAL_ERRORS (реальные ошибки чтеца):**
- `ощущал ↔ ощутил` — разные глаголы
- `договаривались ↔ договорились` — разные глаголы
- `мыслеречью ↔ мыслью` — авторское слово vs обычное
- `нибудь ↔ то` — замена частицы

#### Результаты golden тестов

| Глава | До | После |
|-------|-----|-------|
| 1 | 23/31 | **31/31** ✓ |
| 2 | 16/21 | **21/21** ✓ |
| 3 | 19/20 | **20/20** ✓ |
| **Итого** | 58/72 (80.5%) | **72/72 (100%)** ✓ |

#### Smart Rules статистика

После исправлений smart_rules стали менее агрессивными:
- `smart_phonetic`: 1285 → 38 срабатываний (правильно!)
- Всего smart_rules: 1360 → 115 (3.3% от отфильтрованных)

---

## [6.0.0] - 2026-01-26

### Масштабное обновление: Умные правила и ML-классификатор

Реализован 6-фазный план улучшения системы фильтрации с переходом от статических списков к алгоритмическим правилам и машинному обучению.

#### Фаза 0: Унификация инфраструктуры

**false_positives_db.py** — новые CLI-команды:
- `update-morph` — обновление морфологических данных в БД (lemma, POS, aspect)
- `mark-golden` — пометка паттернов как golden (верифицированные ошибки)
- `ml-stats` — статистика для ML (распределение классов)
- `export-features` — экспорт признаков для обучения ML в CSV

#### Фаза 1: Расширение морфологии (morphology.py v6.0.0)

Новые функции для анализа глаголов:
- `get_aspect(word)` — возвращает вид глагола ('perf'/'impf')
- `get_voice(word)` — возвращает залог ('actv'/'pssv')
- `get_tense(word)` — возвращает время ('past'/'pres'/'futr')
- `is_aspect_pair(word1, word2)` — проверяет видовую пару (делать/сделать)
- `is_same_verb_base(word1, word2)` — проверяет общую основу глагола

Новый тип `VerbInfo = Tuple[Optional[str], Optional[str], Optional[str]]`

#### Фаза 2: Умные правила (filters/smart_rules.py v1.0.0) — НОВЫЙ МОДУЛЬ

Класс `SmartRules` с алгоритмическими правилами вместо статических списков:

| Правило | Описание | Пример |
|---------|----------|--------|
| `aspect_pair` | Видовые пары глаголов | делать↔сделать |
| `safe_case` | Безопасные падежные вариации | книги↔книге |
| `reflexive` | Возвратные формы | мыть↔мыться |
| `participle` | Причастия от глаголов | читать↔читающий |
| `numeral` | Числительные | два↔двое |
| `prefix` | Приставочные варианты | ходить↔уходить |
| `phonetic` | Фонетическое сходство | здравствуй↔здраствуй |

Функция `phonetic_normalize(word)` — нормализация с учётом русской фонетики:
- Непроизносимые согласные (солнце→сонце, сердце→серце)
- Редукция гласных (о→а в безударной позиции)
- Оглушение/озвончение согласных

#### Фаза 3: Рефакторинг engine.py (v6.0)

Интеграция smart_rules в пайплайн фильтрации:
- Новый уровень **2.5: Smart Rules** между уровнями 2 и 3
- Автоматическое применение алгоритмических правил до основных проверок
- Метки фильтрации: `smart_aspect_pair`, `smart_safe_case`, `smart_phonetic` и др.

#### Фаза 4: Улучшение smart_compare.py (v6.0.0)

- Интеграция smart_rules для раннего обнаружения ложных срабатываний
- Использование `phonetic_normalize` из smart_rules
- Confidence threshold 0.9 для автоматической фильтрации

#### Фаза 5-6: ML-классификатор (ml_classifier.py v1.0.0) — НОВЫЙ МОДУЛЬ

Класс `FalsePositiveClassifier` для машинного обучения:

**22 признака** для классификации пар слов:
- Длина слов, разница длин, соотношение длин
- Расстояние Левенштейна (абсолютное и нормализованное)
- Фонетическое расстояние и совпадение
- Совпадение лемм, расстояние между леммами
- Совпадение частей речи
- Грамматические признаки (число, падеж, род)
- Видовая пара глаголов
- Приставочные варианты
- Короткие слова, соотношение общих букв
- Совпадение первой/последней буквы
- Результат smart_rules

**Модели**: RandomForest, GradientBoosting, LogisticRegression

**Результаты обучения** (227 образцов):
- Test accuracy: 78.26%
- Модель сохранена в `fp_classifier.pkl`

#### Версии модулей

| Модуль | Версия |
|--------|--------|
| morphology.py | 6.0.0 |
| filters/smart_rules.py | 1.0.0 (новый) |
| filters/engine.py | 6.0.0 |
| filters/__init__.py | 6.0.0 |
| smart_compare.py | 6.0.0 |
| ml_classifier.py | 1.0.0 (новый) |

---

## [5.7.2] - 2026-01-26

### Массовое добавление паттернов из анализа главы 4

Проанализированы 63 ложных срабатывания главы 4, добавлено ~50 новых паттернов.

#### Новые паттерны в YANDEX_TYPICAL_ERRORS

**Грамматические вариации (21 пара):**
- Деепричастие ↔ другие формы: `умирая↔умирай`, `переделывая↔переделываю`, `веря↔верить`, `сказав↔сказал`
- Падежные вариации: `идей↔идеей`, `ладонь↔ладони`, `властелинов↔властелина`, `шей↔шеей`, `стражи↔стражу`
- Числовые вариации глаголов: `знает↔знают`, `проявятся↔проявится`
- Числовые вариации прилагательных: `вытянутой↔вытянутые`, `духовной↔духовные`

**Похожие леммы (13 пар):**
- `сторона↔страна`, `внутрь↔внутри`, `присягнувших↔посягнувших`
- `устранить↔устранять`, `сменил↔изменил`, `продавить↔придавить`
- `формаций↔информации`, `мыслеречь↔музлеречь`

**Усечения Яндекса (8 пар):**
- `так↔также`, `столб↔стол`, `непросто↔не`, `неважно↔не`
- `властелина↔власт`, `тер↔терпимо`, `глава↔бла`

**Артефакты выравнивания:**
- `за↔заплевываю`, `в↔валом`, `поместье↔поместья`

#### Артефакты удаления

Добавлены в ALIGNMENT_ARTIFACTS_DEL: `под`, `плевую`, `алом`, `их`

#### Результаты

| Глава | Golden | v5.7.1 | v5.7.2 | Δ ложных |
|-------|--------|--------|--------|----------|
| 1 | 31/31 ✓ | 62 | 62 | 0 |
| 2 | 21/21 ✓ | 50 | 46 | -4 |
| 3 | 20/20 ✓ | 79 | 88 | +9 |
| 4 | 22/22 ✓ | 91 | 28 | **-63** |
| **Итого** | **94/94** | 282 | 224 | **-58** |

---

## [5.7.1] - 2026-01-25

### Исправления фильтров (Golden Standard Chapter 4)

Создан и успешно пройден **Золотой Стандарт Глава 4** — набор из 22 верифицированных ошибок чтеца.

#### Исправленные фильтры

- **alignment_artifact** — удалены "да" и "бы" из списка артефактов:
  - `да` — "да и не такая уж" — реальный пропуск чтеца
  - `бы` — "мог бы вывесить" — реальный пропуск чтеца

- **grammar_ending_verb_number** — отключена фильтрация разного числа глаголов:
  - `будут → будет` — это реальная ошибка, меняющая смысл

- **same_lemma** — добавлена проверка приставки "по-":
  - `больше → побольше` — разные слова, реальная ошибка

- **levenshtein_protected** — добавлена проверка падежей:
  - `преграды → преград` (accs → gent) — реальная ошибка
  - `награда → награды` (nomn → gent) — реальная ошибка

- **levenshtein_similar_lemma** — добавлена проверка для прилагательных:
  - `большое (большой) → большее (больший)` — разные леммы = реальная ошибка
  - `вашу (ваш) → нашу (наш)` — разные леммы = реальная ошибка

#### Результаты

- **До**: 14/22 (63.6%)
- **После**: 22/22 (100%)
- Всего ошибок главы 4: 91 (было 78)

---

## [5.7.0] - 2026-01-25

### Архитектурные улучшения и унификация кода

#### Архитектура

- **ABC-интерфейс FilterRule** (`filters/base.py`) — расширяемый интерфейс для правил фильтрации:
  - Абстрактный класс `FilterRule` с методом `should_filter()`
  - `FilterContext` dataclass для передачи контекста
  - Реестр правил: `register_rule()`, `unregister_rule()`, `get_registered_rules()`
  - Приоритеты 0-19 для упорядочивания правил

- **Унификация `normalize_word()`** — единый источник правды:
  - `morphology.py` — канонический источник
  - `filters/comparison.py` — импорт с fallback
  - `smart_compare.py` — импорт с fallback
  - Устранено дублирование кода в 3 файлах

#### База ложных срабатываний

- **Миграция на SQLite** (`false_positives_db.py`):
  - 3 таблицы: patterns, occurrences, filter_rules
  - Автоклассификация паттернов (grammar_ending, phonetic, prefix_variant, short_word, compound_word, unknown)
  - CLI: stats, top, add, resolve, migrate, export, check-regressions, search
  - **197 паттернов** успешно мигрированы из JSON

#### Новые паттерны фильтрации

- **GRAMMAR_ENDINGS** — из топ-30 ложных срабатываний:
  - `ими↔им` (этими↔этим)
  - `ем↔ы` (живём↔живы)
  - `ая↔ал` (продолжая↔продолжал)
  - `о↔е` (громко↔громче)
  - `ой↔ые` (сложной↔сложные)
  - `ы↔ей` (предводителей↔предводителя)
  - `т↔ты` (талант↔таланты)

- **YANDEX_TYPICAL_ERRORS** — специфичные пары:
  - `ощущал↔ощутил`, `договаривались↔договорились`
  - `вас↔нас`, `что↔кто`
  - `нибудь↔то`, `мыслеречью↔мыслью`

- **SAFE_TRANSPOSITIONS** — перестановки слов:
  - `ты что↔что ты`, `он что↔что он`

#### Автоматизация

- **process_new_chapter.py** — скрипт полного цикла обработки:
  - Транскрипция аудио через Яндекс SpeechKit
  - Выравнивание с эталонным текстом
  - Генерация HTML-отчёта
  - Автосбор ложных срабатываний в SQLite
  - Режимы: --dry-run, --skip-transcribe, --skip-fp

#### Версия фильтров: 5.7.0

---

## [5.6.1] - 2026-01-25

### Исправления ложных срабатываний фильтров

#### Исправления

- **Увеличен порог verb_count с 2 до 3** для фильтра `yandex_i_ya_verb_context`:
  - Исправлено ложное срабатывание на реальной ошибке `я→и` в главе 3 (29:00)
  - Контекст: "небо молчало ну так **я** и не говорящий с небом" — 3 глагола, но ошибка реальная
  - Теперь фильтр срабатывает только при ≥3 глаголах в контексте

- **Добавлено исключение для наречий** в фильтре `levenshtein_similar_lemma`:
  - Наречия с разными леммами (сколько vs столько) больше не фильтруются
  - Исправлена ошибка `сколько→столько` в главе 2 (12:21), которая неправильно фильтровалась

#### Улучшения run_full_test.py

- **Динамический поиск filtered файлов** — теперь ищет по glob-паттерну `*_filtered.json` вместо фиксированного имени
- **Обновлены пути к транскрипциям** — актуальные файлы с датой 20260125

#### Результаты Golden тестов v5.6.1

| Глава | Золотые | Всего ошибок | Статус |
|-------|---------|--------------|--------|
| Глава 1 | 31/31 | 62 | ✓ PASSED |
| Глава 2 | 21/21 | 42 | ✓ PASSED |
| Глава 3 | 20/20 | 79 | ✓ PASSED |
| **ИТОГО** | **72/72** | **183** | **100%** |

- Все 370 unit-тестов проходят

---

## [5.6.0] - 2026-01-25

### Улучшенная фильтрация и новые инструменты

#### Исправления фильтрации
- **Автоопределение phantom_seconds** — batch_process_transcripts.py теперь использует `phantom_seconds=None` вместо жёстко заданного значения 5 секунд
  - Глава 1: автоопределение 17.7 сек (было пропущено ~50 phantom words)
  - Главы 2, 3: автоопределение 7.1-7.2 сек

- **Расширенная фильтрация я↔и** — контекстная проверка в engine.py:
  - После глаголов прошедшего времени (-л, -ла, -ло, -ли)
  - После возвратных глаголов (-сь, -ся)
  - После глаголов 1 лица (-ю, -у)
  - Перед глаголами 1 лица
  - В контексте с 2+ глаголами
  - Снижение false positives `я→и`: 32 → 10 случаев (70%)

- **Падежные ошибки Яндекса** — добавлены в YANDEX_TYPICAL_ERRORS:
  - печати↔печатей, записи↔записей
  - господина↔господин
  - порядками↔порядком
  - результата↔результаты
  - орденцем↔орденцам
  - молодая↔молодой

#### Результаты v5.6
- **Ошибок после фильтрации**: 531 → 422 (снижение на 20.5%)
- **Phantom words**: полностью устранены благодаря автоопределению
- **Все 370 тестов проходят**

#### Новые инструменты

**false_positives_tracker.py v1.0** — накопительный трекер ложных срабатываний:
- Накопление статистики с подсчётом частоты
- Автоисключение golden при добавлении
- Топ частых, решённые паттерны, проверка регрессий
- Экспорт CSV/JSON, автоклассификация

**batch_transcribe_from_bucket.py v1.0** — пакетная транскрибация из Yandex Object Storage:
- Прямая работа с файлами в бакете
- Автоопределение папки главы
- Unbuffered вывод для мониторинга

#### Обновлена документация
- Добавлен раздел "Workflow улучшения фильтров" в PROJECT.md
- Описан процесс накопительного учёта ложных срабатываний

---

## [5.5.0] - 2026-01-25

### Новые фильтры для снижения ложных срабатываний

#### Анализ 130 ложных срабатываний из 3 глав
- Проведён детальный анализ оставшихся не-golden ошибок
- Выявлены паттерны: ОКОНЧАНИЕ (51), ПОХОЖИЕ (31), КОРОТКИЕ (15), ВЛОЖЕННЫЕ (7), ПРОЧИЕ (6)

#### Новые фильтры v5.5
1. **Фильтр и↔я в безопасных контекстах** (`yandex_i_ya_boundary`, `yandex_i_ya_after_verb`):
   - После границы предложения (. ! ?)
   - После глагола прошедшего времени (-л, -ла, -ло, -ли)

2. **Фильтр удаления же/ли** (`yandex_particle_deletion`):
   - Частицы же/ли/ль после местоимений (я, ты, он, она...)
   - Частицы же/ли/ль после наречий (так, тут, там, ещё...)

3. **Фильтр вставки и/а перед деепричастием** (`yandex_conjunction_before_gerund`):
   - Вставка союзов "и"/"а" перед словами с POS=GRND
   - Fallback на суффиксы деепричастий (-ая, -яя, -ив, -ав, -ши, -вши)

#### Исправления регрессий
- **VERB→GRND не фильтруется** как `grammar_ending`:
  - Переход глагол→деепричастие (теряю→теряя) — настоящая ошибка чтеца
  - Добавлена проверка POS тегов перед фильтрацией

- **Исправлен duplicate_word_insertion**:
  - Проверка по отдельным словам, а не подстрокой
  - "кто то" больше не ложно срабатывает на паттерн "то то"

#### Результаты
- **Golden тест: 72/72** ошибок найдено (100%)
- Общее количество ошибок снижено: 200 (было ~265)

---

## [5.1.0] - 2026-01-25

### Оптимизация, инфраструктура, разделение модулей

#### Тесты
- **+35 тестов для smart_compare.py** (370 всего, было 341):
  - `parse_yandex_transcription` — парсинг JSON от Яндекса (7 тестов)
  - `parse_original_text` — парсинг TXT-файлов (5 тестов)
  - `detect_phantom_seconds` — автоопределение метаданных (4 теста)
  - `get_lemma` — лемматизация (2 теста)
  - Расширенные тесты транспозиций (3 теста)
  - Расширенные тесты fix_misaligned_errors (3 теста)
  - Расширенные тесты контекста (3 теста)
  - Интеграционный тест `smart_compare()` (2 теста: с ошибками + идентичные тексты)

#### Параллельная обработка
- **batch_pipeline.py**: флаг `--parallel` / `-P` для параллельной обработки глав
  - `ProcessPoolExecutor` с настраиваемым числом процессов (`--workers N`)
  - Обратная совместимость: по умолчанию работает последовательно
- **Режим «только новые главы»** (`--only-new`):
  - Пропускает главы, у которых `filtered.json` свежее исходных файлов
  - Аналог `make` — перезапуск обрабатывает только изменённые данные

#### Разделение web_viewer.py
- **Новый модуль `docx_export.py`** — генерация DOCX/TXT отчётов для чтеца:
  - Выделен из web_viewer.py (~290 строк)
  - Параметризованный API (output_dir, chapter_number, filename)
  - Внутреннее разделение: `_generate_docx`, `_add_error_to_docx`, `_format_context_in_docx`
  - TXT fallback если python-docx недоступен
- web_viewer.py делегирует генерацию DOCX в docx_export.py

#### Конфигурация через JSON
- **SmartCompareConfig** и **GoldenFilterConfig** загружаются из `Словари/config.json`
  - Изменение порогов и флагов без редактирования Python-кода
  - Defaults сохранены для обратной совместимости

#### Валидация входных данных
- **pipeline.py**: проверки перед запуском пайплайна:
  - Существование файлов (аудио и текст)
  - Не пустые файлы (0 байт)
  - Допустимые расширения (.mp3, .ogg, .opus, .wav для аудио; .docx, .txt для текста)
  - Целостность DOCX (парсится без ошибок, содержит текст)

#### Инфраструктура
- **`.gitignore`** — защита API-ключей, кэша, временных файлов
- **`Makefile`** — команды: test, lint, lint-fix, typecheck, coverage, check-chapter-1/2, batch, batch-parallel, clean
- **ruff** сконфигурирован в pyproject.toml (E, W, F, I, B, UP правила)
- **mypy** сконфигурирован в pyproject.toml (Python 3.8, check_untyped_defs)
- Добавлены dev-зависимости: ruff>=0.4.0, mypy>=1.8.0

---

## [5.0.0] - 2026-01-25

### Модульная архитектура, ABC-абстракции, расширенное тестирование

#### Модульная архитектура фильтрации
- **Разделение golden_filter.py** (~2100 строк) на пакет `filters/` с 4 модулями:
  - `filters/constants.py` — все словари и константы (HOMOPHONES, GRAMMAR_ENDINGS, WEAK_WORDS и др.)
  - `filters/comparison.py` — функции сравнения слов (normalize_word, levenshtein, is_homophone_match и др.)
  - `filters/detectors.py` — специализированные детекторы (имена, составные слова, цепочки смещения)
  - `filters/engine.py` — движок фильтрации (should_filter_error, filter_errors, filter_report)
- **Обратная совместимость**: `golden_filter.py` стал тонкой обёрткой, реэкспортирующей всё из `filters/`
- Все существующие импорты из `golden_filter` продолжают работать

#### ABC-абстракция транскрибации
- **Новый модуль `transcription_provider.py`** — абстрактный интерфейс `TranscriptionProvider`:
  - `YandexProvider` — обёртка над существующим `transcribe.py`
  - `MockProvider` — для unit-тестирования без внешних API
  - Реестр провайдеров: `register_provider()`, `get_provider()`, `list_providers()`
  - `TranscriptionResult` — унифицированный формат результата

#### Rate Limiting
- **Класс `RateLimiter`** добавлен в `transcribe.py` — алгоритм token bucket:
  - Ограничение 1 запрос/сек с burst=3
  - Автоматическая задержка при превышении лимита
  - Интеграция с `retry_request()` и обработка HTTP 429

#### Инфраструктура проекта
- **`requirements.txt`** — зависимости проекта (был полностью пропущен)
- **`pyproject.toml`** — конфигурация сборки, pytest, coverage
- **Удалён `filter_errors.py`** — deprecated модуль, заменённый `golden_filter.py`

#### Тестирование — 171 новых тестов (итого 341)
- **`test_filters_package.py`** (91 тест) — пакет filters/:
  - Версия, константы, нормализация, Левенштейн, омофоны
  - Грамматика, морфология, детекторы имён, составные слова
  - Контекстные артефакты, цепочки смещения
  - should_filter_error, filter_errors, filter_report
  - Обратная совместимость с golden_filter
- **`test_morphology.py`** (30 тестов) — модуль morphology.py:
  - Нормализация, лемматизация, POS/число/род/падеж
  - MorphCache (singleton, get/set, stats), кэширование
- **`test_config.py`** (50 тестов) — модуль config.py:
  - Пути проекта, FileNaming (stages, build, chapter_id, deprecated)
  - SmartCompareConfig, GoldenFilterConfig, YandexCloudConfig
  - Утилиты (format_duration, check_file_exists, cleanup_deprecated)
  - Логирование (setup_logging, get_logger, cleanup_old_logs)

#### Версионирование
- Все модули обновлены до VERSION = '5.0.0':
  - config.py, pipeline.py, batch_pipeline.py, cache_manager.py
  - morphology.py, smart_compare.py, proper_names_extractor.py
  - filters/__init__.py, Инструменты/__init__.py
  - Тесты/run_full_test.py

#### Улучшение кода
- **detectors.py** — консолидация разрешения путей к словарям через `_resolve_names_dict_path()`
- Удалён устаревший `filter_errors.py` из `__init__.py`
- Добавлен `transcription_provider.py` в описание модулей

---

## [4.7.2] - 2026-01-25

### Исправление фильтра, правила проекта, обновление тестов

#### Исправление levenshtein_protected для грамматического числа
- **Баг**: `собиратели→собиратель` фильтровался как `levenshtein_protected` (расстояние Левенштейна = 1, оба слова ≥ 5 букв), хотя это реальная ошибка чтеца (множественное → единственное число)
- **Исправление**: Добавлена проверка `is_number_change` в `golden_filter.py` — если слова имеют одну лемму, но разное грамматическое число (sing/plur), фильтр НЕ срабатывает
- **Защита**: `комтуры→контуры` по-прежнему фильтруется (через `yandex_typical`), регрессий нет

#### Правила создания золотых стандартов
- **config.py**: добавлен блок правил создания золотых стандартов — формат JSON, обязательные поля, именование файлов, порядок верификации
- **PROJECT.md**: добавлена секция «Правила создания золотых стандартов» с пошаговым процессом из 5 шагов

#### Правила хранения compared и filtered файлов
- **config.py**: добавлены правила хранения — compared/filtered файлы только в `Результаты проверки/{NN}/`, запрет хранения в `Темп/` или корне проекта
- **PROJECT.md**: добавлена таблица «Правила хранения compared и filtered файлов» с запрещёнными действиями

#### Обновление тестовой инфраструктуры (из v4.7.1)
- **Унифицирован формат `золотой_стандарт_глава2.json`** — приведён к формату главы 1 (`time/time_seconds`, `wrong/correct`, `substitution/insertion/deletion`)
- **Переработан `run_full_test.py` (v2.0)** — убрана зависимость от удалённого `check_transcription.py`, все пути из `config.py`
- **Поддержка обеих глав** — `--chapter 1`, `--chapter 2` или обе (по умолчанию)
- **Новые флаги**: `--skip-pipeline`, `--force`, `--verbose`

#### Результаты тестов
- Глава 1: **31/31 (100%)**
- Глава 2: **14/14 (100%)**
- **Итого: 45/45 (100%)**

---

## [4.7.0] - 2026-01-25

### Ревизия и аудит проекта

#### Удаление техдолга
- **Удалены DEPRECATED модули** — `check_transcription.py` и `text_processor.py` перемещены в корзину
- **Помечен `filter_errors.py` как DEPRECATED** — не импортируется ни одним модулем
- **Обновлён `__init__.py`** — актуальный список модулей, версия 4.7.0

#### Исправление бага
- **Исправлен fallback путь в `cache_manager.py:48`** — `'Бэкап'` → `'Темп'`

#### Унификация путей и правила хранения
- **Новые методы FileNaming**: `get_transcription_dir()`, `get_transcription_path()`, `find_transcription()`, `get_original_path()`, `get_audio_path()`
- **Правило хранения транскрипций**: `Транскрибации/Глава{N}/{NN}_transcript.json`
- **Документация структуры папок** в config.py

#### Обновление документации
- PROJECT.md, ROADMAP.md, CHANGELOG.md обновлены

---

## [4.6.0] - 2026-01-25

### Проверка главы 2, голден тест, улучшение веба

#### Проверка главы 2
- Прогнан полный пайплайн для главы 2
- Результат: **16 реальных ошибок** после фильтрации

#### Золотой тест для главы 2
- Создан `золотой_стандарт_глава2.json` с эталонными ошибками главы 2
- Фильтрация улучшена на основе ложных ошибок главы 2

#### Исправления web_viewer.py (v3.2)
- **Исправлено автоопределение транскрипции** — `chapter_num` теперь правильно извлекает число из chapter_id типа "Глава2" → "2" → "02", находит `02_transcript.json`
- **Исправлено обогащение контекстов для deletion** — без транскрипции функция `find_deletion_context_in_original` находила первое вхождение слова вместо правильного; теперь транскрипция загружается автоматически и соседние слова используются для точного поиска
- **Расширен разделитель в паттернах поиска** — `[,.\s\-—]*\s*` → `[\s,.:;!?\-—–«»""()\n\r…]*`; теперь корректно находит слова через переводы строк и диалоговые тире (`улыбаться:\n— Глава, мы`)
- **Пересчёт marker_pos после обогащения** — для deletion, substitution и transposition: после замены контекста на обогащённый marker_pos пересчитывается функцией `find_word_position_in_context()`
- **Исправлен битый симлинк аудио** — `audio_link.exists()` не видит битые симлинки; добавлена проверка `is_symlink()` перед удалением
- **Клик на плашку времени** — добавлен `onclick` на `div.error-time` для запуска аудио

#### Новая функция find_word_position_in_context()
- Находит позицию слова в контексте с учётом границ слов
- Используется для пересчёта marker_pos после обогащения контекста
- Нормализация: lowercase + ё→е

#### Организация файлов
- Транскрибация главы 2 (`02_transcript.json`) перенесена из Темп/ в Транскрибации/Глава2/

---

## [4.0.0] - 2026-01-24

### Golden Filter v4.0 — масштабное улучшение фильтрации

#### Анализ ложных ошибок
- Проанализировано **74 ложных ошибки** из главы 1
- Классификация по типам:
  - Омофоны: 45 случаев (58%)
  - Короткие слова: 18 случаев
  - Галлюцинации Яндекса: 5 случаев
  - Морфология: 2 случая

#### Новые омофоны в HOMOPHONES
- ах↔ох, э↔и, хм↔кх (междометия)
- думая↔думаю, скрывая↔скрываю, добавляя↔добавляю, делая↔делаю (деепричастия/глаголы)
- пьянка↔пианка (ё→е)
- это↔эта, мои↔и

#### Расширенный YANDEX_TYPICAL_ERRORS (60+ паттернов)
- Глаголы: меняются↔меняется, нравится↔нравятся
- Приставки: недостаёт↔достаёт, выпускать↔упускать, настолько↔столько
- Похожие слова: морж↔морщ, голова↔глава, цветок↔свиток

#### Новые фильтры
- **`is_prefix_variant()`** — фильтрует замены с добавленной/убранной приставкой (не, на, по, от, у, вы, за)
- **`split_word_insertion`** — фильтрует вставки частей разбитых слов (мыслеречи→мысли речи)

#### Улучшенный фильтр коротких слов
- Добавлены: на, до, же, да, тот, так, эти, то в alignment_artifacts
- Короткие слова фильтруются только если не в начале предложения

#### Защита важных союзов
- Замены а↔и, но↔и, или↔и теперь НЕ фильтруются как "похожие леммы"
- Эти замены меняют смысл и являются реальными ошибками чтеца

#### YANDEX_NAME_ERRORS
- Добавлено: морж↔морщ (прозвище Морщинистый)

#### Золотой стандарт расширен
- **Было:** 16 ошибок → **Стало:** 31 ошибка
- Добавлены ошибки из второй половины главы 1

#### Результаты
- **Ошибок на выходе:** 423 → 63 (снижение на 85%)
- **Золотой тест:** 31/31 (100%)

---

## [3.16.0] - 2026-01-24

### Добавлена система логирования

#### Новые возможности в config.py (v3.16.0)
- **`LogConfig`** — класс конфигурации логирования
  - Формат: `%(asctime)s [%(levelname)s] %(name)s: %(message)s`
  - Уровни: DEBUG для файла, настраиваемый для консоли
  - Ротация: хранение последних 10 лог-файлов
- **`setup_logging()`** — настройка логирования с двойным выводом (файл + консоль)
- **`get_logger()`** — получение логгера для модуля
- **`cleanup_old_logs()`** — автоматическая ротация старых логов
- **`log_exception()`** — логирование исключений с traceback
- **`LOGS_DIR`** — папка для логов: `Темп/logs/`

#### Интеграция в pipeline.py (v2.1)
- Импорт `setup_logging`, `get_logger`, `cleanup_old_logs`, `log_exception`
- Новые CLI флаги:
  - `--verbose/-v` — подробный вывод (уровень DEBUG)
  - `--quiet/-q` — только ошибки (уровень ERROR)
  - `--version/-V` — показать версию и выйти
- Логирование всех этапов пайплайна
- Улучшенная обработка ошибок с детальными сообщениями
- Fallback для систем без config.py

#### Формат логов
- Файл: `pipeline_{session_id}.log` в `Темп/logs/`
- Формат строки: `2026-01-24 17:10:14 [INFO] pipeline: Сообщение`
- Уровни: DEBUG (все детали), INFO (шаги), WARNING (предупреждения), ERROR (ошибки)

#### Пример использования
```bash
# Обычный режим (INFO)
python pipeline.py глава.mp3 оригинал.docx

# Подробный вывод (DEBUG)
python pipeline.py глава.mp3 оригинал.docx --verbose

# Только ошибки (ERROR)
python pipeline.py глава.mp3 оригинал.docx --quiet
```

---

## [3.15.0] - 2026-01-24

### Интеграция с config.py — завершающий этап

#### Унифицированные паттерны во всех модулях
Все модули проекта теперь используют единые паттерны:

| Паттерн | Описание |
|---------|----------|
| `HAS_CONFIG` | Флаг доступности config.py с fallback |
| `TEMP_DIR` | Централизованный путь к временной папке |
| `FileNaming` | Конвенция именования файлов |
| `--force` | Перезапись существующих файлов |
| `--version` | Вывод версии модуля |
| `VERSION/VERSION_DATE` | Константы версионирования |

#### Обновлённые модули

**morphology.py v2.0**
- Добавлены `VERSION='2.0'`, `VERSION_DATE='2026-01-24'`
- Импорт `TEMP_DIR` из config.py с fallback
- Путь кэша: `TEMP_DIR / 'cache'` вместо hardcoded
- Исправлен `except Exception:` → `except sqlite3.Error:`
- Добавлены флаги `--version`, `--force`
- Обновлён docstring с Changelog

**cache_manager.py v2.0**
- Добавлены `VERSION='2.0'`, `VERSION_DATE='2026-01-24'`
- Импорт `TEMP_DIR` из config.py с fallback
- Замена md5 на sha256 для хэширования
- Исправлены bare except → конкретные исключения
- Добавлены флаги `--version`, `--force`

**text_processor.py — DEPRECATED**
- Добавлено предупреждение DEPRECATED в docstring
- Рекомендация использовать `text_normalizer.py`
- Добавлен `DeprecationWarning` при запуске
- Вывод предупреждения в CLI

#### Ранее обновлённые модули (v3.14)
- smart_compare.py v3.0
- check_transcription.py v3.1 (deprecated)
- batch_pipeline.py v2.0
- proper_names_extractor.py v2.0
- pipeline.py v2.0

#### Результат
- **8 модулей** полностью интегрированы с config.py
- **2 модуля** помечены как DEPRECATED
- Единая система версионирования
- Централизованное управление путями и конфигурацией

---

## [3.14.0] - 2026-01-24

### Аудит и оптимизация golden_filter.py (v3.5)

#### Интеграция с config.py
- Импорт `FileNaming`, `GoldenFilterConfig`, `NAMES_DICT`, `PROTECTED_WORDS`, `READER_ERRORS`, `check_file_exists`
- Выходной файл по конвенции: `{chapter}_filtered.json`
- Пороги из `GoldenFilterConfig` (LEVENSHTEIN_THRESHOLD, USE_LEMMATIZATION, USE_HOMOPHONES)
- Fallback на старую логику если config.py недоступен

#### Автозагрузка словарей
- Автоматически загружает `Словарь_имён_персонажей.txt` из `NAMES_DICT`
- Автоматически загружает `ошибки_чтеца.json` из `READER_ERRORS`
- Автоматически загружает `защищенные_слова.txt` из `PROTECTED_WORDS`

#### Новые возможности
- Флаг `--force` для перезаписи существующих файлов
- Расширенная документация функций (docstrings)
- Обновлён баннер до v3.5, metadata version до 3.5.0

---

## [3.13.0] - 2026-01-24

### Аудит и оптимизация filter_errors.py (v2.0)

#### Интеграция с config.py
- Импорт `FileNaming`, `NAMES_DICT`, `check_file_exists` из config.py
- Выходной файл по конвенции: `{chapter}_filtered.json`
- Предупреждение при перезаписи существующих файлов
- Fallback на старую логику если config.py недоступен

#### Автозагрузка словаря имён персонажей
- Автоматически загружает `Словарь_имён_персонажей.txt` из NAMES_DICT
- Флаг `--no-names-dict` для отключения автозагрузки
- Имена из словаря добавляются в custom_ignore для фильтрации

#### Новые возможности
- Флаг `--force` для перезаписи существующих файлов
- Расширенный docstring с описанием всех параметров

---

## [3.12.0] - 2026-01-24

### Аудит и оптимизация text_normalizer.py (v2.0)

#### Интеграция с config.py
- Импорт `FileNaming`, `check_file_exists` из config.py
- Выходной файл по конвенции: `{chapter}_normalized.txt`
- Предупреждение при перезаписи существующих файлов
- Fallback на старую логику если config.py недоступен

#### Исправления
- Удалена некорректная единица `'г': 'год'` из UNITS_OF_MEASURE
- Добавлена единица `'мл': 'миллилитров'`
- Исправлено дублирование переменной `units` (переименовано в `units_with_declension`)

#### Новые возможности
- Флаг `--force` для перезаписи существующих файлов
- Расширен список KEEP_HYPHENATED: `всё-ещё`, `по-всякому`, `по-любому`, `по-иному`, `ей-богу`, `туда-сюда` и др.

---

## [3.11.0] - 2026-01-24

### Аудит и оптимизация модулей конвертации и транскрибации

#### Новый класс YandexCloudConfig в config.py
- Централизованная конфигурация Yandex Cloud (SpeechKit + Object Storage)
- Загрузка ключей из `api_keys.json` (bucket, folder_id, api_key, s3_credentials)
- Endpoints API, retry-конфигурация, форматы аудио — всё в одном месте
- Методы: `get_api_key()`, `get_s3_credentials()`, `get_bucket()`, `get_folder_id()`

#### Общие утилиты в config.py
- `format_duration(seconds)` — форматирование длительности (убрано дублирование)
- `get_audio_info(path)` — информация об аудио через pydub/ffprobe
- `check_file_exists(path, action)` — проверка существования файла

#### Интеграция transcribe.py (v3.0)
- Импорт `YandexCloudConfig`, `FileNaming` из config.py
- Автоматическое получение bucket и folder_id из api_keys.json
- Автоматическое получение S3 credentials для загрузки в Object Storage
- Выходной файл по конвенции: `{chapter}_transcript.json`
- Fallback на старую логику если config.py недоступен

#### Интеграция audio_converter.py (v2.0)
- Импорт `FileNaming`, `format_duration`, `get_audio_info` из config.py
- Выходной файл по конвенции: `{chapter}_yandex.ogg`
- Новый флаг `--force` для перезаписи существующих файлов
- Предупреждение при перезаписи (без --force)
- batch_convert пишет рядом с исходниками (не в подпапку)
- Исключение уже конвертированных файлов (`_yandex` в имени)

#### Технические улучшения
- Все модули имеют fallback если config.py недоступен
- Удалено дублирование функций между модулями
- Унифицированное именование выходных файлов

---

## [3.10.0] - 2026-01-24

### Аудит и оптимизация web_viewer.py

#### Интеграция с config.py
- Импорт централизованных путей: `READER_DIR`, `RESULTS_DIR`, `TEMP_DIR`, `CHAPTERS_DIR`
- Использование `FileNaming.get_chapter_id()` для определения номера главы
- Использование `FileNaming.build_filename()` для генерации имён файлов
- Fallback на старую логику если config.py недоступен

#### Удаление дублирования кода
- Удалён `HTML_TEMPLATE_FALLBACK` (~950 строк встроенного HTML)
- Шаблон загружается только из `templates/viewer.html`
- При отсутствии шаблона выбрасывается понятное исключение

#### Ротация логов
- Добавлена функция `cleanup_old_logs()` — удаляет логи старше 10 последних
- Логи хранятся в `Темп/web_logs/`
- Предотвращено накопление 60+ лог-файлов

#### Автоопределение связанных файлов
- Новая функция `auto_detect_related_files()`:
  - По имени JSON файла (01_filtered.json) ищет:
    - Аудио: `01_yandex.ogg` в Главы/ или той же папке
    - Оригинал: `01.docx` в Главы/
    - Транскрипция: `01_transcript.json`
- Новый аргумент `--no-auto` для отключения автоопределения
- Явно указанные файлы имеют приоритет над автоопределёнными

#### Унификация именования
- Файл для чтеца генерируется как `{chapter}_для_чтеца.docx` через FileNaming
- Номер главы определяется унифицированным методом

#### Технические улучшения
- Версия обновлена до 3.0
- Добавлен docstring с описанием функций модуля
- Удалены устаревшие комментарии

---

## [3.9.0] - 2026-01-24

### Аудит и оптимизация модуля сравнения

#### [КРИТИЧНО] Исправлена потеря коротких слов в golden_filter
- **Проблема**: Служебные слова "то", "я", "что" неправильно фильтровались
  - "то" фильтровалось как `split_name_insertion` (ктото→кетот)
  - "я" фильтровалось как `alignment_artifact`
  - "что" фильтровалось как `split_name_insertion`
- **Решение**:
  - Добавлен набор `FUNCTION_WORDS` = {'то', 'что', 'ли', 'же', 'бы', 'ка', 'ни', 'не', 'и', 'а', 'я', 'о', 'у'}
  - Служебные слова исключаются из проверки `split_name_insertion`
  - Ужесточён порог Левенштейна для `split_name_insertion`: ≤1 вместо ≤2, min длина 6 вместо 5
  - 'я' удалено из `alignment_artifacts`
  - Контекстная проверка для 'а', 'и' — не фильтруются после пунктуации
- **Результат**: Голден-тест 16/16 (100%) вместо 13/16 (81%)

#### Создан централизованный config.py
- Все пути к папкам и файлам в одном месте
- `FileNaming` — класс с конвенцией именования файлов:
  - `{chapter}_{stage}.{ext}` (01_compared.json, 01_filtered.json)
  - Этапы: audio, transcript, normalized, compared, filtered, docx, names
- `validate_file_correspondence()` — проверка соответствия транскрипции и текста
- `cleanup_deprecated_files()` — очистка устаревших файлов
- Константы `SmartCompareConfig`, `GoldenFilterConfig`

#### Интеграция в pipeline.py
- Добавлен шаг "Проверка соответствия файлов" — предупреждает если транскрипция не соответствует тексту
- `step_smart_compare()` и `step_golden_filter()` используют `FileNaming`
- Унифицированное именование выходных файлов

#### Очистка smart_compare.py
- Удалены неиспользуемые структуры: `Anchor`, `GrayZone`
- Удалены устаревшие функции: `find_anchors()`, `find_gray_zones()`, `analyze_gray_zone()`, `compare_word_sequences()`
- Удалён неиспользуемый импорт `defaultdict`
- Код сокращён ~200 строк

#### Очистка устаревших файлов
- Удалены из `Результаты проверки/01/`:
  - `01_final.json` (заменён на 01_filtered.json)
  - `01_raw.json` (промежуточный файл)
  - `01_transcript_compared.json` (неправильное именование)
  - `Глава 1_normalized.txt` (дубликат с пробелом)

#### Результаты
- **Голден-тест: 16/16 (100%)**
- **Ошибок после фильтрации: 110** (было 95)
- **Файлы соответствуют конвенции именования**

---

## [3.8.0] - 2026-01-24

### Улучшена фильтрация имён и прозвищ персонажей

#### Добавлены прозвища персонажей в словарь имён
- **Новые записи**: Зеленорукий, Морщинистый, Лжеморщинистый, Красноволосый, Седой (и падежные формы)
- **Словарь имён**: 544 имени → 9460 форм

#### Увеличен порог Левенштейна для имён персонажей
- **Было**: `dist <= max(2, int(max_len * 0.3))` — 30% длины слова
- **Стало**: `dist <= max(3, int(max_len * 0.5))` — 50% длины слова
- **Пример**: `аранви→разве` (dist=3) теперь фильтруется

#### Добавлена логика для ключевых имён (CHARACTER_NAMES)
- Если оригинальное слово — ключевое имя персонажа, любая замена фильтруется
- **Примеры**: `зеленорукий→тебе`, `седой→сюда` — теперь фильтруются

#### Расширен YANDEX_GARBLED_NAMES
- Добавлены: `седокило`, `зритель`

#### Результаты
- **Ошибок**: 113 → 95 (снижение на 16%)
- **yandex_name_error**: 42 ошибки отфильтрованы
- **Золотой стандарт**: 13/16 (81%) — 3 ошибки не обнаруживаются на уровне smart_compare

---

## [3.7.0] - 2026-01-24

### Большой этап: Исправление контекстов, автоопределение phantom, фильтр разбитых имён

**Строк кода в проекте: 11 117**

#### Исправлена десинхронизация original_text в smart_compare.py
- **Проблема**: `parse_original_text()` неправильно сопоставляла нормализованные слова с оригинальными токенами. Слова с дефисами (например, "что-то" → "что", "то") вызывали сдвиг, и `original_text` содержал неверные слова.
- **Решение**: Переписан алгоритм сопоставления:
  - Для каждого оригинального токена заранее вычисляется список нормализованных слов
  - Корректная обработка составных слов через дефис
  - Поиск с откатом при рассинхронизации
- **Результат**: Контексты ошибок теперь содержат правильный оригинальный текст с пунктуацией

#### Автоопределение phantom (метаданных в начале аудио)
- **Проблема**: Фиксированное значение `phantom=5.0` секунд не подходило для файлов с длинной заставкой
- **Решение**:
  - Изменён default с `5.0` на `-1` (автоопределение)
  - Функция `detect_phantom_seconds()` автоматически находит конец метаданных
  - Для главы 1 автоматически определено: **17.7 секунд**
- **Файлы**: `pipeline.py`, `smart_compare.py`

#### Новый фильтр split_name_insertion в golden_filter.py
- **Проблема**: Яндекс разбивает имена на части (например, "Шаугат" → "шоу гад"), создавая insertion "гад"
- **Решение**: Новый фильтр проверяет `transcript_context` — если вставленное слово рядом с другим образует имя из словаря, фильтрует как `split_name_insertion`
- **Отфильтровано**: 13 таких вставок

#### Исправлено кэширование модуля в pipeline.py
- **Проблема**: При запуске из одной Python-сессии модуль `golden_filter` кэшировался со старыми данными словарей
- **Решение**: Добавлен `importlib.reload(golden_filter)` в `step_golden_filter()` для принудительной перезагрузки

#### Результаты
- **Ошибок: 136 → 106** (улучшение на 22%)
- **Ошибок с именами персонажей: 0** (было 7+)
- **Новые категории фильтрации**:
  - `split_name_insertion`: 13
  - `yandex_name_error`: 35
  - `levenshtein_similar_lemma`: 56

---

## [3.6.2] - 2026-01-24

### Автосохранение ложных срабатываний и новые паттерны фильтрации

#### Улучшения web_viewer.py
- **Автосохранение ложных срабатываний**: при нажатии "Ложная" данные отправляются на сервер
- **POST /api/false-positive**: сохраняет в `Результаты проверки/ложные_ошибки.json`
- Теперь Claude может читать ложные срабатывания и добавлять паттерны в фильтр

#### Улучшения golden_filter.py
- **alignment_artifacts**: добавлено `'ни'` для deletions
- **YANDEX_TYPICAL_ERRORS**: новые паттерны из веб-интерфейса:
  - `('пагде', 'пагоде')` — Яндекс пропускает букву в названии
  - `('держится', 'задержатся')` — Яндекс не слышит приставку «за»

---

## [3.6.1] - 2026-01-24

### Полная поддержка ошибки типа transposition (перестановка)

#### Улучшения web_viewer.py
- **Экспорт в буфер обмена** (`exportToClipboard`): добавлена перестановка
- **Экспорт в TXT** (`exportToText`): формат `время - перестановка: wrong → correct`
- **Отметка для чтеца** (`markForReader`): сохраняет wrong/correct
- **Отметка ложных** (`markFalsePositive`): сохраняет wrong/correct
- **Генерация DOCX** (`generate_reader_docx`):
  - Тип: «Перестановка»
  - Формат: `таймкод — WRONG ⇄ correct`
  - Контекст: маркер ⇄ перед правильной фразой
- **TXT fallback**: аналогичное форматирование
- **Легенда форматирования**: добавлен маркер ⇄

#### Формат перестановки
- **Заголовок**: `15:37 — ТЫ ЧТО ⇄ что ты`
- **Контекст**: `...⇄ТЫ ЧТО (что ты) раз за разом...`
- **Маркер**: ⇄ (двунаправленная стрелка)

---

## [3.6.0] - 2026-01-24

### Интеграция словаря имён персонажей (522 имени → 9271 форма)

#### Улучшения golden_filter.py
- **Автозагрузка словаря** из `Словари/Словарь_имён_персонажей.txt`
- **Генерация падежных форм** через pymorphy2 (522 имени → 9271 форма)
- **Улучшен `is_yandex_name_error()`**:
  - Если оба слова — формы имён из словаря → фильтрует
  - Если одно слово — имя, другое похоже (Левенштейн ≤30%) → фильтрует

#### Исправления test_golden_standard.py
- Поддержка полей `original/transcript` (альтернатива `wrong/correct`)
- Поддержка типа ошибки `transposition`

#### Результаты
- **Ошибок: 55 → 46** (улучшение на 16%)
- **Золотой стандарт: 17/17 (100%)**
- Статистика фильтрации:
  - `levenshtein_similar_lemma`: 35
  - `yandex_typical`: 29
  - `compound_word`: 27
  - `yandex_name_error`: 24
  - `compound_particle_to`: 15
  - `homophone`: 14
  - `same_lemma`: 13
  - `case_form`: 11
  - `alignment_artifact`: 9
  - `grammar_ending`: 9
  - `character_name_unrecognized`: 4

---

## [3.5.1] - 2026-01-23

### Исследование: Недетерминированность Яндекс SpeechKit

Проведён эксперимент: двукратная транскрибация одного аудио (30 мин).

**Результаты:**
- Схожесть транскрипций: **99.07%**
- Замены слов: 30
- Добавлено слов: 10
- Удалено слов: 4
- **Всего различий: 44** (~1% от 4000 слов)

**Типы нестабильности:**
1. Грамматические окончания (`меняется` ↔ `меняются`, `важные` ↔ `важное`)
2. Имена персонажей (`шаугад` ↔ `шоугад`, `арзумы` ↔ `эрзумы`, `ранви` ↔ `а`)
3. Разные слова (`свиток` ↔ `цветок`, `утащить` ↔ `учить`)
4. Появление/исчезновение союзов и коротких слов

**Вывод:** Часть "ошибок" может быть артефактами нестабильности API, а не реальными ошибками чтеца.

### Документация
- Добавлено описание `--phantom` параметра в ПРОЕКТ.md
- Задокументирована недетерминированность SpeechKit

---

## [3.5.0] - 2026-01-23

### Улучшения golden_filter v3.4

#### Новые фильтры
- **split_name** — разбитые имена: "шоу гад" → шаугат, "во рту" → вартол
- **compound_prefix** — составные слова: "не дешевый" → недешёвый, "лже морщинистым"
- **split_compound** — дефисные слова: "из за" → из-за, "по хорошему"

#### Улучшения
- **compound_particle_to** — теперь не фильтрует "кто то сунется" (глагол после "то")
- Добавлены константы `SPLIT_NAME_PATTERNS`, `COMPOUND_PREFIXES`, `SPLIT_COMPOUND_PATTERNS`

#### Новый тип ошибки: transposition
- Детекция перестановок: "что ты" → "ты что"
- Паттерн в opcodes: INSERT X, EQUAL Y, DELETE X

#### Результаты
- **Золотой стандарт: 17/17 (100%)**
- **Ошибок: 61 → 54** (7 дополнительно отфильтровано)

---

## [3.4.0] - 2026-01-23

### Переписан алгоритм smart_compare v2.0

#### Проблема
Старый алгоритм на основе якорей находил только 22 якоря на 4000 слов,
создавая огромные "серые зоны" с тысячами ложных ошибок (7800+).

#### Решение
Полностью переписан `smart_compare.py`:
- **SequenceMatcher** — использует difflib для оптимального выравнивания
- **Прямое сравнение** — без якорей и серых зон
- **Схожесть 94.5%** — корректное определение совпадений
- **257 ошибок** вместо 7800+ (снижение в 30 раз)

#### Изменения в логике is_yandex_error
- Все `substitution` — ошибки чтеца (не Яндекса)
- Яндекс распознаёт то, что слышит; если результат отличается — чтец ошибся
- Фильтрация типичных ошибок Яндекса выполняется в `golden_filter.py`

#### Пропуск метаданных (phantom)
- Добавлен параметр `--phantom` (по умолчанию 5 сек)
- Для тестовых файлов с заставкой использовать `--phantom 18`
- Пропускает "Михаил Игнатов, Цикл Путь, Глава N" в начале

#### Результаты
- **Золотой стандарт: 18/18 (100%)**
- **Схожесть текстов: 94.5%**
- **Ошибок после фильтра: 74**

---

## [3.3.2] - 2026-01-23

### Инфраструктурные улучшения

#### Новые модули
- **morphology.py** — единый модуль морфологического анализа
  - Двухуровневое кэширование: lru_cache + SQLite
  - Персистентный кэш на диске (`Темп/cache/morph_cache.db`)
  - Функции: `get_lemma`, `get_pos`, `get_number`, `get_case`

- **batch_pipeline.py** — пакетная обработка глав
  - Автоматическое сопоставление аудио + текст по имени
  - Параллельная обработка нескольких глав
  - Общий отчёт `batch_report.json`

- **proper_names_extractor.py** — извлечение имён собственных
  - Анализ слов с заглавной буквы
  - Морфологический анализ (Name, Surn, Patr, Geox)
  - Паттерны имён (Имя Отчество, Имя Фамилия)
  - Автоматическое добавление в `защищенные_слова.txt`

#### Улучшения pipeline.py
- **Retry-логика** — 3 попытки с exponential backoff (1-10 сек)
- **Валидация JSON** — проверка структуры транскрипции Яндекса
- **Прогресс-бар** — tqdm для визуализации шагов
- **Извлечение имён** — автоматическое перед фильтрацией

#### Улучшения transcribe.py
- **APIError** — класс ошибок с retryable-флагом
- **Retry-логика** — `retry_request()` с backoff и jitter
- **Обработка 429/5xx** — автоматический повтор

#### Улучшения web_viewer.py
- **Внешний шаблон** — `templates/viewer.html`
- **Загрузка шаблона** — `load_html_template()` с fallback

#### Тестирование
- **test_golden_filter_unit.py** — pytest unit-тесты
  - Нормализация, омофоны, грамматика
  - Левенштейн, лемматизация
  - Типичные ошибки Яндекса
  - Детектор цепочек

#### Type hints
- **golden_filter.py** — полная типизация функций
- **pipeline.py** — базовая типизация

#### Документация
- **ROADMAP.md** — обновлён до v3.3.2

---

## [3.3.1] - 2026-01-23

### Исправления фильтрации

#### Приоритет YANDEX_TYPICAL_ERRORS над PROTECTED_WORDS
- Исправлена логика: теперь даже защищённые слова (числительные, имена) проверяются
  на известные ошибки Яндекса
- **18:03 'сто → то'** — теперь фильтруется как `yandex_typical`

#### Улучшение веб-интерфейса
- Контекст теперь центрируется по слову ошибки, а не по первому ключевому слову

#### Результаты
- **Золотой стандарт: 18/18 (100%)**
- **Ошибок на выходе: 37**
- `yandex_typical: 30` (было 28)

---

## [3.3.0] - 2026-01-23

### Детектор цепочек смещения (alignment chain detector)

#### Системное решение вместо костылей
Когда Яндекс плохо распознаёт слово (например, эмоциональная подача чтеца),
выравнивание сдвигается и создаёт каскад ложных ошибок. Раньше каждую такую
пару приходилось добавлять вручную в YANDEX_TYPICAL_ERRORS.

**Новый подход:** автоматический детектор цепочек:
1. Ищет ошибки в пределах 3 секунд друг от друга
2. Обнаруживает признак смещения: wrong[i] == correct[i+1]
3. Проверяет, что первая ошибка — артефакт (Левенштейн > 3 или > 50%)
4. Фильтрует всю цепочку автоматически

#### Результаты
- **Золотой стандарт: 18/18 (100%)**
- **Ошибок на выходе: 38**
- Новая категория фильтрации: `alignment_chain: 2`
- Убраны костыльные пары из YANDEX_TYPICAL_ERRORS

#### Исправленные в v3.2.1 (теперь через детектор)
- 15:25 'правило → не' — автоматически
- 15:27 'не → нравятся' — автоматически

---

## [3.2.1] - 2026-01-23

### Дополнительные фильтры (снижение с 43 до 40 ошибок)

#### Исправленные ложные срабатывания
- **7:17 'лжедорогала → и'** — добавлен YANDEX_GARBLED_NAMES для искажённых имён
- **8:55 пропуск 'но'** — добавлен 'но' в alignment_artifacts
- **14:59 'с → указ'** — цепочка от «наука с» → «но указ»

#### Новые паттерны
- **YANDEX_GARBLED_NAMES** — множество искажённых имён (лжедорогала, дорогалым, шугат и др.)
- **alignment_artifacts** — добавлен 'но' для deletions

---

## [3.2.0] - 2026-01-23

### Новые омофоны и паттерны (снижение с 53 до 43 ошибок)

#### Расширенные омофоны (HOMOPHONES)
- **'я' ↔ 'и'** — Яндекс путает безударные я/и (5 случаев)
- **'а' ↔ 'но'** — Яндекс путает союзы
- **'то' ↔ 'ты'** — Яндекс путает местоимение/частицу

#### Расширенный YANDEX_TYPICAL_ERRORS
- **'наука' ↔ 'указ'** — «наука с» → «но указ»
- **'о' ↔ 'ублюдочные'** — «о блядочное» → «ублюдочные»
- **'трата' ↔ 'траты'** — sing/plur
- **'сплошная' ↔ 'сплошные'** — связанный артефакт

#### Результаты
- **Золотой стандарт: 18/18 (100%)**
- **Ошибок на выходе: 43** (было 53, снижение на 19%)
- Статистика фильтрации:
  - levenshtein_similar_lemma: 35
  - yandex_typical: 28
  - yandex_name_error: 23
  - homophone: 14
  - same_lemma: 13
  - case_form: 11
  - compound_word: 10
  - grammar_ending: 9
  - alignment_artifact: 5
  - interjection: 3
  - adverb_adjective: 2
  - context_artifact: 2

#### Не реализовано (осознанно)
- Пропуски 'и', 'а', 'но', 'ли', 'им' — рискованно фильтровать автоматически,
  в золотом стандарте есть реальные пропуски 'я' (12:40) и 'а' (13:44)
- Пропуск имени персонажа (Седой) — может скрыть реальные ошибки

---

## [3.1.0] - 2026-01-23

### Оптимизация golden_filter.py (снижение с 99 до 53 ошибок)

#### Производительность
- **@lru_cache для pymorphy** — кэширование результатов разбора слов
  - Эффективность кэша: 85.5%
  - Ускорение: ~5-10x на повторных словах
- **Единый parse_word_cached()** — один вызов вместо 3 отдельных
- **Предкомпилированные regex** — HOMOPHONE_PATTERNS_COMPILED

#### Новые фильтры
- **case_form** — падежные формы существительных (печати→печатей)
- **adverb_adjective** — наречие↔прилагательное (довольны→довольно)
- **short_full_adjective** — краткое↔полное (уверены→уверенный)
- **verb_gerund_safe** — глагол↔деепричастие безопасные (стараюсь→стараясь)
- **grammar_ending** — грамматические окончания (-ый/-ое, -ит/-ят, -ей/-и)
- **interjection** — междометия (п, ф, м, ах, ох)
- **context_artifact** — контекстные паттерны («и...и» в перечислениях)

#### Расширенные словари
- **HOMOPHONES**: добавлен ну↔но
- **YANDEX_TYPICAL_ERRORS**: +15 паттернов
  - от↔над, на↔а, сто↔то, вот↔то, уверены↔уверенный
  - казни↔казним, везли↔если, наука↔но

#### Результаты
- **Золотой стандарт: 18/18 (100%)**
- **Ошибок на выходе: 53** (было 99, снижение на 46%)
- Статистика фильтрации:
  - levenshtein_similar_lemma: 35
  - yandex_typical: 26
  - yandex_name_error: 23
  - same_lemma: 13
  - case_form: 11
  - compound_word: 10
  - grammar_ending: 9
  - homophone: 7
  - alignment_artifact: 4
  - interjection: 3
  - adverb_adjective: 2
  - context_artifact: 2
  - short_full_adjective: 1
  - verb_gerund_safe: 1

---

## [2.2.0] - 2026-01-23

### Улучшения фильтрации (снижение с 128 до 99 ошибок)

#### Новые фильтры
- **YANDEX_NAME_ERRORS** — словарь ошибок Яндекса в именах персонажей (23 паттерна)
  - Дарагал: дорогалым, дорогалом, дорогала, драгал, лжедорогала
  - Шаугат: шоу, шугат, шаугад
  - Галум: голлума, голлум
  - Эрзум: зум, арзум, арзумы, арзом
  - Аранви: ранви, арабви, саранге
  - И другие персонажи...

- **alignment_artifact** — фильтр артефактов выравнивания
  - Фильтрует односимвольные предлоги в deletions: в, о, у, к, с
  - НЕ фильтрует союзы (а, и) и местоимения (я) — они могут быть реальными ошибками

- **YANDEX_TYPICAL_ERRORS** — расширенный словарь типичных ошибок
  - Слитные: изза, чтото, както, гдето
  - Похожие: ввиду→уведу, информации→формации

#### Исправления
- **Унифицирована структура ошибок** — insertions/deletions теперь используют wrong/correct
- **Исправлен парсинг insertion/deletion** — правильное извлечение слов для фильтрации

### Результаты
- **Золотой стандарт: 18/18 (100%)**
- **Ошибок на выходе: 99** (было 128, снижение на 23%)
- Статистика фильтрации:
  - levenshtein_similar_lemma: 35
  - yandex_name_error: 23
  - same_lemma: 21
  - compound_word: 11
  - homophone: 5
  - alignment_artifact: 4
  - yandex_typical: 2

### Новые файлы
- **Тесты/run_full_test.py** — автоматический полный тест системы

---

## [2.1.0] - 2026-01-23

### Исправления критических багов

#### check_transcription.py
- **Исправлен баг с перепутанными insert/delete** — в difflib `delete` означает лишнее слово в транскрипции (insertion), а `insert` — пропущенное слово (deletion). Логика была перепутана.
- Теперь корректно находятся все типы ошибок: substitution, insertion, deletion
- Добавлены поля `wrong`/`correct` для insertions/deletions (унификация структуры)

#### golden_filter.py
- **Убрана фильтрация коротких слов для insertions/deletions** — пропуск или вставка даже короткого слова ("я", "а", "то") это реальная ошибка чтеца
- **Изменена логика weak_words** — теперь фильтруются только если слова одинаковые или формы одного слова. `я→с`, `она→он`, `а→но` — это разные слова, реальные ошибки!
- **Добавлена проверка частей речи в Левенштейне** — слова с разными POS (NPRO vs PREP) не фильтруются даже при малом расстоянии
- **Добавлена проверка числа (sing/plur)** — `сотни→сотня` не фильтруется как одна лемма

### Результаты тестирования
- **Золотой стандарт: 18/18 (100%)** — все эталонные ошибки найдены
- Raw ошибок: 201 (163 substitution, 5 insertion, 33 deletion)
- После фильтрации: 128 реальных ошибок

### Золотой стандарт (18 ошибок главы 1)
Полный список из `Тесты/золотой_стандарт_глава1.json`:
- 12 substitutions (замены)
- 3 insertions (лишние слова)
- 3 deletions (пропуски)

---

## [2.0.0] - 2026-01-23

### Восстановлено и добавлено
Полное восстановление проекта после случайного удаления.

#### Новые модули
- **pipeline.py** — полный пайплайн проверки (главный скрипт)
- **audio_converter.py** — конвертация аудио в OggOpus для Яндекс
- **transcribe.py v2.0** — обновлённый API Яндекс SpeechKit
- **text_normalizer.py** — нормализация текста (числа, дефисы, сокращения)
- **smart_compare.py** — умное сравнение с якорями и серыми зонами
- **golden_filter.py** — многоуровневый фильтр отсева (6 уровней)

#### Словари
- `Словари/ошибки_чтеца.json` — типичные ошибки чтеца
- `Словари/защищенные_слова.txt` — защищённые слова
- `Словари/config.json` — конфигурация фильтров

#### Тестирование
- `Тесты/золотой_стандарт_глава1.json` — эталонные ошибки главы 1
- `Тесты/test_golden_standard.py` — тест золотого стандарта
- `Результаты проверки/отчет_глава1_эталон.json` — эталонный отчёт

### Фильтр отсева (6 уровней)
1. Защищённые слова (имена, термины)
2. Слабые слова (союзы, частицы)
3. Омофоны (его/ево, что/што)
4. Лемматизация (pymorphy2)
5. Левенштейн (расстояние ≤2)
6. Типичные ошибки Яндекса

### Нормализация текста
- Числа → слова с правильными падежами
- Сокращения → полные формы
- Дефисы внутри слов → унификация
- Тире между словами → пробелы
- Диалоговые тире → удаление

### Умное сравнение
- Якоря — 100% совпадения как точки синхронизации
- Серые зоны — детальный анализ между якорями
- Классификация: ≥70% = Яндекс, <70% = чтец

### Тестирование
- Тест золотого стандарта проходит: 4/4 ошибки найдены
- Эталонные ошибки главы 1:
  - 0:59: ЖИВЕМ → живы
  - 1:06: ТЕРЯЮ → теряя
  - 2:23: ВЫХОДА → способа
  - 2:48: СКАЗАТЬ (вставка)

### Зависимости добавлены
- thefuzz (Levenshtein)
- pymorphy2 (лемматизация)

---

## [1.0.0] - До 2026-01-23

### Исходная версия
- check_transcription.py — базовая проверка
- filter_errors.py — простой фильтр
- web_viewer.py — веб-интерфейс
