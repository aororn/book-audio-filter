# Changelog

> Полная детальная история: `Документация/Архив/CHANGELOG_FULL.md`

## [11.5.0] - 2026-01-30 — Текущая версия

**engine.py v8.9 — Интеграция SemanticManager и SmartScorer**

| Метрика | До (v11.4) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Отфильтровано | 715 | **715** (без изменений) |
| Осталось FP | 135 | **135** (без изменений) |

### Ключевые изменения:

**1. engine.py v8.9 — интеграция модулей:**
- **SemanticManager** интегрирован как ЗАЩИТНЫЙ слой
  - Высокая семантика (>0.4) + разные леммы = оговорка чтеца = НЕ фильтруем
  - Использует Navec (500K слов, 300d) для семантической близости
  - Защищает golden от ложной фильтрации
- **SmartScorer** интегрирован для расчёта метрик
  - Добавляет `smart_metrics` к каждой ошибке
  - Включает: score, applied_rules, semantic_similarity
  - НЕ используется для автоматической фильтрации (только метрики)

**2. Калибровка на данных БД (941 ошибка):**
- Анализ: same_lemma=1 + semantic>0.5 = 14 golden, 138 FP (небезопасно!)
- Анализ: diff_lemma + semantic<0.2 = 7 golden, 220 FP (тоже небезопасно!)
- Решение: консервативный подход — модули добавляют метрики, не фильтрацию

**3. Новые метрики в ошибках:**
```json
{
  "smart_metrics": {
    "smart_score": 100,
    "smart_rules": ["grammar_change (+70)", "semantic_slip (+30)"],
    "is_visible": true,
    "semantic_similarity": 0.616
  }
}
```

---

## [11.4.0] - 2026-01-30

**engine.py v8.8 — Новые фильтры артефактов + расширение safe_ending_transition**

| Метрика | До (v11.3) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Отфильтровано | 700 | **715** (+15) |
| Осталось FP | 149 | **135** (-14) |

### Ключевые изменения:

**1. engine.py v8.8 — новые фильтры:**
- `misrecognition_artifact`: вставленное слово похоже на слово в контексте
  - "блядочное"~"ублюдочные", "оголим"~"големах", "смертник"~"пересмешник"
  - Использует SequenceMatcher (порог 0.6), **отфильтровано 8 FP**
- `unknown_word_artifact`: вставка неизвестного слова (UNKN в pymorphy)
  - Пример: "бла" (обрыв "глава")
  - **Отфильтровано 1 FP**

**2. Расширение safe_ending_transition (+4 паттерна, +10 FP):**
- ('ья', 'ье'), ('ье', 'ья') — зелья↔зелье
- ('ей', 'ли') — мыслей↔мысли
- ('ью', 'ти') — костью↔кости

**3. constants.py — новые безопасные пары diff_lemma (+6 FP):**
- средина↔середина, уж↔уже, вбивают↔выбивают
- ускользнуть↔скользнуть, проводить↔проходить, идти↔прийти

**4. Статистика фильтров (топ-10):**
- yandex_typical: 199 (+5)
- alignment_artifact: 141
- yandex_name_error: 102
- safe_ending_transition: 79 (+10)
- single_consonant_artifact: 34
- linked_prefix_error: 26
- morpho_proper_name: 21
- interjection: 18
- homophone: 16
- misrecognition_artifact: 8 (new)

---

## [11.3.0] - 2026-01-30

**Унификация БД и filtered.json + single_consonant_artifact**

| Метрика | До (v11.2) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Отфильтровано | 446 | **694** |
| Осталось FP (в БД) | 403 | **155** |
| Не отфильтровано | 260 | **247** (= 92 golden + 155 FP) |

### Ключевые изменения:

**1. engine.py v8.7:**
- Новый фильтр `single_consonant_artifact` для однобуквенных согласных (с, в, м, п, к, ф, х, э)
- Безопасно: проверено на БД — 0 golden среди этих букв

**2. populate_db.py — КРИТИЧЕСКОЕ исправление:**
- БД теперь использует **ту же логику** что и filter_errors()
- Раньше: БД использовала should_filter_error напрямую (пропускала linked_prefix_error, alignment_chain)
- Сейчас: БД прогоняет данные через filter_errors() и читает filter_reason
- **Гарантирована консистентность**: filtered.json (247) = БД не отфильтровано (247)

**3. Статистика фильтров (топ-10):**
- yandex_typical: 194
- alignment_artifact: 141
- yandex_name_error: 102
- safe_ending_transition: 69
- single_consonant_artifact: 34
- linked_prefix_error: 26
- morpho_proper_name: 21
- interjection: 18
- homophone: 16
- alignment_artifact_substring: 14

---

## [11.2.0] - 2026-01-30

**Унификация Golden стандарта + БД ошибок с метриками**

| Метрика | До | После |
|---------|-----|-------|
| Golden в файлах | 93 | **92** |
| Golden в БД | 91 (разночтения) | **92** (точное соответствие) |
| Всего ошибок в БД | — | 941 |
| Отфильтровано | — | 437 |
| Осталось FP | 260 | **412** (полная БД) |

### Ключевые изменения:

**1. Унификация Golden стандарта:**
- Golden файлы переписаны с точными парами слов из compared.json
- Сопоставление по 4 параметрам: chapter + correct + wrong + time (±3 сек)
- 1 ошибка исключена (transposition `я и → и я` — другой тип в compared)
- Старые файлы сохранены как `*_old.json`

**2. База данных ошибок (populate_db.py):**
- SQLite БД со всеми 941 ошибками из 4 глав
- Метрики: лемма, POS, same_lemma, same_pos
- Семантика: semantic_similarity (Navec 500K слов)
- Частотность: frequency_wrong/correct (НКРЯ 103K слов)
- Фонетика: phonetic_similarity, levenshtein
- Статус: is_golden, is_filtered, filter_reason

**3. Новые файлы:**
- `Инструменты/populate_db.py` — заполнение БД с метриками
- `Словари/false_positives.db` — SQLite база ошибок
- `Тесты/золотой_стандарт_глава*_old.json` — бэкап старых golden

---

## [11.1.2] - 2026-01-30

**Исправление Golden 30:38** — ошибка `или→и` восстановлена.

| Метрика | До (v11.1.1) | После |
|---------|--------------|-------|
| Golden | 92/93 | **93/93** ✓ |
| FP | 259 | 260 (+1) |

Корневая причина: Яндекс распознал "или" как "эли", smart_compare обнаружил `эли→и`,
но пара была ошибочно добавлена в YANDEX_TYPICAL_ERRORS и фильтровалась.

Изменения:
- `constants.py` — удалена пара `('эли', 'и')` (это реальная ошибка чтеца)

---

## [11.1.1] - 2026-01-30

**Улучшение фильтрации по леммам** — is_yandex_typical_error теперь проверяет леммы.

| Метрика | До (v11.1.0) | После |
|---------|--------------|-------|
| Golden | 93/93 | 93/93 |
| FP | 268 | **259** ↓9 |

Изменения:
- `comparison.py` v6.0.1 — `is_yandex_typical_error` проверяет леммы для слов ≥5 символов
- `engine.py` v8.6.1 — исключение `или` из `yandex_expand_artifact`
- `constants.py` — новые пары: мурлан/морлан, рагидон/рагедон, клик/крик и др.

---

## [11.1.0] - 2026-01-30

**SmartFilter v3.0** — исправленная логика весов.

| Метрика | До (v10.7) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| FP | 262 | 268 (+6) |

КЛЮЧЕВОЕ ИЗМЕНЕНИЕ:
- Одинаковая лемма НЕ означает FP!
- Грамматические различия (число, падеж, вид, POS) = РЕАЛЬНАЯ ошибка

Новые модули:
- `smart_scorer.py` v3.0 — накопительный скоринг с `grammar_change` (+70)
- `smart_filter.py` v3.0 — детекция грамм. различий + pymorphy3
- `frequency_manager.py` v1.0 — частотный словарь НКРЯ
- `sliding_window.py` v1.0 — фонетическое сравнение

Исправления:
- Убраны ошибочные штрафы: `same_lemma`, `phonetic_similar_weak`
- Добавлена детекция приставки "по-" (побольше→больше)

---

## [10.7.0] - 2026-01-29

**safe_ending_transition** — новый фильтр на основе анализа БД.

| Метрика | До | После |
|---------|-----|-------|
| Golden | 93/93 | 93/93 ✓ |
| FP | 324 | **262** |
| FP Recall | 64.1% | **72.3%** |

Изменения:
- `engine.py` v8.6.0 — фильтр безопасных переходов окончаний
- `false_positives_db.py` v3.1 — исправлен mark_golden()

---

## [10.5.0] - 2026-01-29

**Унификация версионирования** — метаданные версий в JSON.

- Метаданные в compared.json: `created_at`, `smart_compare_version`
- Валидация версий в engine.py
- Флаг `--clean` в run_full_test.py
- FP: 328 → 309

---

## [10.0.0] - 2026-01-29

**Посегментное выравнивание** — полный переход от полнотекстового сравнения.

- `compare_with_anchors()` — сравнение с якорями
- `refine_large_segments()` — суб-якоря для сегментов >100 слов
- AlignmentManager v1.2 — фильтр монотонности

---

## [9.0.0] - 2026-01-29

**Модульная архитектура** — 6 независимых модулей.

Модули:
- AlignmentManager — макро-выравнивание
- WindowVerifier — контекстная верификация
- ScoringEngine — адаптивные штрафы
- ComparisonStitcher — склейка слов
- MorphoRules — морфологические правила
- CharacterGuard — защита имён

---

## [8.0.0] - 2026-01-26

**Консервативная фильтрация** — при сомнении НЕ фильтруем.

- morpho_rules.py — единый морфологический модуль
- 20+ уровней фильтрации в engine.py
- Golden 94/94 (100%)

---

## [5.7.0] - 2026-01-25 — Лучший исторический FP

| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 | 62 |
| 2 | 21/21 | 42 |
| 3 | 20/20 | 79 |
| **Итого** | **72/72** | **183** |

---

## [5.0.0] - 2026-01-25

**Стабильная версия** — конфигурация и пайплайн.

- config.py v5.0.0 — централизованная конфигурация
- pipeline.py v5.0.0 — полный пайплайн
- Golden 72/72

---

## [2.0.0] - 2026-01-23

**Восстановление проекта** — после случайного удаления.

Модули:
- pipeline.py, smart_compare.py, golden_filter.py
- text_normalizer.py, transcribe.py
- Тесты/золотой_стандарт_глава1.json

---

## [1.0.0] - До 2026-01-23

Исходная версия: check_transcription.py, filter_errors.py

---

*Сжато: 2026-01-29. Полная версия в архиве.*
