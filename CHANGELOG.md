# Changelog

> Полная детальная история: `Документация/Архив/CHANGELOG_FULL.md`

## [13.0.1] - 2026-01-31 — Текущая версия ✅

**Перефильтрация + Унификация форматов + Golden тест: 127/127 (100%)**

| Метрика | v12.3.0 | v13.0.1 | Δ |
|---------|---------|---------|---|
| Глава 1 | 87 | **83** | -4 |
| Глава 2 | 79 | **68** | -11 |
| Глава 3 | 111 | **104** | -7 |
| Глава 4 | 58 | **54** | -4 |
| Глава 5 | 119 | **115** | -4 |
| **ИТОГО** | 454 | **424** | **-30** |
| **FP** | 327 | **297** | **-30** |
| Golden | 127/127 | **127/127** ✓ | — |

### Ключевые изменения:

**1. Перефильтрация всех глав:**
- Обнаружено: filtered файлы использовали engine v9.4.1, а не v9.6.0
- Перезапущена фильтрация с актуальной версией engine
- Реальное улучшение: **-30 FP** (было 327, стало 297)

**2. Унификация форматов ошибок:**
- Создан `unify_formats.py` v1.0 — единый формат ошибок
- Golden файлы теперь содержат оба формата: `wrong/correct` И `transcript/original`
- `test_golden_standard.py` v6.5 — использует унифицированные геттеры

**3. Статистика компонентов фильтрации:**
| Компонент | Отфильтровано |
|-----------|---------------|
| yandex_typical | 181 |
| alignment_artifact | 180 |
| yandex_name_error | 133 |
| morpho_same_form | 81 |
| ML Classifier | 27 |
| Context Verifier | 4 |
| **ВСЕГО** | **1001** |

**4. Исправление документации:**
- Предыдущие отчёты завышали эффект context_verifier (заявлено 43, реально 4)
- Теперь метрики основаны на реальных прогонах

---

## [13.0.0] - 2026-01-30

**Аудит engine.py + Golden тест: 127/127 (100%)**

### Ключевые изменения:

**1. `engine.py` v9.6.0 — Исправления:**
- **FIX**: Логическая ошибка `check_alignment_artifact`
- **FIX**: Дублирование `merged_from_ins_del`
- **FIX**: Word boundaries в `compound_particle`
- **NEW**: `phonetic_morphoform_protected`

**2. `context_verifier.py` v4.1.0:**
- **FIX**: `anchor_verification` проверяет позицию (MAX_DISTANCE=2)

*Примечание: файлы не были перефильтрованы, эффект применён в v13.0.1*

---

## [12.6.0] - 2026-01-30

**Context Verifier Level 1-4 + Golden тест: 127/127 (100%)**

| Метрика | До (v12.5.0) | После |
|---------|--------------|-------|
| Golden ВСЕГО | 127/127 | **127/127** ✓ |
| Всего ошибок | 490 | **454** (-36) |
| FP | 363 | **327** (-36) |
| context_verifier.py | — | **v4.0.0** |

### Ключевые изменения:

**1. `context_verifier.py` v4.0 — 4 уровня контекстной верификации:**

| Уровень | Название | FP отфильтровано |
|---------|----------|------------------|
| Level 1 | Anchor Verification | 4 |
| Level 2 | Morpho Coherence | 3 |
| Level 3 | Semantic Coherence | 0 |
| Level 4 | Phonetic Morphoform | 33 |
| **ИТОГО** | | **40 FP** |

**2. Level 1 — Anchor Verification:**
- Проверяет артефакты склеенных/разбитых слов
- Пример: `split_word_artifact:и+рал=ирал`

**3. Level 2 — Morphological Coherence:**
- Проверяет согласование с контекстом по морфологии
- Использует pymorphy3 для анализа
- Защита: существительные с различием в числе/падеже НЕ фильтруются

**4. Level 3 — Semantic Coherence:**
- Проверяет семантическую связность с контекстом
- Использует Navec (500K слов) для вычисления сходства
- Пороги: diff>0.15, trans>0.25, orig<0.35
- Результат: 0 FP (блокируется semantic_slip на ранних уровнях)

**5. Level 4 — Phonetic Morphoform:**
- Фильтрует same_lemma + same_phonetic пары
- Примеры: одеяния→одеяние, внимания→внимание, зелья→зелье
- Защищённые пары (golden): сотни→сотня, формация→формации, простейшее→простейшие

**6. Интеграция в `engine.py` v9.5:**
- Защита merged_from_ins_del — разные леммы = реальная ошибка
- Все 4 уровня вызываются для substitution ошибок

**Сравнение версий (5 глав):**

| Версия | Гл.1 | Гл.2 | Гл.3 | Гл.4 | Гл.5 | ИТОГО | FP |
|--------|------|------|------|------|------|-------|-----|
| v12.5.0 (до cv) | 96 | 83 | 119 | 62 | 130 | 490 | 363 |
| **v12.6.0** | **87** | **79** | **111** | **58** | **119** | **454** | **327** |

---

## [12.5.0] - 2026-01-30

**Рефакторинг костыля + Golden тест: 127/127 (100%)**

| Метрика | До (v12.4.0) | После |
|---------|--------------|-------|
| Golden ВСЕГО | 127/127 | **127/127** ✓ |
| engine.py | 9.2.3 | **9.3.2** |
| Костылей | 1 | **0** |

### Ключевые изменения:

**1. `engine.py` v9.3.2 — Рефакторинг костыля "как то ... там":**
- Было: `if prefix.startswith('как') and next_word == 'там'` (только для "как")
- Стало: `if next_word == 'там'` (для всех prefix-ов)
- Обобщено: "что то там", "где то там", "когда то там" теперь тоже фильтруются
- Это разбитые Яндексом устойчивые выражения "как-то там", "что-то там" и т.д.

**2. Аудит костылей в фильтрах:**
- Проанализированы engine.py, constants.py, morpho_rules.py, scoring_engine.py
- HARD_NEGATIVES очищен — только 1 пара (имя персонажа)
- YANDEX_TYPICAL_ERRORS — golden пары были убраны ранее
- Костыль `{'или'}` в yandex_expand_artifact — задокументирован (защита golden)

---

## [12.4.0] - 2026-01-30

**Golden тест: 127/127 (100%) — все главы пройдены!**

| Метрика | До (v12.3.0) | После |
|---------|--------------|-------|
| Golden Гл.1-4 | 93/93 | **93/93** ✓ |
| Golden Гл.5 | 33/34 | **34/34** ✓ |
| Golden ВСЕГО | 126/127 | **127/127** ✓ |
| Ошибок Гл.5 | 118 | **142** |

### Ключевые изменения:

**1. `smart_compare.py` v10.6 — `smart_replace_match()`:**
- Проблема: "рутгош"→"лет" (substitution) вместо "лет" (insertion)
- Причина: SequenceMatcher создаёт replace блок, индексное сопоставление
- Исправление: новая функция `smart_replace_match()` использует схожесть
- Алгоритм: матрица схожести + жадный выбор оптимальных пар
- Результат: "лет" теперь правильно определяется как insertion

**2. `engine.py` v9.2.3 — Защита ML от грамматических вариаций:**
- Проблема: "тюрьмы"→"тюрьма" фильтровалось ML (0.90 confidence)
- Причина: pymorphy определяет "тюрьмы" как sing,gent (омонимия)
- Исправление: если одинаковая лемма, но слова разные — не применяем ML
- Логика: грамматическая вариация = потенциальная ошибка чтеца

---

## [12.3.0] - 2026-01-30

**Golden тест Главы 5: 33/34 (97%) + 6 исправлений фильтрации**

| Метрика | До (v12.2.0) | После |
|---------|--------------|-------|
| Golden Гл.1-4 | 93/93 | **93/93** ✓ |
| Golden Гл.5 | — | **33/34** (97%) |
| Golden ВСЕГО | 93/93 | **126/127** (99.2%) |
| Ошибок Гл.5 | 81 | **118** |

### Исправления фильтрации (6 модулей):

**1. `smart_compare.py` v10.5 — `is_alignment_artifact()`:**
- Проблема: "как" → "какой" помечалось как `is_yandex_error=true`
- Исправление: если леммы **разные**, возвращаем `False` (не артефакт)

**2. `comparison.py` v6.2 — `is_short_full_adjective_match()`:**
- Проблема: "непрозрачно" → "непрозрачная" фильтровалось
- Исправление: добавлена проверка рода — если род разный, не фильтруем

**3. `rules/alignment.py` v1.1 — `check_safe_ending_transition()`:**
- Проблема: "тюрьма" → "тюрьмы" фильтровалось
- Исправление: добавлена проверка падежа — если падеж разный, не фильтруем

**4. `morpho_rules.py` v1.2 — `proper_name` фильтр:**
- Проблема: "Рутгош" → "лет" фильтровалось как ошибка имени
- Исправление: добавлена проверка схожести (≥50%)

**5. `rules/alignment.py` v1.2 — `check_alignment_artifact_substring()`:**
- Проблема: "поправился" → "поправил" фильтровалось
- Исправление: если леммы **разные**, не фильтруем (разные слова)

**6. `engine.py` v9.2.2 — ML-классификатор защита:**
- Проблема: "идущими" → "идущим" фильтровалось ML
- Исправление: если одинаковая лемма, но разное число — не применяем ML

---

## [12.2.0] - 2026-01-30

**Глава 5 + стабильный веб-просмотрщик Flask + исправление контекста**

| Метрика | До (v12.1.0) | После |
|---------|--------------|-------|
| Глав обработано | 4 | **5** |
| web_viewer_flask.py | — | **v1.0** |
| smart_compare.py | 10.4.0 | **10.5.0** |
| viewer.html | — | исправлен |

### Ключевые изменения:

**1. Добавлена Глава 5:**
- ✅ Транскрибация через Яндекс SpeechKit (7715 слов)
- ✅ Сравнение и фильтрация (81 ошибка чтеца)
- ✅ Результаты: `Результаты проверки/05/`

**2. Новый веб-просмотрщик `web_viewer_flask.py` v1.0:**
- ✅ Решена проблема зависания плеера при паузе/перемотке
- ✅ Flask с правильной обработкой Range-запросов
- ✅ `direct_passthrough=True` — данные без буферизации
- ✅ Многопоточность (`threaded=True`)
- ✅ Упрощённый запуск: `python web_viewer_flask.py 05`

**3. Исправлено дублирование слов в контексте (`smart_compare.py`):**
- ✅ Функция `dedupe_original_texts()` убирает последовательные дубликаты
- ✅ Когда несколько норм. слов ссылаются на один `original_text` — берём один раз
- ✅ Пример: "с-с-старейшина?" больше не дублируется 3 раза

**4. Исправлен viewer.html:**
- ✅ Поддержка форматов `wrong/correct` и `transcript/original`
- ✅ Исправлен вывод `undefined → undefined`

**Причина проблемы старого web_viewer.py:**
- Python HTTPServer блокировался при BrokenPipe
- Буферизация аудио вызывала deadlock в потоках
- Flask с `direct_passthrough` решает проблему

---

## [12.1.0] - 2026-01-30

**Глубокий аудит фильтров + эксперименты + анализ и/а/я**

| Метрика | До (v12.0.0) | После |
|---------|--------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Всего ошибок | 246 | **266** |
| engine.py | 9.2.0 | **9.2.1** |
| FP | 153 | **173** |

### Ключевые изменения:

**1. Фреймворк анализа фильтров:**
- ✅ Создан `Тесты/filter_analysis.py` v1.0
- ✅ Проанализировано 11 транскрипций
- ✅ Построена матрица эффективности всех фильтров
- ✅ Отчёт: `Тесты/Анализ_фильтров/ANALYSIS_REPORT.md`

**2. Эксперименты с ML и порядком фильтров:**
- ✅ Создан `Тесты/experiment_filters.py` v1.0
- ✅ Эксперимент ML 85%: **ПРОВАЛ**
  - Потеряна golden `услышав → услышал` (86.1%)
  - Порог оставлен 90%
- ✅ Эксперимент порядка: изменения **НЕ НУЖНЫ**
- ✅ Отчёт: `Тесты/Эксперименты/EXPERIMENTS_REPORT.md`

**3. Анализ вредных/бесполезных фильтров:**
- ✅ Вредных: **0** (ни один не фильтрует golden)
- ✅ Бесполезных: **0** (все имеют срабатывания)
- ⚠️ Костылей: **1** (`как то ... там` слишком специфичен)

**4. Анализ гипотезы "Акустический аудит":**
- ✅ Проверена гипотеза использования таймкодов/confidence
- ✅ Результат: **НЕ подтвердилась**
  - Confidence = 1.0 для всех слов — не информативен
  - Фильтрация по паузе потеряла бы 4 golden (insertions)
- ✅ Отчёт: `Документация/ACOUSTIC_AUDIT_ANALYSIS.md`

**Технические детали:**
- `engine.py` v9.2.1 — документация эксперимента ML 85%
- ТОП-3 фильтра: yandex_typical (730), alignment_artifact (562), yandex_name_error (459)
- Новые отчёты и инструменты анализа

---

## [12.0.0] - 2026-01-30

**ML-классификатор включен + синхронизация БД**

| Метрика | До (v11.9.0) | После |
|---------|--------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Всего ошибок | 247 | **246** |
| ML отфильтровал | 0 | **26** |
| SemanticManager защитил | ~57 | **77** |
| FP | 154 | **153** |

### Ключевые изменения:

**1. Синхронизация БД с Golden файлами:**
- ✅ Исправлено: `эли→или` (опечатка при вводе)
- ✅ Исправлено: `еще→ещё` (буква ё)
- ✅ Добавлена недостающая запись: `и→я` (Гл.3, 29:00)
- БД: **93 golden записей** = 88 уникальных пар

**2. ML-классификатор v1.1 включен (уровень 10):**
- ✅ Переобучен на исправленных данных (93 golden + 648 FP)
- ✅ CV accuracy: 90.07%
- ✅ Порог: 90% — консервативный
- ✅ Отфильтровал **26 FP** без потери golden
- Reason: `ml_classifier(0.90)` — `ml_classifier(0.98)`

**3. SemanticManager активен (защитный слой):**
- Защитил **77 ошибок** от ложной фильтрации
- Высокая семантика + разные леммы = оговорка чтеца = НЕ фильтруем
- Reason: `PROTECTED_semantic_slip(0.XX)`

**4. Тестирование критичных пар:**
```
'или' → 'и'    : REAL (59%) ✓ — не фильтруется
'и'   → 'я'    : REAL (82%) ✓ — не фильтруется
```

**Технические детали:**
- `engine.py` v9.2.0 — ML включен, SmartFilter отключен (консервативно)
- `false_positives.db` — синхронизирована с golden файлами
- `fp_classifier.pkl` — переобучен 2026-01-30

---

## [11.9.0] - 2026-01-30

**Интеграция ML-классификатора и SmartFilter как полноценных инструментов фильтрации**

| Метрика | До (v11.8.0) | После |
|---------|--------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| engine.py | 9.1.0 | **9.2.0** |
| Уровней фильтрации | 25+ | **27+** (+ML +SmartFilter) |

### Ключевые изменения:

**Интеграция ML-классификатора (уровень 10):**
- ✅ RandomForest модель на 22 признаках интегрирована в `engine.py`
- ✅ Порог консервативный: 90% уверенности для фильтрации
- ✅ Reason: `ml_classifier(0.95)`

**Интеграция SmartFilter (уровень 11):**
- ✅ `smart_filter.py` интегрирован как финальный уровень фильтрации
- ✅ Использует накопительный скоринг (частотность + семантика + sliding window)
- ✅ Reason: `smart_filter(score=-40)`

**Технические детали:**
- `engine.py` v9.2.0 — добавлены уровни 10 (ML) и 11 (SmartFilter)
- Импорты обёрнуты в try/except для graceful degradation
- scikit-learn установлен в venv проекта

---

## [11.8.0] - 2026-01-30

**Глубокий аудит и оптимизация архитектуры**

| Метрика | До (v11.7.2) | После |
|---------|--------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| filters/__init__.py | 8.1.0 | **8.2.0** |
| Unit-тесты rules/ | 0 | **21** |

### Выполненные работы:

**Фаза 1: Унификация (1.1-1.5)**
- ✅ Унификация `levenshtein_distance` в `populate_db.py` и `ml_classifier.py`
- ✅ Исправлен `phonetic_normalize` fallback в `ml_classifier.py`
- ✅ Обновлена документация `filters/__init__.py` v8.2

**Фаза 2: Архитектурная чистка (2.1-2.4)**
- ✅ Создан `deprecated_filters.py` — архив отключённых фильтров
- ✅ `SKIP_SPLIT_FRAGMENT` перемещён в `constants.py`
- ✅ Документирован статус Smart модулей (аналитика, не фильтрация)
- ✅ Проверено кэширование морфологии (morphology.py — единый источник)

**Фаза 3: Анализ и тестирование (3.1-3.4)**
- ✅ Анализ 145 FP — выявлены паттерны grammar_ending
- ⚠️ Фильтры grammar_ending отложены — риск регрессии на golden
- ✅ `ml_classifier.py` — документирован как опциональный инструмент
- ✅ Unit-тесты для `rules/` модулей (21 тест, все проходят)

**Новые файлы:**
- `filters/deprecated_filters.py` v1.0 — архив отключённых фильтров
- `Тесты/test_rules.py` v1.0 — unit-тесты для rules/

---

## [11.7.2] - 2026-01-30

**Удалён deprecated smart_rules.py (36KB → 0)**

| Метрика | До (v11.7.1) | После |
|---------|--------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Python файлов | 59 | **58** (-1) |
| filters/__init__.py | 8.0.0 | **8.1.0** |

### Ключевые изменения:

**Полная миграция завершена:**
- ❌ `smart_rules.py` — УДАЛЁН (36KB deprecated кода)
- ✅ Удалены импорты из `smart_compare.py`
- ✅ Удалены экспорты из `filters/__init__.py`
- Фильтрация полностью в `engine.py` + `rules/`

---

## [11.7.1] - 2026-01-30

**Миграция: Inline-код engine.py → rules/ модули**

| Метрика | До (v11.7.0) | После |
|---------|--------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Всего ошибок | 247 | **247** |
| engine.py | 9.0.0 | **9.1.0** |

### Ключевые изменения:

**engine.py v9.1 — Миграция завершена:**
- ✅ `SAFE_ENDING_TRANSITIONS` → `rules.check_safe_ending_transition()`
- ✅ `YANDEX_PHONETIC_PAIRS` → `rules.check_yandex_phonetic_pair()`
- ✅ `alignment_artifact` → `rules.check_alignment_artifact()`
- ✅ `SINGLE_CONSONANT_ARTIFACTS` → `rules.check_single_consonant_artifact()`
- ✅ `i_ya_confusion` → `rules.check_i_ya_confusion()`
- Inline-константы удалены, логика вынесена в модули

---

## [11.7.0] - 2026-01-30

**Рефакторинг: Модульная архитектура фильтрации**

| Метрика | До (v11.6) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Всего ошибок | 247 | **247** |
| Python файлов | 57 | **59** (+2 в rules/) |
| FP | 154 | **154** |

### Ключевые изменения:

**1. Новый пакет `filters/rules/` v1.0:**
- `__init__.py` — публичные экспорты
- `protection.py` — защитные слои (HARD_NEGATIVES, semantic_slip)
- `phonetics.py` — фонетические пары Яндекса (не/ни, ну/но, и/я)
- `alignment.py` — артефакты выравнивания (длина, подстрока, окончания)

**2. engine.py v9.0 — оркестратор:**
- Импорты из rules/ добавлены (HAS_RULES_MODULE)
- Подготовка к постепенной миграции inline-кода
- Обратная совместимость сохранена

**3. Удалён deprecated код:**
- ❌ `learned_rules.py` — удалён (не использовался)
- ❌ `smart_rules.py` — удалён в v11.7.2

**4. Консолидация phonetic_normalize:**
- Единая реализация в `comparison.py` v6.1
- Удалены дубликаты из `morpho_rules.py` и `smart_rules.py`
- Обновлены импорты в `smart_compare.py`, `ml_classifier.py`

**5. Явный публичный API:**
- Добавлен `__all__` в `filters/__init__.py` v8.0
- 27 публичных функций/классов чётко определены
- Остальное — внутреннее API

**6. Единый источник версий:**
- Новый файл `version.py` v1.0 — все версии в одном месте
- Функции: `get_version_string()`, `get_version_info()`
- Валидация совместимости версий

**7. Обновлена документация:**
- CLAUDE.md v3.0 — актуальная архитектура
- PROJECT.md v11.7 — обновлённые модули
- ROADMAP.md v11.7 — выполненные задачи

---

## [11.6.0] - 2026-01-30

**Унификация системы версий и метрик**

| Метрика | До (v11.5) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Всего ошибок | 247 | **247** |
| FP | 154 | **154** |
| Строк кода | ~28,000 | **~29,000** |

### Ключевые изменения:

**1. Унифицированная система версий:**
- **versions.json** — единый источник правды для всех метрик
- **version_table.py** v1.0 — CLI для быстрых таблиц сравнения
- Команды: `python Инструменты/version_table.py v5.7 v11.5`

**2. run_full_test.py v6.3:**
- Автоматическая запись в versions.json при успешном полном тесте
- Функция update_versions_json() для обновления метрик
- Интеграция с version_table.py

**3. Аудит и очистка:**
- Устранён хаос с тремя понятиями "версия" (filter/project/test)
- Единый формат хранения исторических данных
- Быстрый доступ к сравнению версий без парсинга комментариев

**4. Статистика проекта:**
- 57 Python файлов
- ~29,000 строк кода
- Топ файлов: smart_compare.py (1889), false_positives_db.py (1576), engine.py (1097)

---

## [11.5.0] - 2026-01-30

**engine.py v8.9 — Интеграция SemanticManager и SmartScorer**

| Метрика | До (v11.4) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Отфильтровано | 715 | **715** (без изменений) |
| Осталось FP | 135 | **135** (без изменений) |

### Ключевые изменения:

**1. engine.py v8.9 — интеграция модулей:**
- **SemanticManager** интегрирован как ЗАЩИТНЫЙ слой
  - Высокая семантика (>0.4) + разные леммы = оговорка чтеца = НЕ фильтруем
  - Использует Navec (500K слов, 300d) для семантической близости
  - Защищает golden от ложной фильтрации
- **SmartScorer** интегрирован для расчёта метрик
  - Добавляет `smart_metrics` к каждой ошибке
  - Включает: score, applied_rules, semantic_similarity
  - НЕ используется для автоматической фильтрации (только метрики)

**2. Калибровка на данных БД (941 ошибка):**
- Анализ: same_lemma=1 + semantic>0.5 = 14 golden, 138 FP (небезопасно!)
- Анализ: diff_lemma + semantic<0.2 = 7 golden, 220 FP (тоже небезопасно!)
- Решение: консервативный подход — модули добавляют метрики, не фильтрацию

**3. Новые метрики в ошибках:**
```json
{
  "smart_metrics": {
    "smart_score": 100,
    "smart_rules": ["grammar_change (+70)", "semantic_slip (+30)"],
    "is_visible": true,
    "semantic_similarity": 0.616
  }
}
```

---

## [11.4.0] - 2026-01-30

**engine.py v8.8 — Новые фильтры артефактов + расширение safe_ending_transition**

| Метрика | До (v11.3) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Отфильтровано | 700 | **715** (+15) |
| Осталось FP | 149 | **135** (-14) |

### Ключевые изменения:

**1. engine.py v8.8 — новые фильтры:**
- `misrecognition_artifact`: вставленное слово похоже на слово в контексте
  - "блядочное"~"ублюдочные", "оголим"~"големах", "смертник"~"пересмешник"
  - Использует SequenceMatcher (порог 0.6), **отфильтровано 8 FP**
- `unknown_word_artifact`: вставка неизвестного слова (UNKN в pymorphy)
  - Пример: "бла" (обрыв "глава")
  - **Отфильтровано 1 FP**

**2. Расширение safe_ending_transition (+4 паттерна, +10 FP):**
- ('ья', 'ье'), ('ье', 'ья') — зелья↔зелье
- ('ей', 'ли') — мыслей↔мысли
- ('ью', 'ти') — костью↔кости

**3. constants.py — новые безопасные пары diff_lemma (+6 FP):**
- средина↔середина, уж↔уже, вбивают↔выбивают
- ускользнуть↔скользнуть, проводить↔проходить, идти↔прийти

**4. Статистика фильтров (топ-10):**
- yandex_typical: 199 (+5)
- alignment_artifact: 141
- yandex_name_error: 102
- safe_ending_transition: 79 (+10)
- single_consonant_artifact: 34
- linked_prefix_error: 26
- morpho_proper_name: 21
- interjection: 18
- homophone: 16
- misrecognition_artifact: 8 (new)

---

## [11.3.0] - 2026-01-30

**Унификация БД и filtered.json + single_consonant_artifact**

| Метрика | До (v11.2) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| Отфильтровано | 446 | **694** |
| Осталось FP (в БД) | 403 | **155** |
| Не отфильтровано | 260 | **247** (= 92 golden + 155 FP) |

### Ключевые изменения:

**1. engine.py v8.7:**
- Новый фильтр `single_consonant_artifact` для однобуквенных согласных (с, в, м, п, к, ф, х, э)
- Безопасно: проверено на БД — 0 golden среди этих букв

**2. populate_db.py — КРИТИЧЕСКОЕ исправление:**
- БД теперь использует **ту же логику** что и filter_errors()
- Раньше: БД использовала should_filter_error напрямую (пропускала linked_prefix_error, alignment_chain)
- Сейчас: БД прогоняет данные через filter_errors() и читает filter_reason
- **Гарантирована консистентность**: filtered.json (247) = БД не отфильтровано (247)

**3. Статистика фильтров (топ-10):**
- yandex_typical: 194
- alignment_artifact: 141
- yandex_name_error: 102
- safe_ending_transition: 69
- single_consonant_artifact: 34
- linked_prefix_error: 26
- morpho_proper_name: 21
- interjection: 18
- homophone: 16
- alignment_artifact_substring: 14

---

## [11.2.0] - 2026-01-30

**Унификация Golden стандарта + БД ошибок с метриками**

| Метрика | До | После |
|---------|-----|-------|
| Golden в файлах | 93 | **92** |
| Golden в БД | 91 (разночтения) | **92** (точное соответствие) |
| Всего ошибок в БД | — | 941 |
| Отфильтровано | — | 437 |
| Осталось FP | 260 | **412** (полная БД) |

### Ключевые изменения:

**1. Унификация Golden стандарта:**
- Golden файлы переписаны с точными парами слов из compared.json
- Сопоставление по 4 параметрам: chapter + correct + wrong + time (±3 сек)
- 1 ошибка исключена (transposition `я и → и я` — другой тип в compared)
- Старые файлы сохранены как `*_old.json`

**2. База данных ошибок (populate_db.py):**
- SQLite БД со всеми 941 ошибками из 4 глав
- Метрики: лемма, POS, same_lemma, same_pos
- Семантика: semantic_similarity (Navec 500K слов)
- Частотность: frequency_wrong/correct (НКРЯ 103K слов)
- Фонетика: phonetic_similarity, levenshtein
- Статус: is_golden, is_filtered, filter_reason

**3. Новые файлы:**
- `Инструменты/populate_db.py` — заполнение БД с метриками
- `Словари/false_positives.db` — SQLite база ошибок
- `Тесты/золотой_стандарт_глава*_old.json` — бэкап старых golden

---

## [11.1.2] - 2026-01-30

**Исправление Golden 30:38** — ошибка `или→и` восстановлена.

| Метрика | До (v11.1.1) | После |
|---------|--------------|-------|
| Golden | 92/93 | **93/93** ✓ |
| FP | 259 | 260 (+1) |

Корневая причина: Яндекс распознал "или" как "эли", smart_compare обнаружил `эли→и`,
но пара была ошибочно добавлена в YANDEX_TYPICAL_ERRORS и фильтровалась.

Изменения:
- `constants.py` — удалена пара `('эли', 'и')` (это реальная ошибка чтеца)

---

## [11.1.1] - 2026-01-30

**Улучшение фильтрации по леммам** — is_yandex_typical_error теперь проверяет леммы.

| Метрика | До (v11.1.0) | После |
|---------|--------------|-------|
| Golden | 93/93 | 93/93 |
| FP | 268 | **259** ↓9 |

Изменения:
- `comparison.py` v6.0.1 — `is_yandex_typical_error` проверяет леммы для слов ≥5 символов
- `engine.py` v8.6.1 — исключение `или` из `yandex_expand_artifact`
- `constants.py` — новые пары: мурлан/морлан, рагидон/рагедон, клик/крик и др.

---

## [11.1.0] - 2026-01-30

**SmartFilter v3.0** — исправленная логика весов.

| Метрика | До (v10.7) | После |
|---------|------------|-------|
| Golden | 93/93 | **93/93** ✓ |
| FP | 262 | 268 (+6) |

КЛЮЧЕВОЕ ИЗМЕНЕНИЕ:
- Одинаковая лемма НЕ означает FP!
- Грамматические различия (число, падеж, вид, POS) = РЕАЛЬНАЯ ошибка

Новые модули:
- `smart_scorer.py` v3.0 — накопительный скоринг с `grammar_change` (+70)
- `smart_filter.py` v3.0 — детекция грамм. различий + pymorphy3
- `frequency_manager.py` v1.0 — частотный словарь НКРЯ
- `sliding_window.py` v1.0 — фонетическое сравнение

Исправления:
- Убраны ошибочные штрафы: `same_lemma`, `phonetic_similar_weak`
- Добавлена детекция приставки "по-" (побольше→больше)

---

## [10.7.0] - 2026-01-29

**safe_ending_transition** — новый фильтр на основе анализа БД.

| Метрика | До | После |
|---------|-----|-------|
| Golden | 93/93 | 93/93 ✓ |
| FP | 324 | **262** |
| FP Recall | 64.1% | **72.3%** |

Изменения:
- `engine.py` v8.6.0 — фильтр безопасных переходов окончаний
- `false_positives_db.py` v3.1 — исправлен mark_golden()

---

## [10.5.0] - 2026-01-29

**Унификация версионирования** — метаданные версий в JSON.

- Метаданные в compared.json: `created_at`, `smart_compare_version`
- Валидация версий в engine.py
- Флаг `--clean` в run_full_test.py
- FP: 328 → 309

---

## [10.0.0] - 2026-01-29

**Посегментное выравнивание** — полный переход от полнотекстового сравнения.

- `compare_with_anchors()` — сравнение с якорями
- `refine_large_segments()` — суб-якоря для сегментов >100 слов
- AlignmentManager v1.2 — фильтр монотонности

---

## [9.0.0] - 2026-01-29

**Модульная архитектура** — 6 независимых модулей.

Модули:
- AlignmentManager — макро-выравнивание
- WindowVerifier — контекстная верификация
- ScoringEngine — адаптивные штрафы
- ComparisonStitcher — склейка слов
- MorphoRules — морфологические правила
- CharacterGuard — защита имён

---

## [8.0.0] - 2026-01-26

**Консервативная фильтрация** — при сомнении НЕ фильтруем.

- morpho_rules.py — единый морфологический модуль
- 20+ уровней фильтрации в engine.py
- Golden 94/94 (100%)

---

## [5.7.0] - 2026-01-25 — Лучший исторический FP

| Глава | Golden | FP |
|-------|--------|-----|
| 1 | 31/31 | 62 |
| 2 | 21/21 | 42 |
| 3 | 20/20 | 79 |
| **Итого** | **72/72** | **183** |

---

## [5.0.0] - 2026-01-25

**Стабильная версия** — конфигурация и пайплайн.

- config.py v5.0.0 — централизованная конфигурация
- pipeline.py v5.0.0 — полный пайплайн
- Golden 72/72

---

## [2.0.0] - 2026-01-23

**Восстановление проекта** — после случайного удаления.

Модули:
- pipeline.py, smart_compare.py, golden_filter.py
- text_normalizer.py, transcribe.py
- Тесты/золотой_стандарт_глава1.json

---

## [1.0.0] - До 2026-01-23

Исходная версия: check_transcription.py, filter_errors.py

---

*Сжато: 2026-01-29. Полная версия в архиве.*
